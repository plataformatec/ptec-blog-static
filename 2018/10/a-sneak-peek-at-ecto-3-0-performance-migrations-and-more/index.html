<!DOCTYPE html>
<html dir="ltr" lang="en-US" prefix="og: https://ogp.me/ns#">
<head>
  <meta charset="utf-8">
  <meta name="bitly-verification" content="b3acd9a47f4e">

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="emoji:root" content="/wp-content/themes/ptec">
  <meta name="theme-color" content="#cacaca">
  
    <meta name="bitly-verification" content="b3acd9a47f4e">
  <meta property="og:image" content="/wp-content/themes/ptec/assets/opengraph.png">
  <link rel="icon" sizes="192x192" href="/wp-content/themes/ptec/assets/icons/chrome-192x.png">
  <link rel="pingback" href="/xmlrpc.php">
  
		<!-- All in One SEO 4.5.4 - aioseo.com -->
		<title>A sneak peek at Ecto 3.0: performance, migrations and more « Plataformatec Blog</title>
		<meta name="description" content="Welcome to the &quot;A sneak peek at Ecto 3.0&quot; series: Breaking changes Query improvements part 1 Query improvements part 2 Performance, migrations and more (you are here!) We are back for one last round! This time we are going to cover improvements on three main areas: performance, upserts and migrations. If you would like to">
		<meta name="robots" content="max-image-preview:large">
		<link rel="canonical" href="/2018/10/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more/">
		<meta name="generator" content="All in One SEO (AIOSEO) 4.5.4">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="Plataformatec Blog | Plataformatec&#039;s place to talk about Ruby, Ruby on Rails, Elixir, and software engineering">
		<meta property="og:type" content="article">
		<meta property="og:title" content="A sneak peek at Ecto 3.0: performance, migrations and more « Plataformatec Blog">
		<meta property="og:description" content="Welcome to the &quot;A sneak peek at Ecto 3.0&quot; series: Breaking changes Query improvements part 1 Query improvements part 2 Performance, migrations and more (you are here!) We are back for one last round! This time we are going to cover improvements on three main areas: performance, upserts and migrations. If you would like to">
		<meta property="og:url" content="/2018/10/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more/">
		<meta property="article:published_time" content="2018-10-22T17:41:40+00:00">
		<meta property="article:modified_time" content="2018-10-22T19:14:06+00:00">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="A sneak peek at Ecto 3.0: performance, migrations and more « Plataformatec Blog">
		<meta name="twitter:description" content="Welcome to the &quot;A sneak peek at Ecto 3.0&quot; series: Breaking changes Query improvements part 1 Query improvements part 2 Performance, migrations and more (you are here!) We are back for one last round! This time we are going to cover improvements on three main areas: performance, upserts and migrations. If you would like to">
		<meta name="google" content="nositelinkssearchbox">
		<script type="application/ld+json" class="aioseo-schema">{"@context":"https:\/\/schema.org","@graph":[{"@type":"Article","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#article","name":"A sneak peek at Ecto 3.0: performance, migrations and more « Plataformatec Blog","headline":"A sneak peek at Ecto 3.0: performance, migrations and more","author":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author"},"publisher":{"@id":"http:\/\/blog.plataformatec.com.br\/#organization"},"image":{"@type":"ImageObject","url":"http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2018\/10\/memory.png","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#articleImage","width":1226,"height":412},"datePublished":"2018-10-22T15:41:40-03:00","dateModified":"2018-10-22T17:14:06-03:00","inLanguage":"en-US","mainEntityOfPage":{"@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#webpage"},"isPartOf":{"@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#webpage"},"articleSection":"English, ecto, elixir"},{"@type":"BreadcrumbList","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#breadcrumblist","itemListElement":[{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/#listItem","position":1,"name":"Home","item":"http:\/\/blog.plataformatec.com.br\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2018\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2018\/#listItem","position":2,"name":"2018","item":"http:\/\/blog.plataformatec.com.br\/2018\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2018\/10\/#listItem","previousItem":"http:\/\/blog.plataformatec.com.br\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/#listItem","position":3,"name":"October","item":"http:\/\/blog.plataformatec.com.br\/2018\/10\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#listItem","previousItem":"http:\/\/blog.plataformatec.com.br\/2018\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#listItem","position":4,"name":"A sneak peek at Ecto 3.0: performance, migrations and more","previousItem":"http:\/\/blog.plataformatec.com.br\/2018\/10\/#listItem"}]},{"@type":"Organization","@id":"http:\/\/blog.plataformatec.com.br\/#organization","name":"Plataformatec Blog","url":"http:\/\/blog.plataformatec.com.br\/"},{"@type":"Person","@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author","url":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/","name":"José Valim","image":{"@type":"ImageObject","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#authorImage","url":"http:\/\/2.gravatar.com\/avatar\/e837f6b7fd146ab16ed3d663476c063e?s=96&d=mm&r=pg","width":96,"height":96,"caption":"José Valim"}},{"@type":"WebPage","@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#webpage","url":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/","name":"A sneak peek at Ecto 3.0: performance, migrations and more « Plataformatec Blog","description":"Welcome to the \"A sneak peek at Ecto 3.0\" series: Breaking changes Query improvements part 1 Query improvements part 2 Performance, migrations and more (you are here!) We are back for one last round! This time we are going to cover improvements on three main areas: performance, upserts and migrations. If you would like to","inLanguage":"en-US","isPartOf":{"@id":"http:\/\/blog.plataformatec.com.br\/#website"},"breadcrumb":{"@id":"http:\/\/blog.plataformatec.com.br\/2018\/10\/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more\/#breadcrumblist"},"author":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author"},"creator":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author"},"datePublished":"2018-10-22T15:41:40-03:00","dateModified":"2018-10-22T17:14:06-03:00"},{"@type":"WebSite","@id":"http:\/\/blog.plataformatec.com.br\/#website","url":"http:\/\/blog.plataformatec.com.br\/","name":"Plataformatec Blog","description":"Plataformatec's place to talk about Ruby, Ruby on Rails, Elixir, and software engineering","inLanguage":"en-US","publisher":{"@id":"http:\/\/blog.plataformatec.com.br\/#organization"}}]}</script>
		<!-- All in One SEO -->


		<!-- Meta Tag Manager -->
		<meta name="twitter:label1" content="Plataformatec">
		<meta name="twitter:data1" content="Professional Consulting and Development for companies using Elixir or Ruby">
		<!-- / Meta Tag Manager -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Comments Feed" href="/comments/feed/">
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/blog.plataformatec.com.br\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.4.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"🏳️‍⚧️","🏳️​⚧️")?!1:!n(e,"🇺🇳","🇺​🇳")&&!n(e,"🏴󠁧󠁢󠁥󠁮󠁧󠁿","🏴​󠁧​󠁢​󠁥​󠁮​󠁧​󠁿");case"emoji":return!n(e,"🫱🏻‍🫲🏿","🫱🏻​🫲🏿")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.4.2" type="text/css" media="all">
<style id="wp-block-library-inline-css" type="text/css">.has-text-align-justify{text-align:justify;}</style>
<link rel="stylesheet" id="mediaelement-css" href="/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.17" type="text/css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=6.4.2" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="webfont-css" href="//fonts.googleapis.com/css?family=Bree+Serif&#038;ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="main-css" href="/wp-content/themes/ptec/style.css?ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="tablepress-default-css" href="/wp-content/plugins/tablepress/css/build/default.css?ver=2.2.4" type="text/css" media="all">
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/7870">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.4.2">
<link rel="shortlink" href="/?p=7870">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2F2018%2F10%2Fa-sneak-peek-at-ecto-3-0-performance-migrations-and-more%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2F2018%2F10%2Fa-sneak-peek-at-ecto-3-0-performance-migrations-and-more%2F#038;format=xml">
                                          </head>
  <body class="post-template-default single single-post postid-7870 single-format-standard">
    <div class="site-header">
      <div class="site-header-background">
        <header class="site-header-container">
          <h1 class="site-header-logo">
            <a href="/">
              <img src="/wp-content/themes/ptec/assets/plataformatec.svg" height="70" alt="The plataformatec logo">
            </a>
          </h1>

          <form class="header-search-form" method="GET" action="/">
            <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
          </form>

          <ul class="site-nav">
            <li class="site-nav-item"><a href="http://plataformatec.com.br/services">Services</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/playbook">Playbook</a></li>
            <li class="site-nav-item handheld-hidden"><a href="http://plataformatec.com.br/forge">Forge</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/careers">Careers</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/contact">Contact</a></li>
          </ul>
        </header>
      </div>
      <nav class="header-nav">
        <input type="checkbox" id="nav-toggle-checkbox" class="header-nav-checkbox">
        <label for="nav-toggle-checkbox" class="header-nav-toggle">Topics we write about</label>

        <ul class="header-nav-list" itemscope itemtype="http://schema.org/SiteNavigationElement">
          <li class="header-nav-item header-search-nav-item">
            <form class="header-nav-search-form" method="GET" action="/">
              <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
            </form>
          </li>
                    <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/elixir" itemprop="url">Elixir</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/rails" itemprop="url">Ruby on Rails</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/devise" itemprop="url">Devise</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/simple_form" itemprop="url">Simple Form</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/agile" itemprop="url">Agile</a>
          </li>
        </ul>
      </nav>
    </div>
<div class="site-container">
  <div class="page-container">
                  <section class="post-section">
  <header class="post-header">
    <h1 class="post-title">
      <a href="/2018/10/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more/" rel="bookmark">A sneak peek at Ecto 3.0: performance, migrations and more</a>
    </h1>
          <time class="post-date-ribbon" datetime="2018-10-22T15:41:40-03:00">Oct 22, 2018</time>
      <p class="post-author">
        <img alt="" src="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">        Written by <a href="/?author=4" title="Posts by José Valim">José Valim</a>.
      </p>
        </header>

      <article class="post-body">
      <p>Welcome to the &#8220;A sneak peek at Ecto 3.0&#8221; series:</p>
<ol>
<li><a href="/2018/10/a-sneak-peek-at-ecto-3-0-breaking-changes/">Breaking changes</a></li>
<li><a href="/2018/10/a-sneak-peek-at-ecto-3-0-query-improvements-part-1/">Query improvements part 1</a></li>
<li><a href="/2018/10/a-sneak-peek-at-ecto-3-0-query-improvements-part-2/">Query improvements part 2</a></li>
<li>
<a href="/2018/10/a-sneak-peek-at-ecto-3-0-performance-migrations-and-more/">Performance, migrations and more</a> (you are here!)</li>
</ol>
<p>We are back for one last round! This time we are going to cover improvements on three main areas: performance, upserts and migrations. If you would like to give Ecto a try right now, note <a href="https://elixirforum.com/t/ecto-3-0-rc-is-out-and-stable-api/17306">Ecto v3.0.0-rc.0 has been released</a> and we are looking forward to your feedback.</p>
<h2>Better memory usage</h2>
<p>One of the most notable performance improvements in Ecto 3.0 is that schemas loaded from an Ecto repository now uses less memory.</p>
<p>A big part of the memory improvements seen in Ecto 3.0 comes from better management of schema metadata. Every instance you have of an <code>Ecto.Schema</code>, such as a <code>%User{}</code>, has a metadata field with life-cycle information about that entry, such as the database prefix or its state (was it just built or was it loaded from the database?). This metadata field takes exactly 16 words:</p>
<pre><code>iex&gt; :erts_debug.size %Ecto.Schema.Metadata{}
16
</code></pre>
<p>16 words for a 64-bits machine is equivalent to 128 bytes. This means that, if you were using Ecto 2.0 and you loaded 1000 entries, 128 kbytes of memory would be used only for storing this metadata. The good news is that all of those 1000 entries could use the exact same metadata! <a href="https://github.com/elixir-ecto/ecto/commit/c34046be0317903785d5f7f3ece35ac6e0f64008">That&#8217;s what we did in this commit</a>. This means that, if you load 1000 or 1000000 entries, the cost is always the same, only 128 bytes!</p>
<p>After we announced Ecto 3.0-rc, we started to hear some teams already upgraded to Ecto 3.0-rc. Some of those repos are quite big and it took them less than a day to upgrade, which is exactly how upgrading to major software versions should be.</p>
<p>Ben Wilson, Principal Engineer at CargoSense, upgraded one of their apps to Ecto 3.0-rc and pushed it to production. Here is the result:</p>
<p><img fetchpriority="high" decoding="async" class="aligncenter size-full wp-image-7872" src="/wp-content/uploads/2018/10/memory.png" alt="" width="1226" height="412" srcset="/wp-content/uploads/2018/10/memory.png 1226w, /wp-content/uploads/2018/10/memory-300x101.png 300w, /wp-content/uploads/2018/10/memory-768x258.png 768w, /wp-content/uploads/2018/10/memory-1024x344.png 1024w" sizes="(max-width: 1226px) 100vw, 1226px"></p>
<p>You can see the drop in memory usage from Ecto 2 to Ecto 3 at the moment of the deployment. This particular app loads a bunch of data during boot and we can clearly see the impact those improvements have in the memory usage. Once the system stabilized, the average memory use is 15% less altogether.</p>
<p>But that&#8217;s not all!</p>
<p>We also changed Ecto 3.0 to make use of the Erlang VM literal pool, which allows us to share the metadata across queries. For example, if you have two queries, each returning 1000 posts, all 2000 posts will point to the same metadata. These improvements alongside <a href="https://github.com/elixir-ecto/ecto/commit/415ba3df0b3810e5b3393d32a208745e28bd5c20">other changes to reduce struct allocation</a> should reduce Ecto&#8217;s memory usage as a whole.</p>
<h2>Statement cache for INSERT/UPDATE/DELETE</h2>
<p>Another notable performance improvement in Ecto 3.0 comes from the fact Ecto now automatically caches statements emitted by <code>Ecto.Repo.insert/update/delete</code>.</p>
<p>Consider this code:</p>
<pre><code>for i &lt;- 1..1000 do
  Repo.insert!(%Post{visits: i})
end
</code></pre>
<p>where Post is a schema with 13 fields. When running this code on my machine against a Postgres database with a pool of 10 connections, it takes 900ms to insert all 1000 posts. While Ecto has always cached select queries, once we also added the statement cache to <code>Ecto.Repo.insert/update/delete</code>, the total operation time is reduced 610ms!</p>
<p>But that&#8217;s not all!</p>
<p>Part of the issue here is that every time we call <code>Repo.insert!</code>, Ecto needs to get a new connection out of the connection pool, perform the insert, and give the connection back. For a pool with 10 connections, there is a chance the next connection we pick up is not &#8220;warm&#8221; and we may not hit the statement cache. While it is important to not hold connections for long, so we can best utilize the database resources, in this scenario we know we will perform many operations in a row.</p>
<p>For this reason, Ecto 3.0 includes a <code>Repo.checkout</code> operation, which allows you to tell the Ecto repository you want to use the same connection, skipping the connection pool and always using a &#8220;warm&#8221; connection:</p>
<pre><code>Repo.checkout(fn -&gt;
  for i &lt;- 1..1000 do
    Repo.insert!(%Post{visits: i})
  end
end)
</code></pre>
<p>With the change above, all of the inserts take 420ms on average.</p>
<p>There is one final trick we could use. Since we are performing multiple inserts, we could simply replace <code>Repo.checkout</code> by <code>Repo.transaction</code>. The transaction also checks out a single connection but it also allows the database itself to be more efficient. With this final change, the total time falls down to 320ms. And if you really need to go faster, you can always use <code>Ecto.Repo.insert_all</code>. Hooray!</p>
<h2>More options around upserts</h2>
<p>Ecto 2 added <a href="/2016/12/many-to-many-and-upserts/">support for upserts</a>. Ecto 3 brings many improvements to the upsert API, such as the ability to tell Ecto to <code>:replace_all_except_primary_key</code> in case of conflicts or to replace only certain fields by passing <code>on_conflict: {:replace, [:foo, :bar, baz]}</code>. This new version of Ecto also allow custom expressions to be given as <code>:conflict_target</code> by passing <code>{:unsafe_fragment, "be careful with what goes here"}</code> as a value.</p>
<p>There are many other improvements to the <code>Ecto.Repo</code> API, such as <code>Ecto.Repo.checkout</code>, introduced in the previous section, and the new <code>Ecto.Repo.exists?</code>.</p>
<h2>Migrations</h2>
<p>Another area in Ecto (or to be more precise, Ecto.SQL) that saw major improvements is migrations.</p>
<p>The most important change was a contribution by Allen Madsen that locks the migration table, allowing multiple machines to run migrations at the same time. In previous Ecto versions, if you had multiple machines attempting to run migrations, they could race each other, leading to failures, but now it is guaranteed such can&#8217;t happen. The type of lock can be configured via the <code>:migration_lock</code> repository configuration and defaults to &#8220;FOR UPDATE&#8221; or disabled if set to <code>nil</code>.</p>
<p>Another improvement is that Ecto is now capable of logging notices/alerts/warnings emitted by the database when running migrations. In previous Ecto versions, if you had a long index name, the database would truncate and emit an alert through the TCP connection, but this alert was never extracted and printed in the terminal. This is no longer the case in Ecto 3.0.</p>
<p>Similarly, Ecto will now warn if you attempt to run a migration and there is a higher version number already migrated in the database. Imagine you have been working on a feature for a long period of time and you were finally able to merge it to master. Since you started working on this feature, other features and migrations were already shipped to production. This may create an issue on deployment: in case something goes wrong when deploying this new feature and you have to rollback the database, the latest migrations by timestamp does not match the migrations that have just been executed.</p>
<p>By emitting warnings, we help developers and production teams alike to be aware of such pitfalls.</p>
<h2>Summing up</h2>
<p>We are very excited with the many improvements in Ecto 3.0. This short series of articles shares the most notable changes but there is much more. But perhaps the most important feature is that we have announced <a href="https://elixirforum.com/t/ecto-3-0-rc-is-out-and-stable-api/17306">Ecto to be stable API</a> and this is only possible due to the work that Plataformatec and the community has put into Ecto throughout the years. Enjoy!</p>
<p><a href="https://pages.plataformatec.com.br/elixir-development-subscription"><img decoding="async" class="aligncenter size-large wp-image-7816" src="/wp-content/uploads/2018/10/Elixir_2-1-1024x213.png" alt="banner-elixir development subscription" width="1024" height="213" srcset="/wp-content/uploads/2018/10/Elixir_2-1-1024x213.png 1024w, /wp-content/uploads/2018/10/Elixir_2-1-300x63.png 300w, /wp-content/uploads/2018/10/Elixir_2-1-768x160.png 768w, /wp-content/uploads/2018/10/Elixir_2-1.png 1200w" sizes="(max-width: 1024px) 100vw, 1024px"></a></p>
    </article>
  
      <p class="post-metadata">
      Tags: <a href="/tag/ecto/" rel="tag">ecto</a>, <a href="/tag/elixir/" rel="tag">elixir</a>, Posted in <a href="/category/english/" rel="category tag">English</a>,   <span>Comments Off<span class="screen-reader-text"> on A sneak peek at Ecto 3.0: performance, migrations and more</span></span>    </p>
  </section>

        <div class="comments-thread">
          
<!-- You can start editing here. -->


			<!-- If comments are closed. -->
		<p class="nocomments">Comments are closed.</p>

	
        </div>

        <div class="pagination-section">
          <a href="/2018/10/a-sneak-peek-at-ecto-3-0-query-improvements-part-2/" rel="prev">A sneak peek at Ecto 3.0: query improvements (part 2)</a>          <a href="/2018/10/updating-hex-pm-to-ecto-3-0/" rel="next">Updating Hex.pm to Ecto 3.0</a>        </div>
        </div>
  <aside class="sidebar-container">
  <div class="sidebar-box sidebar-box-divider">
    <ul class="social-links">
      <li><a href="/feed/" class="social-link rss-link" title="Subscribe to our RSS" target="_blank">Subscribe to our RSS</a></li>
      <li><a href="http://twitter.com/plataformatec" class="social-link twitter-link" title="Follow us on Twitter" target="_blank">@plataformatec</a></li>
      <li><a href="https://github.com/plataformatec" class="social-link github-link" title="Check our code at GitHub" target="_blank">Plataformatec @ GitHub</a></li>
      <li><a href="http://facebook.com/plataformatec.com.br" class="social-link facebook-link" title="Check our Facebook page" target="_blank">Plataformatec @ Facebook</a></li>
      <li><a href="http://www.linkedin.com/company/plataformatec" class="social-link linkedin-link" title="Check our LinkedIn page" target="_blank">Plataformatec @ LinkedIn</a></li>
    </ul>
  </div>

  <div class="sidebar-box sidebar-box-divider">
    This is the company blog of <strong>Plataformatec</strong>, a software development and
    consultancy company, specialized in Elixir, Ruby and Agile.
  </div>

  <div class="sidebar-box">
    <ul class="post-list">
      <li class="post-list-item">
<a href="/category/english">Posts in english</a> (107)</li>
      <li class="post-list-item">
<a href="/category/portugues">Posts em português</a> (33)</li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Recent Posts</h3>

    <ul class="post-list">
                    <li class="post-list-item">
          <a href="/2020/01/important-information-about-our-elixir-and-ruby-open-source-projects/">Important information about our Elixir and Ruby Open Source projects</a>
        </li>
              <li class="post-list-item">
          <a href="/2020/01/elixir-what-about-tests/">Elixir: What about tests?</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/12/okr-licoes-aprendidas-para-voce-comecar-a-aplica-lo-de-forma-efetiva/">OKR: lições aprendidas para você começar a aplicá-lo de forma efetiva</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/divida-tecnica-por-que-fazer-quando-fazer-e-como-priorizar/">Dívida técnica: Por que fazer, quando fazer e como priorizar</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/relation-between-story-points-and-development-time-lead-time/">Relation between Story Points and Development Time (Lead Time)</a>
        </li>
          </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Read more about</h3>

    <ul class="post-list">
      <li class="post-list-item"><a href="/tag/open-source">Open Source</a></li>
      <li class="post-list-item"><a href="/tag/front-end">Front end</a></li>
      <li class="post-list-item"><a href="/tag/conference">Conferences</a></li>
      <li class="post-list-item"><a href="/tag/security-fix">Security fixes</a></li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Check our product</h3>
    <a class="sidebar-cta-link" href="https://sourcelevel.io/">
      <img src="/wp-content/themes/ptec/assets/sourcelevel-300.png" width="300" alt="SourceLevel - Analytics for Engineering Ops">
	</a>

    <p align="center">Analytics for Engineering Ops.</p>
  </div>

</aside>
      <footer class="site-footer">
        <p>
          <span class="footer-copy">© 2009- 2024 Plataformatec. All rights reserved.</span>

          <a href="http://plataformatec.com.br/">Our site</a> ·
          <a href="http://plataformatec.com.br/contact">Contact us</a> ·
          <a href="http://twitter.com/plataformatec">@plataformatec</a>
        </p>
      </footer>
    </div>
                                              <script type="text/javascript" src="/wp-content/themes/ptec/application.js?ver=6.4.2" id="application-js"></script>
  </body>
</html>