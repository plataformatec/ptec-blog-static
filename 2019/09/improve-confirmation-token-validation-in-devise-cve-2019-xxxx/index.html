<!DOCTYPE html>
<html dir="ltr" lang="en-US" prefix="og: https://ogp.me/ns#">
<head>
  <meta charset="utf-8">
  <meta name="bitly-verification" content="b3acd9a47f4e">

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="emoji:root" content="/wp-content/themes/ptec">
  <meta name="theme-color" content="#cacaca">
  
    <meta name="bitly-verification" content="b3acd9a47f4e">
  <meta property="og:image" content="/wp-content/themes/ptec/assets/opengraph.png">
  <link rel="icon" sizes="192x192" href="/wp-content/themes/ptec/assets/icons/chrome-192x.png">
  <link rel="pingback" href="/xmlrpc.php">
  
		<!-- All in One SEO 4.5.4 - aioseo.com -->
		<title>Improve confirmation token validation in Devise (CVE-2019-16109) « Plataformatec Blog</title>
		<meta name="description" content="Devise version 4.7.1 was released with a fix for an edge case that could confirm accounts by mistake. We&#039;ll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications. Description We received a security report saying that it was possible to confirm">
		<meta name="robots" content="max-image-preview:large">
		<meta name="keywords" content="devise,troubleshooting,ruby on rails">
		<link rel="canonical" href="/2019/09/improve-confirmation-token-validation-in-devise-cve-2019-xxxx/">
		<meta name="generator" content="All in One SEO (AIOSEO) 4.5.4">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="Plataformatec Blog | Plataformatec&#039;s place to talk about Ruby, Ruby on Rails, Elixir, and software engineering">
		<meta property="og:type" content="article">
		<meta property="og:title" content="Improve confirmation token validation in Devise (CVE-2019-16109) « Plataformatec Blog">
		<meta property="og:description" content="Devise version 4.7.1 was released with a fix for an edge case that could confirm accounts by mistake. We&#039;ll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications. Description We received a security report saying that it was possible to confirm">
		<meta property="og:url" content="/2019/09/improve-confirmation-token-validation-in-devise-cve-2019-xxxx/">
		<meta property="article:published_time" content="2019-09-06T18:08:12+00:00">
		<meta property="article:modified_time" content="2019-09-09T13:09:08+00:00">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="Improve confirmation token validation in Devise (CVE-2019-16109) « Plataformatec Blog">
		<meta name="twitter:description" content="Devise version 4.7.1 was released with a fix for an edge case that could confirm accounts by mistake. We&#039;ll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications. Description We received a security report saying that it was possible to confirm">
		<meta name="google" content="nositelinkssearchbox">
		<script type="application/ld+json" class="aioseo-schema">{"@context":"https:\/\/schema.org","@graph":[{"@type":"Article","@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#article","name":"Improve confirmation token validation in Devise (CVE-2019-16109) « Plataformatec Blog","headline":"Improve confirmation token validation in Devise (CVE-2019-16109)","author":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/leonardo-tegon\/#author"},"publisher":{"@id":"http:\/\/blog.plataformatec.com.br\/#organization"},"datePublished":"2019-09-06T15:08:12-03:00","dateModified":"2019-09-09T10:09:08-03:00","inLanguage":"en-US","mainEntityOfPage":{"@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#webpage"},"isPartOf":{"@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#webpage"},"articleSection":"English, devise, rails"},{"@type":"BreadcrumbList","@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#breadcrumblist","itemListElement":[{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/#listItem","position":1,"name":"Home","item":"http:\/\/blog.plataformatec.com.br\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2019\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2019\/#listItem","position":2,"name":"2019","item":"http:\/\/blog.plataformatec.com.br\/2019\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2019\/09\/#listItem","previousItem":"http:\/\/blog.plataformatec.com.br\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/#listItem","position":3,"name":"September","item":"http:\/\/blog.plataformatec.com.br\/2019\/09\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#listItem","previousItem":"http:\/\/blog.plataformatec.com.br\/2019\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#listItem","position":4,"name":"Improve confirmation token validation in Devise (CVE-2019-16109)","previousItem":"http:\/\/blog.plataformatec.com.br\/2019\/09\/#listItem"}]},{"@type":"Organization","@id":"http:\/\/blog.plataformatec.com.br\/#organization","name":"Plataformatec Blog","url":"http:\/\/blog.plataformatec.com.br\/"},{"@type":"Person","@id":"http:\/\/blog.plataformatec.com.br\/author\/leonardo-tegon\/#author","url":"http:\/\/blog.plataformatec.com.br\/author\/leonardo-tegon\/","name":"Leonardo Tegon","image":{"@type":"ImageObject","@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#authorImage","url":"http:\/\/2.gravatar.com\/avatar\/5940ebc95c761f522ce0f9678a3e7be6?s=96&d=mm&r=pg","width":96,"height":96,"caption":"Leonardo Tegon"}},{"@type":"WebPage","@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#webpage","url":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/","name":"Improve confirmation token validation in Devise (CVE-2019-16109) « Plataformatec Blog","description":"Devise version 4.7.1 was released with a fix for an edge case that could confirm accounts by mistake. We'll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications. Description We received a security report saying that it was possible to confirm","inLanguage":"en-US","isPartOf":{"@id":"http:\/\/blog.plataformatec.com.br\/#website"},"breadcrumb":{"@id":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/#breadcrumblist"},"author":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/leonardo-tegon\/#author"},"creator":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/leonardo-tegon\/#author"},"datePublished":"2019-09-06T15:08:12-03:00","dateModified":"2019-09-09T10:09:08-03:00"},{"@type":"WebSite","@id":"http:\/\/blog.plataformatec.com.br\/#website","url":"http:\/\/blog.plataformatec.com.br\/","name":"Plataformatec Blog","description":"Plataformatec's place to talk about Ruby, Ruby on Rails, Elixir, and software engineering","inLanguage":"en-US","publisher":{"@id":"http:\/\/blog.plataformatec.com.br\/#organization"}}]}</script>
		<!-- All in One SEO -->


		<!-- Meta Tag Manager -->
		<meta name="twitter:label1" content="Plataformatec">
		<meta name="twitter:data1" content="Professional Consulting and Development for companies using Elixir or Ruby">
		<!-- / Meta Tag Manager -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Comments Feed" href="/comments/feed/">
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/blog.plataformatec.com.br\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.4.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"🏳️‍⚧️","🏳️​⚧️")?!1:!n(e,"🇺🇳","🇺​🇳")&&!n(e,"🏴󠁧󠁢󠁥󠁮󠁧󠁿","🏴​󠁧​󠁢​󠁥​󠁮​󠁧​󠁿");case"emoji":return!n(e,"🫱🏻‍🫲🏿","🫱🏻​🫲🏿")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.4.2" type="text/css" media="all">
<style id="wp-block-library-inline-css" type="text/css">.has-text-align-justify{text-align:justify;}</style>
<link rel="stylesheet" id="mediaelement-css" href="/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.17" type="text/css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=6.4.2" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="webfont-css" href="//fonts.googleapis.com/css?family=Bree+Serif&#038;ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="main-css" href="/wp-content/themes/ptec/style.css?ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="tablepress-default-css" href="/wp-content/plugins/tablepress/css/build/default.css?ver=2.2.4" type="text/css" media="all">
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/9287">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.4.2">
<link rel="shortlink" href="/?p=9287">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2F2019%2F09%2Fimprove-confirmation-token-validation-in-devise-cve-2019-xxxx%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2F2019%2F09%2Fimprove-confirmation-token-validation-in-devise-cve-2019-xxxx%2F#038;format=xml">
                                          </head>
  <body class="post-template-default single single-post postid-9287 single-format-standard">
    <div class="site-header">
      <div class="site-header-background">
        <header class="site-header-container">
          <h1 class="site-header-logo">
            <a href="/">
              <img src="/wp-content/themes/ptec/assets/plataformatec.svg" height="70" alt="The plataformatec logo">
            </a>
          </h1>

          <form class="header-search-form" method="GET" action="/">
            <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
          </form>

          <ul class="site-nav">
            <li class="site-nav-item"><a href="http://plataformatec.com.br/services">Services</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/playbook">Playbook</a></li>
            <li class="site-nav-item handheld-hidden"><a href="http://plataformatec.com.br/forge">Forge</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/careers">Careers</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/contact">Contact</a></li>
          </ul>
        </header>
      </div>
      <nav class="header-nav">
        <input type="checkbox" id="nav-toggle-checkbox" class="header-nav-checkbox">
        <label for="nav-toggle-checkbox" class="header-nav-toggle">Topics we write about</label>

        <ul class="header-nav-list" itemscope itemtype="http://schema.org/SiteNavigationElement">
          <li class="header-nav-item header-search-nav-item">
            <form class="header-nav-search-form" method="GET" action="/">
              <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
            </form>
          </li>
                    <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/elixir" itemprop="url">Elixir</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/rails" itemprop="url">Ruby on Rails</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/devise" itemprop="url">Devise</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/simple_form" itemprop="url">Simple Form</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/agile" itemprop="url">Agile</a>
          </li>
        </ul>
      </nav>
    </div>
<div class="site-container">
  <div class="page-container">
                  <section class="post-section">
  <header class="post-header">
    <h1 class="post-title">
      <a href="/2019/09/improve-confirmation-token-validation-in-devise-cve-2019-xxxx/" rel="bookmark">Improve confirmation token validation in Devise (CVE-2019-16109)</a>
    </h1>
          <time class="post-date-ribbon" datetime="2019-09-06T15:08:12-03:00">Sep 6, 2019</time>
      <p class="post-author">
        <img alt="" src="https://2.gravatar.com/avatar/5940ebc95c761f522ce0f9678a3e7be6?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/5940ebc95c761f522ce0f9678a3e7be6?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">        Written by <a href="/?author=54" title="Posts by Leonardo Tegon">Leonardo Tegon</a>.
      </p>
        </header>

      <article class="post-body">
      
<p>Devise version <code>4.7.1</code> was released with a fix for an edge case that could confirm accounts by mistake. We&#8217;ll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications.</p>



<h2 class="wp-block-heading">Description</h2>



<p>We received a security report saying that it was possible to confirm records with a blank <code>confirmation_token</code> parameter. In order words, hitting the following URL <code>/users/confirmation?confirmation_token=</code> would successfully confirm a user instead of showing a validation error &#8211; e.g. <code>Confirmation token can't be blank</code>.</p>



<p>This only happens if there are <strong>records with a blank confirmation token in the database</strong>. This is because of the way the method <code><a href="https://github.com/plataformatec/devise/blob/0ea4bd70b2ca852d3314f53b62ffd9c7583c4f0d/lib/devise/models/authenticatable.rb#L274" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">find_first_by_auth_conditions</a></code> works (which is similar to ActiveRecord&#8217;s <code>#find_by</code>). It is important to mention that we haven&#8217;t found a case where Devise sets <code>confirmation_token</code> to an empty string.</p>



<p>In summary, before version <code>4.7.1</code>, this is what would happen after hitting the confirmation endpoint with a blank <code>confirmation_token</code>:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-1" data-shcb-language-name="PHP" data-shcb-language-slug="php"><link rel="stylesheet" id="syntax-highlighting-code-block-css" href="/wp-content/plugins/syntax-highlighting-code-block/vendor/scrivo/highlight-php/styles/default.css?ver=1.3.1" type="text/css" media="all"><style>.wp-block-code {
	border: 0;
	padding: 0;
}

.wp-block-code > div {
	overflow: auto;
}

.shcb-language {
	border: 0;
	clip: rect(1px, 1px, 1px, 1px);
	-webkit-clip-path: inset(50%);
	clip-path: inset(50%);
	height: 1px;
	margin: -1px;
	overflow: hidden;
	padding: 0;
	position: absolute;
	width: 1px;
	word-wrap: normal;
	word-break: normal;
}

.hljs {
	box-sizing: border-box;
}

.hljs.shcb-code-table {
	display: table;
	width: 100%;
}

.hljs.shcb-code-table > .shcb-loc {
	color: inherit;
	display: table-row;
	width: 100%;
}

.hljs.shcb-code-table .shcb-loc > span {
	display: table-cell;
}

.wp-block-code code.hljs:not(.shcb-wrap-lines) {
	white-space: pre;
}

.wp-block-code code.hljs.shcb-wrap-lines {
	white-space: pre-wrap;
}

.hljs.shcb-line-numbers {
	border-spacing: 0;
	counter-reset: line;
}

.hljs.shcb-line-numbers > .shcb-loc {
	counter-increment: line;
}

.hljs.shcb-line-numbers .shcb-loc > span {
	padding-left: 0.75em;
}

.hljs.shcb-line-numbers .shcb-loc::before {
	border-right: 1px solid #ddd;
	content: counter(line);
	display: table-cell;
	padding: 0 0.75em;
	text-align: right;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
	white-space: nowrap;
	width: 1%;
}</style><div><code class="hljs language-php">Started GET <span class="hljs-string">"/users/confirmation?confirmation_token="</span> <span class="hljs-keyword">for</span> ::<span class="hljs-number">1</span> at <span class="hljs-number">2019</span><span class="hljs-number">-09</span><span class="hljs-number">-05</span> <span class="hljs-number">10</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29</span> <span class="hljs-number">-0300</span>
Processing by Devise::ConfirmationsController<span class="hljs-comment">#show as HTML</span>
  Parameters: {<span class="hljs-string">"confirmation_token"</span>=&gt;<span class="hljs-string">""</span>}
  User Load (<span class="hljs-number">1.0</span>ms)  SELECT  <span class="hljs-string">"users"</span>.* FROM <span class="hljs-string">"users"</span> WHERE <span class="hljs-string">"users"</span>.<span class="hljs-string">"confirmation_token"</span> = $<span class="hljs-number">1</span> ORDER BY <span class="hljs-string">"users"</span>.<span class="hljs-string">"id"</span> ASC LIMIT $<span class="hljs-number">2</span>  [[<span class="hljs-string">"confirmation_token"</span>, <span class="hljs-string">""</span>], [<span class="hljs-string">"LIMIT"</span>, <span class="hljs-number">1</span>]]</code></div><small class="shcb-language" id="shcb-language-1"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">PHP</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">php</span><span class="shcb-language__paren">)</span></small></pre>


<p>Notice that the SQL query is trying to find users with <code>confirmation_token = ""</code>.</p>



<p>It&#8217;s also worth mentioning that <strong>only unconfirmed records</strong> &#8211; i.e. with <code>confirmed_at: nil</code> in the database &#8211; would be confirmed in this case. For already confirmed users, a validation error (<code>Email was already confirmed, please try signing in</code>) would be displayed.</p>



<h2 class="wp-block-heading">Possible implications</h2>



<p>Considering that there are records with an empty <code>confirmation_token</code> in the database, a request sending a blank parameter would confirm the first record found in the database. This means that someone&#8217;s account would be confirmed by mistake.</p>



<p>A more sensible scenario is for applications that automatically sign in accounts after confirmation. That would not only confirm someone&#8217;s account but also give an attacker access to it. Although this feature is not included in Devise, we know that some applications might have it.</p>



<p>For already confirmed records &#8211; i.e. with a <code>confirmed_at</code> date in the database &#8211; the validation error would be displayed, but their email would be leaked to the end user inside the form&#8217;s input.</p>



<h2 class="wp-block-heading">Solution</h2>



<p>The solution was to validate whether the <code>confirmation_token</code> is empty before doing any query in the database. So now, when the same endpoint is hit, nothing happens:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-2" data-shcb-language-name="PHP" data-shcb-language-slug="php"><div><code class="hljs language-php">Processing by Devise::ConfirmationsController<span class="hljs-comment">#show as HTML</span>
  Parameters: {<span class="hljs-string">"confirmation_token"</span>=&gt;<span class="hljs-string">""</span>}
Completed <span class="hljs-number">200</span> OK in <span class="hljs-number">371</span>ms (Views: <span class="hljs-number">339.0</span>ms | ActiveRecord: <span class="hljs-number">5.9</span>ms)</code></div><small class="shcb-language" id="shcb-language-2"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">PHP</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">php</span><span class="shcb-language__paren">)</span></small></pre>


<p>And the end-user will see the validation error on the screen.</p>



<p>See the <a href="https://github.com/plataformatec/devise/pull/5132" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">pull request</a> with the solution for more information.</p>



<h2 class="wp-block-heading">Actions you might want to take</h2>



<p>Aside from updating Devise, you might also want to check whether you have records in that state in your application. You can do that with a query like this one:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-3" data-shcb-language-name="PHP" data-shcb-language-slug="php"><div><code class="hljs language-php">irb(main):<span class="hljs-number">001</span>:<span class="hljs-number">0</span>&gt; User.where(confirmation_token: <span class="hljs-string">""</span>)
  User Load (<span class="hljs-number">0.6</span>ms)  SELECT  <span class="hljs-string">"users"</span>.* FROM <span class="hljs-string">"users"</span> WHERE <span class="hljs-string">"users"</span>.<span class="hljs-string">"confirmation_token"</span> = $<span class="hljs-number">1</span> LIMIT $<span class="hljs-number">2</span>  [[<span class="hljs-string">"confirmation_token"</span>, <span class="hljs-string">""</span>], [<span class="hljs-string">"LIMIT"</span>, <span class="hljs-number">11</span>]]
=&gt; <span class="hljs-comment">#&lt;ActiveRecord::Relation []&gt;</span></code></div><small class="shcb-language" id="shcb-language-3"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">PHP</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">php</span><span class="shcb-language__paren">)</span></small></pre>


<p>If you get results out of this query, you might want to nullify them to avoid the confirmation by mistake:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-4" data-shcb-language-name="JavaScript" data-shcb-language-slug="javascript"><div><code class="hljs language-javascript">irb(main):<span class="hljs-number">002</span>:<span class="hljs-number">0</span>&gt; User.where(confirmation_token: <span class="hljs-string">""</span>).update(confirmation_token: nil)
  User Load (<span class="hljs-number">0.4</span>ms)  SELECT <span class="hljs-string">"users"</span>.* FROM <span class="hljs-string">"users"</span> WHERE <span class="hljs-string">"users"</span>.<span class="hljs-string">"confirmation_token"</span> = $<span class="hljs-number">1</span>  [[<span class="hljs-string">"confirmation_token"</span>, <span class="hljs-string">""</span>]]
   (<span class="hljs-number">0.2</span>ms)  BEGIN
  User Update (<span class="hljs-number">0.7</span>ms)  UPDATE <span class="hljs-string">"users"</span> SET <span class="hljs-string">"confirmation_token"</span> = $<span class="hljs-number">1</span>, <span class="hljs-string">"updated_at"</span> = $<span class="hljs-number">2</span> WHERE <span class="hljs-string">"users"</span>.<span class="hljs-string">"id"</span> = $<span class="hljs-number">3</span>  [[<span class="hljs-string">"confirmation_token"</span>, nil], [<span class="hljs-string">"updated_at"</span>, <span class="hljs-string">"2019-09-05 14:03:20.857488"</span>], [<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>]]
   (<span class="hljs-number">1.2</span>ms)  COMMIT</code></div><small class="shcb-language" id="shcb-language-4"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">JavaScript</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">javascript</span><span class="shcb-language__paren">)</span></small></pre>


<h2 class="wp-block-heading">Causes</h2>



<p>Although we received a report where someone worked in an application that had records with a blank confirmation token in the database, no code or use case was found inside Devise that would make records end up in that state.</p>



<p>If you find a case where this happens, please contact us at <a href="mailto:opensource@plataformatec.com.br">opensource@plataformatec.com.br</a> and we&#8217;ll look at it.</p>



<p>Finally, we want to thank <a href="https://github.com/amangano-privy" target="_blank" rel="noreferrer noopener" aria-label="Anthony Mangano (opens in a new tab)">Anthony Mangano</a> for reporting this issue and helping with the solution.</p>
    </article>
  
      <p class="post-metadata">
      Tags: <a href="/tag/devise/" rel="tag">devise</a>, <a href="/tag/rails/" rel="tag">rails</a>, Posted in <a href="/category/english/" rel="category tag">English</a>,   <span>Comments Off<span class="screen-reader-text"> on Improve confirmation token validation in Devise (CVE-2019-16109)</span></span>    </p>
  </section>

        <div class="comments-thread">
          
<!-- You can start editing here. -->


			<!-- If comments are closed. -->
		<p class="nocomments">Comments are closed.</p>

	
        </div>

        <div class="pagination-section">
          <a href="/2019/09/how-to-manage-deadlines-in-agile-environments-get-to-know-the-reality-check-tool/" rel="prev">How to manage deadlines in agile environments? Get to know the Reality Check Tool</a>          <a href="/2019/09/desenvolvendo-um-olhar-de-produto-na-organizacao/" rel="next">Desenvolvendo um olhar de produto na organização</a>        </div>
        </div>
  <aside class="sidebar-container">
  <div class="sidebar-box sidebar-box-divider">
    <ul class="social-links">
      <li><a href="/feed/" class="social-link rss-link" title="Subscribe to our RSS" target="_blank">Subscribe to our RSS</a></li>
      <li><a href="http://twitter.com/plataformatec" class="social-link twitter-link" title="Follow us on Twitter" target="_blank">@plataformatec</a></li>
      <li><a href="https://github.com/plataformatec" class="social-link github-link" title="Check our code at GitHub" target="_blank">Plataformatec @ GitHub</a></li>
      <li><a href="http://facebook.com/plataformatec.com.br" class="social-link facebook-link" title="Check our Facebook page" target="_blank">Plataformatec @ Facebook</a></li>
      <li><a href="http://www.linkedin.com/company/plataformatec" class="social-link linkedin-link" title="Check our LinkedIn page" target="_blank">Plataformatec @ LinkedIn</a></li>
    </ul>
  </div>

  <div class="sidebar-box sidebar-box-divider">
    This is the company blog of <strong>Plataformatec</strong>, a software development and
    consultancy company, specialized in Elixir, Ruby and Agile.
  </div>

  <div class="sidebar-box">
    <ul class="post-list">
      <li class="post-list-item">
<a href="/category/english">Posts in english</a> (107)</li>
      <li class="post-list-item">
<a href="/category/portugues">Posts em português</a> (33)</li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Recent Posts</h3>

    <ul class="post-list">
                    <li class="post-list-item">
          <a href="/2020/01/important-information-about-our-elixir-and-ruby-open-source-projects/">Important information about our Elixir and Ruby Open Source projects</a>
        </li>
              <li class="post-list-item">
          <a href="/2020/01/elixir-what-about-tests/">Elixir: What about tests?</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/12/okr-licoes-aprendidas-para-voce-comecar-a-aplica-lo-de-forma-efetiva/">OKR: lições aprendidas para você começar a aplicá-lo de forma efetiva</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/divida-tecnica-por-que-fazer-quando-fazer-e-como-priorizar/">Dívida técnica: Por que fazer, quando fazer e como priorizar</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/relation-between-story-points-and-development-time-lead-time/">Relation between Story Points and Development Time (Lead Time)</a>
        </li>
          </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Read more about</h3>

    <ul class="post-list">
      <li class="post-list-item"><a href="/tag/open-source">Open Source</a></li>
      <li class="post-list-item"><a href="/tag/front-end">Front end</a></li>
      <li class="post-list-item"><a href="/tag/conference">Conferences</a></li>
      <li class="post-list-item"><a href="/tag/security-fix">Security fixes</a></li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Check our product</h3>
    <a class="sidebar-cta-link" href="https://sourcelevel.io/">
      <img src="/wp-content/themes/ptec/assets/sourcelevel-300.png" width="300" alt="SourceLevel - Analytics for Engineering Ops">
	</a>

    <p align="center">Analytics for Engineering Ops.</p>
  </div>

</aside>
      <footer class="site-footer">
        <p>
          <span class="footer-copy">© 2009- 2024 Plataformatec. All rights reserved.</span>

          <a href="http://plataformatec.com.br/">Our site</a> ·
          <a href="http://plataformatec.com.br/contact">Contact us</a> ·
          <a href="http://twitter.com/plataformatec">@plataformatec</a>
        </p>
      </footer>
    </div>
                                              <script type="text/javascript" src="/wp-content/themes/ptec/application.js?ver=6.4.2" id="application-js"></script>
  </body>
</html>