<!DOCTYPE html>
<html dir="ltr" lang="en-US" prefix="og: https://ogp.me/ns#">
<head>
  <meta charset="utf-8">
  <meta name="bitly-verification" content="b3acd9a47f4e">

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="emoji:root" content="/wp-content/themes/ptec">
  <meta name="theme-color" content="#cacaca">
  
    <meta name="bitly-verification" content="b3acd9a47f4e">
  <meta property="og:image" content="/wp-content/themes/ptec/assets/opengraph.png">
  <link rel="icon" sizes="192x192" href="/wp-content/themes/ptec/assets/icons/chrome-192x.png">
  <link rel="pingback" href="/xmlrpc.php">
  
		<!-- All in One SEO 4.5.4 - aioseo.com -->
		<title>Many to many and upserts « Plataformatec Blog</title>
		<meta name="description" content="This is the 9th chap of our ebook &quot;What&#039;s new in Ecto 2.0 (beta version)&quot; that José Valim presents `Ecto.Changeset.put_assoc/4` in contrast to `cast_assoc/3.">
		<meta name="robots" content="max-image-preview:large">
		<meta name="keywords" content="elixir,elixir programming language,ecto 2.0">
		<link rel="canonical" href="/2016/12/many-to-many-and-upserts/">
		<meta name="generator" content="All in One SEO (AIOSEO) 4.5.4">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="Plataformatec Blog | Plataformatec&#039;s place to talk about Ruby, Ruby on Rails, Elixir, and software engineering">
		<meta property="og:type" content="article">
		<meta property="og:title" content="Many to many and upserts « Plataformatec Blog">
		<meta property="og:description" content="This is the 9th chap of our ebook &quot;What&#039;s new in Ecto 2.0 (beta version)&quot; that José Valim presents `Ecto.Changeset.put_assoc/4` in contrast to `cast_assoc/3.">
		<meta property="og:url" content="/2016/12/many-to-many-and-upserts/">
		<meta property="article:published_time" content="2016-12-07T19:02:29+00:00">
		<meta property="article:modified_time" content="2017-01-16T21:06:54+00:00">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="Many to many and upserts « Plataformatec Blog">
		<meta name="twitter:description" content="This is the 9th chap of our ebook &quot;What&#039;s new in Ecto 2.0 (beta version)&quot; that José Valim presents `Ecto.Changeset.put_assoc/4` in contrast to `cast_assoc/3.">
		<meta name="google" content="nositelinkssearchbox">
		<script type="application/ld+json" class="aioseo-schema">{"@context":"https:\/\/schema.org","@graph":[{"@type":"Article","@id":"\/2016\/12\/many-to-many-and-upserts\/#article","name":"Many to many and upserts « Plataformatec Blog","headline":"Many to many and upserts","author":{"@id":"\/author\/josevalim\/#author"},"publisher":{"@id":"\/#organization"},"image":{"@type":"ImageObject","url":"\/wp-content\/uploads\/2016\/12\/CTA-blog-ebook-ecto-2-0.jpg","@id":"\/2016\/12\/many-to-many-and-upserts\/#articleImage","width":831,"height":147,"caption":"What's new in Ecto 2.0 -- Download your copy"},"datePublished":"2016-12-07T17:02:29-02:00","dateModified":"2017-01-16T19:06:54-02:00","inLanguage":"en-US","commentCount":13,"mainEntityOfPage":{"@id":"\/2016\/12\/many-to-many-and-upserts\/#webpage"},"isPartOf":{"@id":"\/2016\/12\/many-to-many-and-upserts\/#webpage"},"articleSection":"English, ecto, elixir"},{"@type":"BreadcrumbList","@id":"\/2016\/12\/many-to-many-and-upserts\/#breadcrumblist","itemListElement":[{"@type":"ListItem","@id":"\/#listItem","position":1,"name":"Home","item":"\/","nextItem":"\/2016\/#listItem"},{"@type":"ListItem","@id":"\/2016\/#listItem","position":2,"name":"2016","item":"\/2016\/","nextItem":"\/2016\/12\/#listItem","previousItem":"\/#listItem"},{"@type":"ListItem","@id":"\/2016\/12\/#listItem","position":3,"name":"December","item":"\/2016\/12\/","nextItem":"\/2016\/12\/many-to-many-and-upserts\/#listItem","previousItem":"\/2016\/#listItem"},{"@type":"ListItem","@id":"\/2016\/12\/many-to-many-and-upserts\/#listItem","position":4,"name":"Many to many and upserts","previousItem":"\/2016\/12\/#listItem"}]},{"@type":"Organization","@id":"\/#organization","name":"Plataformatec Blog","url":"\/"},{"@type":"Person","@id":"\/author\/josevalim\/#author","url":"\/author\/josevalim\/","name":"José Valim","image":{"@type":"ImageObject","@id":"\/2016\/12\/many-to-many-and-upserts\/#authorImage","url":"https:\/\/secure.gravatar.com\/avatar\/e837f6b7fd146ab16ed3d663476c063e?s=96&d=mm&r=pg","width":96,"height":96,"caption":"José Valim"}},{"@type":"WebPage","@id":"\/2016\/12\/many-to-many-and-upserts\/#webpage","url":"\/2016\/12\/many-to-many-and-upserts\/","name":"Many to many and upserts « Plataformatec Blog","description":"This is the 9th chap of our ebook \"What's new in Ecto 2.0 (beta version)\" that José Valim presents `Ecto.Changeset.put_assoc\/4` in contrast to `cast_assoc\/3.","inLanguage":"en-US","isPartOf":{"@id":"\/#website"},"breadcrumb":{"@id":"\/2016\/12\/many-to-many-and-upserts\/#breadcrumblist"},"author":{"@id":"\/author\/josevalim\/#author"},"creator":{"@id":"\/author\/josevalim\/#author"},"datePublished":"2016-12-07T17:02:29-02:00","dateModified":"2017-01-16T19:06:54-02:00"},{"@type":"WebSite","@id":"\/#website","url":"\/","name":"Plataformatec Blog","description":"Plataformatec's place to talk about Ruby, Ruby on Rails, Elixir, and software engineering","inLanguage":"en-US","publisher":{"@id":"\/#organization"}}]}</script>
		<!-- All in One SEO -->


		<!-- Meta Tag Manager -->
		<meta name="twitter:label1" content="Plataformatec">
		<meta name="twitter:data1" content="Professional Consulting and Development for companies using Elixir or Ruby">
		<!-- / Meta Tag Manager -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Comments Feed" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Many to many and upserts Comments Feed" href="/2016/12/many-to-many-and-upserts/feed/">
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.4.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"🏳️‍⚧️","🏳️​⚧️")?!1:!n(e,"🇺🇳","🇺​🇳")&&!n(e,"🏴󠁧󠁢󠁥󠁮󠁧󠁿","🏴​󠁧​󠁢​󠁥​󠁮​󠁧​󠁿");case"emoji":return!n(e,"🫱🏻‍🫲🏿","🫱🏻​🫲🏿")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.4.2" type="text/css" media="all">
<style id="wp-block-library-inline-css" type="text/css">.has-text-align-justify{text-align:justify;}</style>
<link rel="stylesheet" id="mediaelement-css" href="/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.17" type="text/css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=6.4.2" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="webfont-css" href="//fonts.googleapis.com/css?family=Bree+Serif&#038;ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="main-css" href="/wp-content/themes/ptec/style.css?ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="tablepress-default-css" href="/wp-content/plugins/tablepress/css/build/default.css?ver=2.2.4" type="text/css" media="all">
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/5939">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.4.2">
<link rel="shortlink" href="/?p=5939">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2016%2F12%2Fmany-to-many-and-upserts%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2016%2F12%2Fmany-to-many-and-upserts%2F#038;format=xml">
</head>
  <body class="post-template-default single single-post postid-5939 single-format-standard">
    <div class="site-header">
      <div class="site-header-background">
        <header class="site-header-container">
          <h1 class="site-header-logo">
            <a href="/">
              <img src="/wp-content/themes/ptec/assets/plataformatec.svg" height="70" alt="The plataformatec logo">
            </a>
          </h1>

          <form class="header-search-form" method="GET" action="/">
            <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
          </form>

          <ul class="site-nav">
            <li class="site-nav-item"><a href="http://plataformatec.com.br/services">Services</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/playbook">Playbook</a></li>
            <li class="site-nav-item handheld-hidden"><a href="http://plataformatec.com.br/forge">Forge</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/careers">Careers</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/contact">Contact</a></li>
          </ul>
        </header>
      </div>
      <nav class="header-nav">
        <input type="checkbox" id="nav-toggle-checkbox" class="header-nav-checkbox">
        <label for="nav-toggle-checkbox" class="header-nav-toggle">Topics we write about</label>

        <ul class="header-nav-list" itemscope itemtype="http://schema.org/SiteNavigationElement">
          <li class="header-nav-item header-search-nav-item">
            <form class="header-nav-search-form" method="GET" action="/">
              <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
            </form>
          </li>
                    <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/elixir" itemprop="url">Elixir</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/rails" itemprop="url">Ruby on Rails</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/devise" itemprop="url">Devise</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/simple_form" itemprop="url">Simple Form</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/agile" itemprop="url">Agile</a>
          </li>
        </ul>
      </nav>
    </div>
<div class="site-container">
  <div class="page-container">
                  <section class="post-section">
  <header class="post-header">
    <h1 class="post-title">
      <a href="/2016/12/many-to-many-and-upserts/" rel="bookmark">Many to many and upserts</a>
    </h1>
          <time class="post-date-ribbon" datetime="2016-12-07T17:02:29-02:00">Dec 7, 2016</time>
      <p class="post-author">
        <img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">        Written by <a href="/?author=4" title="Posts by José Valim">José Valim</a>.
      </p>
        </header>

      <article class="post-body">
      <div style="border:solid 1px #FFE041; background-color:#FFF9CA; padding:20px; font:italic 13px Gotham, Helvetica Neue, Helvetica, Arial,' sans-serif';">Note: This is a sample chapter <del datetime="2017-01-16T21:04:33+00:00">of the upcoming beta version</del> of our &#8220;What&#8217;s new in Ecto 2.0&#8221; free book. <a href="http://pages.plataformatec.com.br/ebook-whats-new-in-ecto-2-0"><del datetime="2017-01-16T21:05:26+00:00">Reserve</del> Download your copy now</a> <del datetime="2017-01-16T21:05:26+00:00">if you want to receive the next beta and be notified of future versions</del>.</div>
<p>In the previous chapter we have learned about <code>many_to_many</code> associations and how to map external data to associated entries with the help of <code>Ecto.Changeset.cast_assoc/3</code>. While in the previous chapter we were able to follow the rules imposed by <code>cast_assoc/3</code>, doing so is not always possible nor desired.</p>
<p>In this chapter we are going to look at <code>Ecto.Changeset.put_assoc/4</code> in contrast to <code>cast_assoc/3</code> and explore some examples. We will also peek at the upsert features coming in Ecto 2.1.</p>
<h2>put_assoc vs cast_assoc</h2>
<p>Imagine we are building an application that has blog posts and such posts may have many tags. Not only that, a given tag may also belong to many posts. This is a classic scenario where we would use <code>many_to_many</code> associations. Our migrations would look like:</p>
<pre><code class="elixir">create table(:posts) do
  add :title
  add :body
  timestamps()
end

create table(:tags) do
  add :name
  timestamps()
end

create unique_index(:tags, [:name])

create table(:posts_tags, primary_key: false) do
  add :post_id, references(:posts)
  add :tag_id, references(:tags)
end
</code></pre>
<p>Note we added a unique index to the tag name because we don&#8217;t want to have duplicated tags in our database. It is important to add an index at the database level instead of using a validation since there is always a chance two tags with the same name would be validated and inserted simultaneously, passing the validation and leading to duplicated entries.</p>
<p>Now let&#8217;s also imagine we want the user input such tags as a list of words split by comma, such as: &#8220;elixir, erlang, ecto&#8221;. Once this data is received in the server, we will break it apart into multiple tags and associate them to the post, creating any tag that does not yet exist in the database.</p>
<p>While the constraints above sound reasonable, that&#8217;s exactly what put us in trouble with <code>cast_assoc/3</code>. Remember the <code>cast_assoc/3</code> changeset function was designed to receive external parameters and compare them with the associated data in our structs. To do so correctly, Ecto requires tags to be sent as a list of maps. However here we expect tags to be sent in a string separated by comma.</p>
<p>Furthermore <code>cast_assoc/3</code> relies on the primary key field for each tag sent in order to decide if it should be inserted, updated or deleted. Again, because the user is simply passing a string, we don&#8217;t have the ID information at hand.</p>
<p>When we can&#8217;t cope with <code>cast_assoc/3</code>, it is time to use <code>put_assoc/4</code>. In <code>put_assoc/4</code>, we give Ecto structs or changesets instead of parameters, giving us the ability to manipulate the data as we want. Let&#8217;s define the schema and the changeset function for a post which may receive tags as a string:</p>
<pre><code class="elixir">defmodule MyApp.Post do
  use Ecto.Schema

  schema "posts" do
    field :title
    field :body
    many_to_many :tags, MyApp.Tag, join_through: "posts_tags"
    timestamps()
  end

  def changeset(struct, params \\ %{}) do
    struct
    |&gt; Ecto.Changeset.cast(params, [:title, :body])
    |&gt; Ecto.Changeset.put_assoc(:tags, parse_tags(params))
  end

  defp parse_tags(params)  do
    (params["tags"] || "")
    |&gt; String.split(",")
    |&gt; Enum.map(&amp;String.trim/1)
    |&gt; Enum.reject(&amp; &amp;1 == "")
    |&gt; Enum.map(&amp;get_or_insert_tag/1)
  end

  defp get_or_insert_tag(name) do
    Repo.get_by(MyApp.Tag, name: name) ||
      Repo.insert!(MyApp.Tag, %Tag{name: name})
  end
end
</code></pre>
<p>In the changeset function above, we moved all the handling of tags to a separate function, called <code>parse_tags/1</code>, which checks for the parameter, breaks its entries apart via <code>String.split/2</code>, then removes any left over whitespace with <code>String.trim/1</code>, rejects any empty string and finally checks if the tag exists in the database or not, creating one in case none exists.</p>
<p>The <code>parse_tags/1</code> function is going to return a list of <code>MyApp.Tag</code> structs which are then passed to <code>put_assoc/3</code>. By calling <code>put_assoc/3</code>, we are telling Ecto those should be the tags associated to the post from now on. In case a previous tag was associated to the post and not given in <code>put_assoc/3</code>, Ecto will also take care of removing the association between the post and the removed tag from the database.</p>
<p>And that&#8217;s all we need to use <code>many_to_many</code> associations with <code>put_assoc/3</code>. <code>put_assoc/3</code> works with <code>has_many</code>, <code>belongs_to</code> and all others association types. However, our code is not yet ready for production. Let&#8217;s see why.</p>
<h2>Constraints and race conditions</h2>
<p>Remember we added a unique index to the tag <code>:name</code> column when creating the tags table. We did so to protect us from having duplicate tags in the database.</p>
<p>By adding the unique index and then using <code>get_by</code>  with a <code>insert!</code> to get or insert a tag, we introduced a potential error in our application. If two posts are submitted at the same time with a similar tag, there is a chance we will check if the tag exists at the same time, leading both submissions to believe there is no such tag in the database. When that happens, only one of the submissions will succeed while the other one will fail. That&#8217;s a race condition: your code will error from time to time, only when certain conditions are met. And those conditions are time sensitive.</p>
<p>Many developers have a tendency to think such errors won&#8217;t happen in practice or, if they happened, they would be irrelevant. But in practice they often lead to very frustrating user experiences. I have heard a first-hand example coming from a mobile game company. In the game, a player is able to play quests and on every quest you have to choose a guest character from another player out of a short list to go on the quest with you. At the end of the quest, you have the option to add the guest character as a friend.</p>
<p>Originally the whole guest list was random but, as time passed, players started to complain sometimes old accounts, often inactive, were being shown in the guests options list. To improve the situation, the game developers started to sort the guest list by most recently active. This means that, if you have just played recently, there is a higher chance of you to be on someone guest lists.</p>
<p>However, when they did such change, many errors started to show up and users were suddenly furious in the game forum. That&#8217;s because when they sorted players by activity, as soon two players logged in, their characters would likely appear on each others guest list. If those players picked each others characters, the first to add the other as friend at the end of a quest would be able to succeed but an error would appear when the second player tried to add that character as a friend since the relationship already existed in the database! Not only that, all the progress done in the quest would be lost, because the server was unable to properly persist the quest results to the database. Understandably, players started to file complaints.</p>
<p>Long story short: we must address the race condition.</p>
<p>Luckily Ecto gives us a mechanism to handle constraint errors from the database.</p>
<h2>Checking for constraint errors</h2>
<p>Since our <code>get_or_insert_tag(name)</code> function fails when a tag already exists in the database, we need to handle such scenarios accordingly. Let&#8217;s rewrite it taking race conditions into account in mind:</p>
<pre><code class="elixir">defp get_or_insert_tag(name) do
  %Tag{}
  |&gt; Ecto.Changeset.change(name: name)
  |&gt; Ecto.Changeset.unique_constraint(:name)
  |&gt; Repo.insert
  |&gt; case do
    {:ok, tag} -&gt; tag
    {:error, _} -&gt; Repo.get_by!(MyApp.Tag, name: name)
  end
end
</code></pre>
<p>Instead of inserting the tag directly, we know build a changeset, which allows us to use the <code>unique_constraint</code> annotation. Now if the <code>Repo.insert</code> operation fails because the unique index for <code>:name</code> is violated, Ecto won&#8217;t raise, but return an <code>{:error, changeset}</code> tuple. Therefore, if the <code>Repo.insert</code> succeeds, it is because the tag was saved, otherwise the tag already exists, which we then fetch with <code>Repo.get_by!</code>.</p>
<p>While the mechanism above fixes the race condition, it is a quite expensive one: we need to perform two queries for every tag that already exists in the database: the (failed) insert and then the repository lookup. Given that&#8217;s the most common scenario, we may want to rewrite it to the following:</p>
<pre><code class="elixir">defp get_or_insert_tag(name) do
  Repo.get_by(MyApp.Tag, name: name) || maybe_insert_tag(name)
end

defp maybe_insert_tag(name) do
  %Tag{}
  |&gt; Ecto.Changeset.change(name: name)
  |&gt; Ecto.Changeset.unique_constraint(:name)
  |&gt; Repo.insert
  |&gt; case do
    {:ok, tag} -&gt; tag
    {:error, _} -&gt; Repo.get_by!(MyApp.Tag, name: name)
  end
end
</code></pre>
<p>The above performs 1 query for every tag that already exists, 2 queries for every new tag and possibly 3 queries in the case of race conditions. While the above would perform slightly better on average, Ecto 2.1 has a better option in stock.</p>
<h2>Upserts</h2>
<p>Ecto 2.1 supports the so-called &#8220;upsert&#8221; command which is an abbreviation for &#8220;update or insert&#8221;. The idea is that we try to insert a record and in case it conflicts with an existing entry, for example due to a unique index, we can choose how we want the database to act by either raising an error (the default behaviour), ignoring the insert (no error) or by updating the conflicting database entries.</p>
<p>&#8220;upsert&#8221; in Ecto 2.1 is done with the <code>:on_conflict</code> option. Let&#8217;s rewrite <code>get_or_insert_tag(name)</code> once more but this time using the <code>:on_conflict</code> option. Remember that &#8220;upsert&#8221; is a new feature in PostgreSQL 9.5, so make sure you are up to date.</p>
<p>Your first try in using <code>:on_conflict</code> may be by setting it to <code>:nothing</code>, as below:</p>
<pre><code class="elixir">defp get_or_insert_tag(name) do
  Repo.insert!(%MyApp.Tag{name: name}, on_conflict: :nothing)
end
</code></pre>
<p>While the above won&#8217;t raise an error in case of conflicts, it also won&#8217;t update the struct given, so it will return a tag without ID. One solution is to force an update to happen in case of conflicts, even if the update is about setting the tag name to its current name. In such cases, PostgreSQL also requires the <code>:conflict_target</code> option to be given, which is the column (or a list of columns) we are expecting the conflict to happen:</p>
<pre><code class="elixir">defp get_or_insert_tag(name) do
  Repo.insert!(%MyApp.Tag{name: name},
               on_conflict: [set: [name: name]], conflict_target: :name)
end
</code></pre>
<p>And that&#8217;s it! We try to insert a tag with the given name and if such tag already exists, we tell Ecto to update its name to the current value, updating the tag and fetching its id. While the above is certainly a step up from all solutions so far, it still performs one query per tag. If 10 tags are sent, we will perform 10 queries. Can we further improve this?</p>
<h2>Upserts and insert_all</h2>
<p>Ecto 2.1 did not only add the <code>:on_conflict</code> option to <code>Repo.insert/2</code> but also to the <code>Repo.insert_all/3</code> function introduced in Ecto 2.0. This means we can build one query that attempts to insert all missing tags and then another query that fetches all of them at once. Let&#8217;s see how our <code>Post</code> schema will look like after those changes:</p>
<pre><code class="elixir">defmodule MyApp.Post do
  use Ecto.Schema

  # Schema is the same
  schema "posts" do
    field :title
    field :body
    many_to_many :tags, MyApp.Tag, join_through: "posts_tags"
    timestamps()
  end

  # Changeset is the same
  def changeset(struct, params \\ %{}) do
    struct
    |&gt; Ecto.Changeset.cast(params, [:title, :body])
    |&gt; Ecto.Changeset.put_assoc(:tags, parse_tags(params))
  end

  # Parse tags has slightly changed
  defp parse_tags(params)  do
    (params["tags"] || "")
    |&gt; String.split(",")
    |&gt; Enum.map(&amp;String.trim/1)
    |&gt; Enum.reject(&amp; &amp;1 == "")
    |&gt; insert_and_get_all()
  end

  defp insert_and_get_all([]) do
    []
  end
  defp insert_and_get_all(names) do
    maps = Enum.map(names, &amp;%{name: &amp;1})
    Repo.insert_all MyApp.Tag, maps, on_conflict: :nothing
    Repo.all(from t in MyApp.Tag, where: t.name in ^names)
  end
end
</code></pre>
<p>Instead of attempting to get and insert each tag individually, the code above work on all tags at once, first by building a list of maps which is given to <code>insert_all</code> and then by looking up all tags with the existing names. Therefore, regardless of how many tags are sent, we will perform only 2 queries (unless no tag is sent, in which we return an empty list back promptly). This solution is only possible in Ecto 2.1 thanks to the <code>:on_conflict</code> option, which guarantees <code>insert_all</code> won&#8217;t fail in case a given tag name already exists.</p>
<p>Finally, keep in mind that we haven&#8217;t used transactions in any of the examples so far. Such decision was deliberate. Since getting or inserting tags is an idempotent operation, i.e. we can repeat it many times and it will always give us the same result back. Therefore, even if we fail to introduce the post to the database due to a validation error, the user will be free to resubmit the form and we will just attempt to get or insert the same tags once again. The downside of this approach is that tags will be created even if creating the post fails, which means some tags may not have posts associated to them. In case that&#8217;s not desired, the whole operation could be wrapped in a transaction or modeled with the <a href="https://hexdocs.pm/ecto/Ecto.Multi.html"><code>Ecto.Multi</code></a> abstraction we will learn about in future chapters.</p>
<hr style="margin-top:30px">
<p><a href="http://pages.plataformatec.com.br/ebook-whats-new-in-ecto-2-0?utm_source=our-blog&#038;utm_medium=referral&#038;utm_campaign=ebook-ecto-2-0&#038;utm_content=cta-blog-post-bottom" target="_blank"><br>
<img fetchpriority="high" decoding="async" src="/wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0.jpg" alt="What&#039;s new in Ecto 2.0 -- Download your copy" width="831" height="147" class="aligncenter size-full wp-image-5997" srcset="/wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0.jpg 831w, /wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0-300x53.jpg 300w, /wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0-768x136.jpg 768w" sizes="(max-width: 831px) 100vw, 831px"><br>
</a></p>
    </article>
  
      <p class="post-metadata">
      Tags: <a href="/tag/ecto/" rel="tag">ecto</a>, <a href="/tag/elixir/" rel="tag">elixir</a>, Posted in <a href="/category/english/" rel="category tag">English</a>,   <a href="/2016/12/many-to-many-and-upserts/#comments"><span class="dsq-postid" data-dsqidentifier="5939 http://blog.plataformatec.com.br/?p=5939">13 Comments &#187;</span></a>    </p>
  </section>

        <div class="comments-thread">
          
<!-- You can start editing here. -->

	<h3 id="comments">
		13 responses to &#8220;Many to many and upserts&#8221;	</h3>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

	<ol class="commentlist">
			<li class="comment even thread-even depth-1" id="comment-1675">
				<div id="div-comment-1675" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/168ea52dda0f06e5b8d753b0dcf3a3c0?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/168ea52dda0f06e5b8d753b0dcf3a3c0?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">			<cite class="fn">wdiechmann</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1675">December 12, 2016 at 6:59 am</a>		</div>

		<p>A wonderful write!</p>
<p>Am I correct to assuming that </p>
<p>    maps = Enum.map(names, &amp;%{name: &amp;1})</p>
<p>should/could be written like </p>
<p>    _ = Enum.map(names, &amp;%{name: &amp;1})</p>
<p>as the return value is not used?</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1676">
				<div id="div-comment-1676" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1676">December 12, 2016 at 7:05 am</a>		</div>

		<p>Oh, we should use it on `insert_all`. I will update the code snippet, thank you!</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1677">
				<div id="div-comment-1677" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/05da8adb6094de1c4cbcfe2e18f6022e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/05da8adb6094de1c4cbcfe2e18f6022e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Smith Aitufe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1677">December 12, 2016 at 5:58 pm</a>		</div>

		<p>I totally enjoyed your teaching. </p>
<p>Thanks so much for the wonderful piece. I am looking forward to future posts. </p>
<p>I love elixir, phoenix and ecto. Just a request, I will love more posts on supervisors, web workers and real life examples. </p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1684">
				<div id="div-comment-1684" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/48f7edc0234f09e597e6d00be33dc0d2?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/48f7edc0234f09e597e6d00be33dc0d2?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Jeremy Miranda</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1684">December 22, 2016 at 8:26 pm</a>		</div>

		<p>shouldn&#8217;t you be passing params instead of struct on<br>
this:<br>
def changeset(struct, params \ %{}) do<br>
    struct<br>
    |&gt; Ecto.Changeset.cast(params, [:title, :body])<br>
    |&gt; Ecto.Changeset.put_assoc(:tags, parse_tags(params))<br>
  end</p>
<p>instead of:<br>
def changeset(struct, params \ %{}) do<br>
    struct<br>
    |&gt; Ecto.Changeset.cast(struct, [:title, :body])<br>
    |&gt; Ecto.Changeset.put_assoc(:tags, parse_tags(params))<br>
  end</p>
<p>if not could you explain please. Thanks.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1685">
				<div id="div-comment-1685" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1685">December 22, 2016 at 8:35 pm</a>		</div>

		<p>You are right. Fixed!</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1687">
				<div id="div-comment-1687" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/60eedfd6965540c18f52488fd740fa5d?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/60eedfd6965540c18f52488fd740fa5d?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">victoriawagman</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1687">December 26, 2016 at 8:32 am</a>		</div>

		<p>Hi</p>
<p>Why does it say:<br>
add :title<br>
add :body</p>
<p>instead of<br>
field :title<br>
field :body</p>
<p>Thank you for writing &amp; sharing!</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1688">
				<div id="div-comment-1688" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1688">December 26, 2016 at 8:35 am</a>		</div>

		<p>That&#8217;s a mistake, thank you! I have fixed it.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1689">
				<div id="div-comment-1689" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/99da5370aa9792c23e10d54b8a0bade2?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/99da5370aa9792c23e10d54b8a0bade2?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">evuez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1689">December 27, 2016 at 10:44 am</a>		</div>

		<p>Being able to do an upsert is pretty cool, but with binary ids if I do an upsert on an existing row, the  returned struct contains a newly generated id instead of the existing one (which kinda makes sense but is not that useful). Is there a way to get the actual id back in the same query?</p>
<p>Thanks for the article anyway 🙂</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1690">
				<div id="div-comment-1690" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/07bc3491cdf0b573766ad5bfe80100fe?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/07bc3491cdf0b573766ad5bfe80100fe?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Hassan Zaki</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1690">December 27, 2016 at 12:09 pm</a>		</div>

		<p>Thanks for the great post.</p>
<p>There&#8217;s a missing &#8220;(&#8221; in insert_and_get_all/1</p>
<p>Repo.all(from t in MyApp.Tag, where: t.name in ^names)</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1691">
				<div id="div-comment-1691" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1691">December 27, 2016 at 12:51 pm</a>		</div>

		<p>If the database is not returning it, then there is nothing Ecto can do. :S</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1692">
				<div id="div-comment-1692" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1692">December 27, 2016 at 12:52 pm</a>		</div>

		<p>Fixed, thank you!</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1706">
				<div id="div-comment-1706" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/4b625d0a62a3ab4958de074f99470cb9?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/4b625d0a62a3ab4958de074f99470cb9?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Jesper Christiansen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1706">February 20, 2017 at 11:47 pm</a>		</div>

		<p>I&#8217;m a bit confused.. So for the creation of a new record, I provide a list of tags as a string &#8220;tag1, tag2&#8221; etc. But when I go to edit the post I just created, do I need to do something special for the tags? I get an error the second I load the /edit route. </p>
<p>  def edit(conn, %{&#8220;id&#8221; =&gt; id}) do<br>
    post = Repo.get!(Post, id)<br>
    |&gt; Repo.preload([:tags])</p>
<p>    changeset = Post.changeset(post)<br>
    render(conn, &#8220;edit.html&#8221;, post: post, changeset: changeset)<br>
  end</p>
<p>That gives me the following error on load:</p>
<p>  you are attempting to change relation :tags of App.Post, but there is missing data.<br>
  If you are attempting to update an existing entry, please make sure<br>
  you include the entry primary key (ID) alongside the data. etc etc etc</p>
<p>What am I doing wrong? :/</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1707">
				<div id="div-comment-1707" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/12/many-to-many-and-upserts/#comment-1707">February 21, 2017 at 7:18 am</a>		</div>

		<p>I believe we forgot this:</p>
<p>    many_to_many :tags, MyApp.Tag, join_through: &#8220;posts_tags&#8221;, on_replace: :delete</p>
<p>I.e. if you follow the instructions in your error message, it will mention about the `:on_replace` option and in this case we want to delete tags we no longer pass.</p>
<p>Thanks for the comment and let us know how it goes!</p>

		
				</div>
				</li>
<!-- #comment-## -->
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

        </div>

        <div class="pagination-section">
          <a href="/2016/12/nos-nao-somos-necessariamente-ageis-mas-com-certeza-somos-ageis/" rel="prev">Nós não somos necessariamente Ágeis&#8230; Mas com certeza somos ágeis!</a>          <a href="/2016/12/os-pros-e-contras-de-usar-metricas-diarias/" rel="next">Os prós e contras de usar métricas diárias</a>        </div>
        </div>
  <aside class="sidebar-container">
  <div class="sidebar-box sidebar-box-divider">
    <ul class="social-links">
      <li><a href="/feed/" class="social-link rss-link" title="Subscribe to our RSS" target="_blank">Subscribe to our RSS</a></li>
      <li><a href="http://twitter.com/plataformatec" class="social-link twitter-link" title="Follow us on Twitter" target="_blank">@plataformatec</a></li>
      <li><a href="https://github.com/plataformatec" class="social-link github-link" title="Check our code at GitHub" target="_blank">Plataformatec @ GitHub</a></li>
      <li><a href="http://facebook.com/plataformatec.com.br" class="social-link facebook-link" title="Check our Facebook page" target="_blank">Plataformatec @ Facebook</a></li>
      <li><a href="http://www.linkedin.com/company/plataformatec" class="social-link linkedin-link" title="Check our LinkedIn page" target="_blank">Plataformatec @ LinkedIn</a></li>
    </ul>
  </div>

  <div class="sidebar-box sidebar-box-divider">
    This is the company blog of <strong>Plataformatec</strong>, a software development and
    consultancy company, specialized in Elixir, Ruby and Agile.
  </div>

  <div class="sidebar-box">
    <ul class="post-list">
      <li class="post-list-item">
<a href="/category/english">Posts in english</a> (107)</li>
      <li class="post-list-item">
<a href="/category/portugues">Posts em português</a> (33)</li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Recent Posts</h3>

    <ul class="post-list">
                    <li class="post-list-item">
          <a href="/2020/01/important-information-about-our-elixir-and-ruby-open-source-projects/">Important information about our Elixir and Ruby Open Source projects</a>
        </li>
              <li class="post-list-item">
          <a href="/2020/01/elixir-what-about-tests/">Elixir: What about tests?</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/12/okr-licoes-aprendidas-para-voce-comecar-a-aplica-lo-de-forma-efetiva/">OKR: lições aprendidas para você começar a aplicá-lo de forma efetiva</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/divida-tecnica-por-que-fazer-quando-fazer-e-como-priorizar/">Dívida técnica: Por que fazer, quando fazer e como priorizar</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/relation-between-story-points-and-development-time-lead-time/">Relation between Story Points and Development Time (Lead Time)</a>
        </li>
          </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Read more about</h3>

    <ul class="post-list">
      <li class="post-list-item"><a href="/tag/open-source">Open Source</a></li>
      <li class="post-list-item"><a href="/tag/front-end">Front end</a></li>
      <li class="post-list-item"><a href="/tag/conference">Conferences</a></li>
      <li class="post-list-item"><a href="/tag/security-fix">Security fixes</a></li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Check our product</h3>
    <a class="sidebar-cta-link" href="https://sourcelevel.io/">
      <img src="/wp-content/themes/ptec/assets/sourcelevel-300.png" width="300" alt="SourceLevel - Analytics for Engineering Ops">
	</a>

    <p align="center">Analytics for Engineering Ops.</p>
  </div>

</aside>
      <footer class="site-footer">
        <p>
          <span class="footer-copy">© 2009- 2024 Plataformatec. All rights reserved.</span>

          <a href="http://plataformatec.com.br/">Our site</a> ·
          <a href="http://plataformatec.com.br/contact">Contact us</a> ·
          <a href="http://twitter.com/plataformatec">@plataformatec</a>
        </p>
      </footer>
    </div>
    <script type="text/javascript" src="/wp-content/themes/ptec/application.js?ver=6.4.2" id="application-js"></script>
  </body>
</html>