<!DOCTYPE html>
<html dir="ltr" lang="en-US" prefix="og: https://ogp.me/ns#">
<head>
  <meta charset="utf-8">
  <meta name="bitly-verification" content="b3acd9a47f4e">

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="emoji:root" content="/wp-content/themes/ptec">
  <meta name="theme-color" content="#cacaca">
  
    <meta name="bitly-verification" content="b3acd9a47f4e">
  <meta property="og:image" content="/wp-content/themes/ptec/assets/opengraph.png">
  <link rel="icon" sizes="192x192" href="/wp-content/themes/ptec/assets/icons/chrome-192x.png">
  <link rel="pingback" href="/xmlrpc.php">
  
		<!-- All in One SEO 4.5.4 - aioseo.com -->
		<title>Ecto‚Äôs insert_all and schemaless queries ¬´ Plataformatec Blog</title>
		<meta name="description" content="This blog post is about new features of Ecto 2.0: insert_all, schemaless queries, and how they lead you to think of Ecto as a tool instead of your domain layer.">
		<meta name="robots" content="max-image-preview:large">
		<link rel="canonical" href="/2016/05/ectos-insert_all-and-schemaless-queries/">
		<meta name="generator" content="All in One SEO (AIOSEO) 4.5.4">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="Plataformatec Blog | Plataformatec&#039;s place to talk about Ruby, Ruby on Rails, Elixir, and software engineering">
		<meta property="og:type" content="article">
		<meta property="og:title" content="Ecto‚Äôs insert_all and schemaless queries ¬´ Plataformatec Blog">
		<meta property="og:description" content="This blog post is about new features of Ecto 2.0: insert_all, schemaless queries, and how they lead you to think of Ecto as a tool instead of your domain layer.">
		<meta property="og:url" content="/2016/05/ectos-insert_all-and-schemaless-queries/">
		<meta property="article:published_time" content="2016-05-04T20:14:32+00:00">
		<meta property="article:modified_time" content="2017-01-16T21:13:30+00:00">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="Ecto‚Äôs insert_all and schemaless queries ¬´ Plataformatec Blog">
		<meta name="twitter:description" content="This blog post is about new features of Ecto 2.0: insert_all, schemaless queries, and how they lead you to think of Ecto as a tool instead of your domain layer.">
		<meta name="google" content="nositelinkssearchbox">
		<script type="application/ld+json" class="aioseo-schema">{"@context":"https:\/\/schema.org","@graph":[{"@type":"Article","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#article","name":"Ecto‚Äôs insert_all and schemaless queries ¬´ Plataformatec Blog","headline":"Ecto‚Äôs insert_all and schemaless queries","author":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author"},"publisher":{"@id":"http:\/\/blog.plataformatec.com.br\/#organization"},"image":{"@type":"ImageObject","url":"http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2016\/12\/CTA-blog-ebook-ecto-2-0.jpg","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#articleImage","width":831,"height":147,"caption":"What's new in Ecto 2.0 -- Download your copy"},"datePublished":"2016-05-04T17:14:32-03:00","dateModified":"2017-01-16T19:13:30-02:00","inLanguage":"en-US","commentCount":12,"mainEntityOfPage":{"@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#webpage"},"isPartOf":{"@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#webpage"},"articleSection":"English, ecto, elixir"},{"@type":"BreadcrumbList","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#breadcrumblist","itemListElement":[{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/#listItem","position":1,"name":"Home","item":"http:\/\/blog.plataformatec.com.br\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2016\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2016\/#listItem","position":2,"name":"2016","item":"http:\/\/blog.plataformatec.com.br\/2016\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2016\/05\/#listItem","previousItem":"http:\/\/blog.plataformatec.com.br\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/#listItem","position":3,"name":"May","item":"http:\/\/blog.plataformatec.com.br\/2016\/05\/","nextItem":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#listItem","previousItem":"http:\/\/blog.plataformatec.com.br\/2016\/#listItem"},{"@type":"ListItem","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#listItem","position":4,"name":"Ecto's insert_all and schemaless queries","previousItem":"http:\/\/blog.plataformatec.com.br\/2016\/05\/#listItem"}]},{"@type":"Organization","@id":"http:\/\/blog.plataformatec.com.br\/#organization","name":"Plataformatec Blog","url":"http:\/\/blog.plataformatec.com.br\/"},{"@type":"Person","@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author","url":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/","name":"Jos√© Valim","image":{"@type":"ImageObject","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#authorImage","url":"http:\/\/2.gravatar.com\/avatar\/e837f6b7fd146ab16ed3d663476c063e?s=96&d=mm&r=pg","width":96,"height":96,"caption":"Jos√© Valim"}},{"@type":"WebPage","@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#webpage","url":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/","name":"Ecto‚Äôs insert_all and schemaless queries ¬´ Plataformatec Blog","description":"This blog post is about new features of Ecto 2.0: insert_all, schemaless queries, and how they lead you to think of Ecto as a tool instead of your domain layer.","inLanguage":"en-US","isPartOf":{"@id":"http:\/\/blog.plataformatec.com.br\/#website"},"breadcrumb":{"@id":"http:\/\/blog.plataformatec.com.br\/2016\/05\/ectos-insert_all-and-schemaless-queries\/#breadcrumblist"},"author":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author"},"creator":{"@id":"http:\/\/blog.plataformatec.com.br\/author\/josevalim\/#author"},"datePublished":"2016-05-04T17:14:32-03:00","dateModified":"2017-01-16T19:13:30-02:00"},{"@type":"WebSite","@id":"http:\/\/blog.plataformatec.com.br\/#website","url":"http:\/\/blog.plataformatec.com.br\/","name":"Plataformatec Blog","description":"Plataformatec's place to talk about Ruby, Ruby on Rails, Elixir, and software engineering","inLanguage":"en-US","publisher":{"@id":"http:\/\/blog.plataformatec.com.br\/#organization"}}]}</script>
		<!-- All in One SEO -->


		<!-- Meta Tag Manager -->
		<meta name="twitter:label1" content="Plataformatec">
		<meta name="twitter:data1" content="Professional Consulting and Development for companies using Elixir or Ruby">
		<!-- / Meta Tag Manager -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Comments Feed" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Ecto&#8217;s insert_all and schemaless queries Comments Feed" href="/2016/05/ectos-insert_all-and-schemaless-queries/feed/">
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/blog.plataformatec.com.br\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.4.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"üè≥Ô∏è‚Äç‚ößÔ∏è","üè≥Ô∏è‚Äã‚ößÔ∏è")?!1:!n(e,"üá∫üá≥","üá∫‚Äãüá≥")&&!n(e,"üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø","üè¥‚ÄãÛ†Åß‚ÄãÛ†Å¢‚ÄãÛ†Å•‚ÄãÛ†ÅÆ‚ÄãÛ†Åß‚ÄãÛ†Åø");case"emoji":return!n(e,"ü´±üèª‚Äçü´≤üèø","ü´±üèª‚Äãü´≤üèø")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.4.2" type="text/css" media="all">
<style id="wp-block-library-inline-css" type="text/css">.has-text-align-justify{text-align:justify;}</style>
<link rel="stylesheet" id="mediaelement-css" href="/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.17" type="text/css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=6.4.2" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="webfont-css" href="//fonts.googleapis.com/css?family=Bree+Serif&#038;ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="main-css" href="/wp-content/themes/ptec/style.css?ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="tablepress-default-css" href="/wp-content/plugins/tablepress/css/build/default.css?ver=2.2.4" type="text/css" media="all">
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/5364">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.4.2">
<link rel="shortlink" href="/?p=5364">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2F2016%2F05%2Fectos-insert_all-and-schemaless-queries%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2F2016%2F05%2Fectos-insert_all-and-schemaless-queries%2F#038;format=xml">
</head>
  <body class="post-template-default single single-post postid-5364 single-format-standard">
    <div class="site-header">
      <div class="site-header-background">
        <header class="site-header-container">
          <h1 class="site-header-logo">
            <a href="/">
              <img src="/wp-content/themes/ptec/assets/plataformatec.svg" height="70" alt="The plataformatec logo">
            </a>
          </h1>

          <form class="header-search-form" method="GET" action="/">
            <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
          </form>

          <ul class="site-nav">
            <li class="site-nav-item"><a href="http://plataformatec.com.br/services">Services</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/playbook">Playbook</a></li>
            <li class="site-nav-item handheld-hidden"><a href="http://plataformatec.com.br/forge">Forge</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/careers">Careers</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/contact">Contact</a></li>
          </ul>
        </header>
      </div>
      <nav class="header-nav">
        <input type="checkbox" id="nav-toggle-checkbox" class="header-nav-checkbox">
        <label for="nav-toggle-checkbox" class="header-nav-toggle">Topics we write about</label>

        <ul class="header-nav-list" itemscope itemtype="http://schema.org/SiteNavigationElement">
          <li class="header-nav-item header-search-nav-item">
            <form class="header-nav-search-form" method="GET" action="/">
              <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
            </form>
          </li>
                    <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/elixir" itemprop="url">Elixir</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/rails" itemprop="url">Ruby on Rails</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/devise" itemprop="url">Devise</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/simple_form" itemprop="url">Simple Form</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/agile" itemprop="url">Agile</a>
          </li>
        </ul>
      </nav>
    </div>
<div class="site-container">
  <div class="page-container">
                  <section class="post-section">
  <header class="post-header">
    <h1 class="post-title">
      <a href="/2016/05/ectos-insert_all-and-schemaless-queries/" rel="bookmark">Ecto&#8217;s insert_all and schemaless queries</a>
    </h1>
          <time class="post-date-ribbon" datetime="2016-05-04T17:14:32-03:00">May 4, 2016</time>
      <p class="post-author">
        <img alt="" src="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">        Written by <a href="/?author=4" title="Posts by Jos√© Valim">Jos√© Valim</a>.
      </p>
        </header>

      <article class="post-body">
      <p>One of the functions added to Ecto 2.0 is <a href="https://hexdocs.pm/ecto/2.0.0-rc.1/Ecto.Repo.html#c:insert_all/3"><code>Ecto.Repo.insert_all/3</code></a>. <code>insert_all</code> allows developers to insert multiple entries at once into a repository:</p>
<pre><code class="elixir">MyApp.Repo.insert_all(Post, [[title: "hello", body: "world"],
                             [title: "another", body: "post"]])
</code></pre>
<p>Although <code>insert_all</code> is just a regular Elixir function, it plays an important role in Ecto 2.0 goals. To understand more about these goals, let&#8217;s talk about Ecto schemas.</p>
<h2>The trouble with schemas</h2>
<p>Conceptually speaking, Ecto 2.0 is quite different from Ecto 1.0 as it moves to a more data-oriented approach. We want developers to think of Ecto as a tool instead of their domain layer. One important decision in this direction was the removal of <code>Ecto.Model</code> in favor of <code>Ecto.Schema</code>.</p>
<p>At this point, it is worth asking: what are schemas?</p>
<p>Ecto schemas are used to map <em>any</em> data source into an Elixir struct. Schemas are useful because they give shape to external data and enforce its types:</p>
<pre><code class="elixir">defmodule Post do
  use Ecto.Schema

  schema "posts" do
    field :title
    field :body
    field :votes, :integer, default: 0
    timestamps
  end
end
</code></pre>
<p>One possible benefit of using schemas is that you define the shape of the data once and you can use this shape to retrieve data from the database as well as coordinate changes happening on the data. For example:</p>
<pre><code class="elixir">params = [title: "new title", votes: "0"]

Post
|&gt; MyApp.Repo.get!(13)
|&gt; Ecto.Changeset.cast(params, [:title, :votes])
|&gt; MyApp.Repo.update!
</code></pre>
<p>By relying on the schema information, Ecto knows the shape of the data when it reads from the database and know how to manage changes. In the example above, the &#8220;votes&#8221; field was automatically cast from string to an integer based on its schema type.</p>
<p>While the benefits of schemas are known, we don&#8217;t talk as frequently about the downsides of schemas: which is exactly the coupling of the database representation to your application, leading developers to represent both reads and writes operations on top of the same structure.</p>
<p>With schemaless queries, we get direct access to all underlying database operations, allowing us to perform both reads and writes operations without being coupled to a schema.</p>
<h2>Schemaless queries</h2>
<p>Ecto 2.0 allows read, create, update and delete operations to be done without a schema. <code>insert_all</code> was the last piece of the puzzle. Let&#8217;s see some examples.</p>
<p>If you are writing a reporting view, it may be counter-productive to think how your existing application schemas relate to the report being generated. It is often simpler to write a query that returns only the data you need, without taking schemas into account:</p>
<pre><code class="elixir">import Ecto.Query

def running_activities(start_at, end_at)
  MyApp.Repo.all(
    from u in "users",
      join: a in "activities",
      on: a.user_id == u.id,
      where: a.start_at &gt; type(^start_at, Ecto.DateTime) and
             a.end_at &lt; type(^end_at, Ecto.DateTime),
      group_by: a.user_id,
      select: %{user_id: a.user_id, interval: a.start_at - a.end_at, count: count(u.id)}
  )
end
</code></pre>
<p>The function above does not care about your schemas. It returns only the data that matters for building the report. Notice how we use the <code>type/2</code> function to specify what is the expected type of the argument we are interpolating, allowing us to benefit from the same type casting guarantees a schema would give.</p>
<p>Inserts, updates and deletes can also be done without schemas via <code>insert_all</code>, <code>update_all</code> and <code>delete_all</code> respectively:</p>
<pre><code class="elixir"># Insert data into posts and return its ID
[%{id: id}] =
  MyApp.Repo.insert_all "posts", [[title: "hello"]], returning: [:id]

# Use the ID to trigger updates
post = from p in "posts", where: p.id == ^id
{1, _} = MyApp.Repo.update_all post, set: [title: "new title"]

# As well as for deletes
{1, _} = MyApp.Repo.delete_all post
</code></pre>
<p>It is not hard to see how these operations directly map to their SQL variants, keeping the database at your fingertips without the need to intermediate all operations through schemas.</p>
<h2>Schemas are mappers</h2>
<p>When we defined schemas above, we said:</p>
<blockquote><p>
  Ecto schemas are used to map <em>any</em> data source into an Elixir struct.
</p></blockquote>
<p>We put emphasis on <em>any</em> because it is a common misconception to think Ecto schemas map only to your database tables.</p>
<p>For instance, when you write a web application using Phoenix and you use Ecto to receive external changes and apply such changes to your database, we are actually mapping the schema to two different sources:</p>
<pre><code>Database &lt;-&gt; Ecto schema &lt;-&gt; Forms / API
</code></pre>
<p>It is important to understand how the schema is sitting between your database and your API because in many situations it is better to break this mapping in two. Let&#8217;s see some practical examples.</p>
<p>Imagine you are working with a client that wants the &#8220;Sign Up&#8221; form to contain the fields &#8220;First name&#8221;, &#8220;Last name&#8221; along side &#8220;E-mail&#8221; and other information. You know there are a couple problems with this approach.</p>
<p>First of all, not everyone has a first and last name. Although your client is decided on presenting both fields, they are a UI concern, and you don&#8217;t want the UI to dictate the shape of your data. Furthermore, you know it would be useful to break the &#8220;Sign Up&#8221; information across two tables, the &#8220;accounts&#8221; and &#8220;profiles&#8221; tables.</p>
<p>Given the requirements above, how would we implement the Sign Up feature in the backend?</p>
<p>One approach would be to have two schemas, Account and Profile, with virtual fields such as <code>first_name</code> and <code>last_name</code>, and <a href="/2015/08/working-with-ecto-associations-and-embeds/">use associations along side nested forms</a> to tie the schemas to your UI. One of such schemas would be:</p>
<pre><code class="elixir">defmodule Profile do
  use Ecto.Schema

  schema "profiles" do
    field :name
    field :first_name, :string, virtual: true
    field :last_name, :string, virtual: true
    ...
  end
end
</code></pre>
<p>It is not hard to see how we are polluting our Profile schema with UI requirements by adding fields such <code>first_name</code> and <code>last_name</code>. If the Profile schema is used for both reading and writing data, it may end-up in an awkward place where it is not useful for any, as it contains fields that map just to one or the other operation.</p>
<p>One alternative solution is to break the &#8220;Database  Ecto schema  Forms / API&#8221; mapping in two parts. The first will cast and validate the external data with its own structure which you then transform and write to the database. For such, let&#8217;s define a schema named <code>Registration</code> that will take care of casting and validating the form data exclusively, mapping directly to the UI fields:</p>
<pre><code class="elixir">defmodule Registration do
  use Ecto.Schema

  embedded_schema do
    field :first_name
    field :last_name
    field :email
  end
end
</code></pre>
<p>We used <code>embedded_schema</code> because it is not our intent to persist it anywhere. With the schema in hand, we can use Ecto changesets and validations to process the data:</p>
<pre><code class="elixir">fields = [:first_name, :last_name, :email]

changeset =
  %Registration{}
  |&gt; Ecto.Changeset.cast(params["sign_up"], fields)
  |&gt; validate_required(...)
  |&gt; validate_length(...)
</code></pre>
<p>Now that the registration changes are mapped and validated, we can check if the resulting changeset is valid and act accordingly:</p>
<pre><code class="elixir">if changeset.valid? do
  # Get the modified registration struct out of the changeset
  registration = Ecto.Changeset.apply_changes(changeset)

  MyApp.Repo.transaction fn -&gt;
    MyApp.Repo.insert_all "accounts", Registration.to_account(registration)
    MyApp.Repo.insert_all "profiles", Registration.to_profile(registration)
  end

  {:ok, registration}
else
  # Annotate the action we tried to perform so the UI shows errors
  changeset = %{changeset | action: :registration}
  {:error, changeset}
end
</code></pre>
<p>The <code>to_account/1</code> and <code>to_profile/1</code> functions in <code>Registration</code> would receive the registration struct and split the attributes apart accordingly:</p>
<pre><code class="elixir">def to_account(registration) do
  Map.take(registration, [:email])
end

def to_profile(%{first_name: first, last_name: last}) do
  %{name: "#{first} #{last}"}
end
</code></pre>
<p>In the example above, by breaking apart the mapping between the database and Elixir and between Elixir and the UI, our code becomes clearer and our data-structures simpler.</p>
<p>Note we have used <code>MyApp.Repo.insert_all/2</code> to add data to both &#8220;accounts&#8221; and &#8220;profiles&#8221; tables directly. We have chosen to bypass schemas altogether. However, there is nothing stopping you from also defining both <code>Account</code> and <code>Profile</code> schemas and changing <code>to_account/1</code> and <code>to_profile/1</code> to respectively return <code>%Account{}</code> and <code>%Profile{}</code> structs. Once structs are returned, they could be inserted through the usual <code>Repo.insert/2</code> operation.</p>
<p>Similarly, we chose to define a <code>Registration</code> schema to use in the changeset but Ecto 2.0 also allows developers to use changesets without schemas. We can dynamically define the data and their types. Let&#8217;s rewrite the registration changeset above to bypass schemas:</p>
<pre><code class="elixir">data  = %{}
types = %{first_name: :string, last_name: :string, email: :string}

changeset =
  {data, types} # The data+types tuple is equivalent to %Registration{}
  |&gt; Ecto.Changeset.cast(params["sign_up"], Map.keys(types))
  |&gt; validate_required(...)
  |&gt; validate_length(...)
</code></pre>
<p>You can use this technique to validate API endpoints, search forms, and other sources of data. The choice of using schemas depends mostly if you want to use the same mapping in different places and/or if you desire the compile-time guarantees Elixir structs gives you. Otherwise, you can bypass schemas altogether, be it when using changesets or interacting with the repository.</p>
<h2>Summary</h2>
<p>Ecto 2.0 introduces <code>insert_all</code> that directly inserts data into a given table. <code>insert_all</code>, alongside <code>all</code>, <code>update_all</code> and <code>delete_all</code>, allows developers to work closer to the database without the need for using schemas.</p>
<p>Such possibilities make Ecto 2.0 a substantial departure from earlier versions, as developers can focus more on how their data map to different domains, like the database and the UI, relying on Ecto as a tool to interact with each of those domains in the best possible way.</p>
<hr style="margin-top:30px">
<p><em>This article was extracted from an ebook <del datetime="2017-01-16T20:59:19+00:00">we&#8217;re writing</del> we&#8217;ve written on What&#8217;s new in Ecto 2.0. <a href="http://pages.plataformatec.com.br/ebook-whats-new-in-ecto-2-0?utm_source=our-blog&#038;utm_medium=referral&#038;utm_campaign=ebook-ecto-2-0&#038;utm_content=link-blog-post-text-bottom">Click here</a> to receive a copy of the ebook now <del datetime="2017-01-16T20:59:19+00:00">when it&#8217;s ready</del>.</em></p>
<p><a href="http://pages.plataformatec.com.br/ebook-whats-new-in-ecto-2-0?utm_source=our-blog&#038;utm_medium=referral&#038;utm_campaign=ebook-ecto-2-0&#038;utm_content=cta-blog-post-bottom" target="_blank"><br>
<img fetchpriority="high" decoding="async" src="/wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0.jpg" alt="What&#039;s new in Ecto 2.0 -- Download your copy" width="831" height="147" class="aligncenter size-full wp-image-5997" srcset="/wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0.jpg 831w, /wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0-300x53.jpg 300w, /wp-content/uploads/2016/12/CTA-blog-ebook-ecto-2-0-768x136.jpg 768w" sizes="(max-width: 831px) 100vw, 831px"><br>
</a></p>
    </article>
  
      <p class="post-metadata">
      Tags: <a href="/tag/ecto/" rel="tag">ecto</a>, <a href="/tag/elixir/" rel="tag">elixir</a>, Posted in <a href="/category/english/" rel="category tag">English</a>,   <a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comments"><span class="dsq-postid" data-dsqidentifier="5364 http://blog.plataformatec.com.br/?p=5364">12 Comments &#187;</span></a>    </p>
  </section>

        <div class="comments-thread">
          
<!-- You can start editing here. -->

	<h3 id="comments">
		12 responses to &#8220;Ecto&#8217;s insert_all and schemaless queries&#8221;	</h3>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

	<ol class="commentlist">
			<li class="comment even thread-even depth-1" id="comment-1606">
				<div id="div-comment-1606" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/e864e5088627498df8f9b911a9bc3219?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e864e5088627498df8f9b911a9bc3219?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">			<cite class="fn"><a href="http://solnic.eu/" class="url" rel="ugc external nofollow">solnic</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1606">May 5, 2016 at 11:25 am</a>		</div>

		<p>Congratulations on the amazing progress with Ecto 2.0. Seeing this changes makes me very happy.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1607">
				<div id="div-comment-1607" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1607">May 5, 2016 at 12:32 pm</a>		</div>

		<p>Your input played a big part in this, so thank you for the great feedback. üôÇ</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1608">
				<div id="div-comment-1608" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://1.gravatar.com/avatar/140d98f438d1447366e08e82bae609ed?s=32&#038;d=mm&#038;r=pg" srcset="https://1.gravatar.com/avatar/140d98f438d1447366e08e82bae609ed?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Andrea Rossi</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1608">May 5, 2016 at 1:29 pm</a>		</div>

		<p>I&#8217;m amazed at how fantastically decoupled Ecto feels in all its aspect, especially in regards to databases. The whole &#8220;use it to map stuff to whatever you want&#8221; concept is truly exceptional. Fantastic work, and excited to follow its development! üëèüèª</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1609">
				<div id="div-comment-1609" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/e864e5088627498df8f9b911a9bc3219?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e864e5088627498df8f9b911a9bc3219?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://solnic.eu/" class="url" rel="ugc external nofollow">solnic</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1609">May 6, 2016 at 4:52 am</a>		</div>

		<p>Awesome to hear üôÇ We should collaborate more, there are *lots* of similarities between Ecto 2.0 and rom-rb projects. Right now I&#8217;m interested in introducing Changeset API similar to what you have, just not sure where it will fit in the stack yet (closer to persistence, or closer to domain layer, or maybe actually both?). I&#8217;m also curious to look deeper into how you implemented validations, esp. wrt ditching classic uniqueness checks in favor of constraints-only approach (which is what I did as well *initially* in rom-rb and then we decided to remove it and use classic approach, but maybe we should revisit).</p>
<p>Keep up the good work, can&#8217;t wait to use Ecto 2.0 in the real world now.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1610">
				<div id="div-comment-1610" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1610">May 6, 2016 at 6:20 am</a>		</div>

		<p>&gt; Right now I&#8217;m interested in introducing Changeset API similar to what you have, just not sure where it will fit in the stack yet</p>
<p>I believe changesets will actually be simpler to implement in Ruby in a way it can map to both parts of the stack. Today changesets in Ecto has both, it has all of the functionality for working on the domain layer (casting, validations, etc) as well as functions for working on the persistence layer (for example, constraints).</p>
<p>Ideally, those two should be kept apart but this would mean having two modules in Ecto: Ecto.Changeset and, let&#8217;s say, &#8220;Ecto.Persistenceset&#8221;. I decided to not do such to avoid splitting the functions in two different modules since it has its own costs in maintenance, discoverability, etc.</p>
<p>In Ruby, because of duck typing, you can easily implement both. The persistence one may inherit all of the functionality from the regular changeset.</p>
<p>Other than that, the changeset contract in Ecto is very simple: it just calls a `__changeset__` function in the struct module which returns its types. The data plus the types are all you need.</p>
<p>&gt; I&#8217;m also curious to look deeper into how you implemented validations, esp. wrt ditching classic uniqueness checks in favor of constraints-only approach</p>
<p>In Ecto it works by storing constraints in the changeset. I think it helps a lot that the same module that provides validations in Ecto is the one that provides constraints (see comments above).</p>
<p>Implementation wise, we store in the changeset the constraint name you expect to fail, the type of the constraint (unique, check, etc) and the message we&#8217;d add as error in case the constraint is violated. In case the database operation fails due to a constraint, the adapter converts the error into data:</p>
<p><a href="https://github.com/elixir-lang/ecto/blob/37f9a05c3cb5e48d10d1a5c55bcaeaaa18b1c077/lib/ecto/adapters/postgres/connection.ex#L28-L35" rel="nofollow ugc">https://github.com/elixir-lang/ecto/blob/37f9a05c3cb5e48d10d1a5c55bcaeaaa18b1c077/lib/ecto/adapters/postgres/connection.ex#L28-L35</a></p>
<p>Then Ecto checks if the violated constraint was declared in the changeset and if so, add its error message to `changeset.errors`. In case the violated constraint does not belong to the changeset, we raise a nice error message:</p>
<p><a href="https://github.com/elixir-lang/ecto/blob/37f9a05c3cb5e48d10d1a5c55bcaeaaa18b1c077/lib/ecto/adapters/postgres/connection.ex#L37-L61" rel="nofollow ugc">https://github.com/elixir-lang/ecto/blob/37f9a05c3cb5e48d10d1a5c55bcaeaaa18b1c077/lib/ecto/adapters/postgres/connection.ex#L37-L61</a></p>
<p>There are a couple things to consider. First, not all databases make it easy to parse the reason the constraint failed. For example, in Postgres 9.2 and earlier, you need to parse error messages:</p>
<p><a href="https://github.com/elixir-lang/ecto/blob/37f9a05c3cb5e48d10d1a5c55bcaeaaa18b1c077/lib/ecto/adapters/postgres/connection.ex#L37-L61" rel="nofollow ugc">https://github.com/elixir-lang/ecto/blob/37f9a05c3cb5e48d10d1a5c55bcaeaaa18b1c077/lib/ecto/adapters/postgres/connection.ex#L37-L61</a></p>
<p>Databases like SQLite3 do not provide this information at all. You basically can&#8217;t implement this functionality there (afaik). Finally, you need to be careful with transactions, if an operation like insert or update fails inside a transaction due to constraints, all other operations will error. Ecto has a quite explicit approach to transactions, so that&#8217;s less of an issue, but depending on how developers expect transactions to work it may be surprising.</p>
<p>I hope this give some initial direction on how those features are implemented in Ecto but you are welcome to ping me any time!</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1615">
				<div id="div-comment-1615" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/e864e5088627498df8f9b911a9bc3219?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e864e5088627498df8f9b911a9bc3219?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://solnic.eu/" class="url" rel="ugc external nofollow">solnic</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1615">May 16, 2016 at 7:25 am</a>		</div>

		<p>Thanks for reply! I feel like we should revisit db constraint error handling. Our conclusion was that swallowing low level db errors and presenting them as high-level errors will cause more damage than give benefits, so it&#8217;s gonna be interesting to see how it&#8217;s gonna work for you with Ecto. Looking forward to hearing more about real world usage of this feature.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1619">
				<div id="div-comment-1619" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://1.gravatar.com/avatar/7c0ef61253e572b40a9cc506df9d8b27?s=32&#038;d=mm&#038;r=pg" srcset="https://1.gravatar.com/avatar/7c0ef61253e572b40a9cc506df9d8b27?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Ernesto Cambust√≥n</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1619">May 21, 2016 at 8:52 pm</a>		</div>

		<p>I was playing with schemaless queries. I have a requirement in which a customer needs to define a table, and 2 fields at runtime. For example. I was trying to do a query that looks like:<br>
&#8220;`<br>
 from r in &#8220;#{table}&#8221;, limit: 1, select: %{ r.&#8221;#{field_1}&#8221;, r.&#8221;#{field2}&#8221; }<br>
&#8220;`<br>
&#8230;.   I guess the metaprogramming behind the DSL makes the compiler cry, but it would be a nice feature to have. Is there any workaround for this?    I would love to avoid implementing a query for each adapter I want to support.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1620">
				<div id="div-comment-1620" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://1.gravatar.com/avatar/7c0ef61253e572b40a9cc506df9d8b27?s=32&#038;d=mm&#038;r=pg" srcset="https://1.gravatar.com/avatar/7c0ef61253e572b40a9cc506df9d8b27?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Ernesto Cambust√≥n</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1620">May 21, 2016 at 10:05 pm</a>		</div>

		<p>solved it by modifying my select to:<br>
&#8220;`<br>
select: map(r, [:field1, :field2])<br>
&#8220;`</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1621">
				<div id="div-comment-1621" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://0.gravatar.com/avatar/c7f73bc5e5115a88737f5adb6d1ffefc?s=32&#038;d=mm&#038;r=pg" srcset="https://0.gravatar.com/avatar/c7f73bc5e5115a88737f5adb6d1ffefc?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Timur</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1621">May 23, 2016 at 3:26 am</a>		</div>

		<p>Glad to see Ecto is going to the next level! I&#8217;d like to share some thoughts from my pythonic point of view.</p>
<p>When I need to deserialize some HTTP form data into a Python data structure, I use colander, a library which doesn&#8217;t have anything to do with database, to define a schema, declaratively or imperatively, which takes care of type conversion and validation. The same colander schema may be used to serialize a data structure back into HTTP form.</p>
<p>When I need something like Ecto&#8217;s insert_all/3, I use SQLAlchemy core API to define a table object, build an insert query with it and then execute the query providing a list of data structures. SQLAlchemy takes care of type conversion and I don&#8217;t have to use anything like type/2 because table definition already contains column types and I&#8217;ll just use the same standard Python datetime objects that I got after deserialization.</p>
<p>If I want an object-oriented domain model, I use SQLAlchemy ORM which is build on top of SQLAlchemy core and allows me to map my objects to tables.</p>
<p>Now I see that Ecto tries to combine input deserialization/validation with data source access layer which goes against my instincts.</p>
<p>Also, type/2 seems like duplicating type specification by spreading it all over the code instead of defining in one place, the schema. After all the data source already knows the type and even if it&#8217;s schemaless we may  still enforce it at the data access library level if we really want.</p>
<p>Where am I missing the point?</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1622">
				<div id="div-comment-1622" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="/" class="url" rel="ugc">josevalim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1622">May 23, 2016 at 5:32 am</a>		</div>

		<p>Hi Timur!</p>
<p>&gt; When I need to deserialize some HTTP form data into a Python data structure, I use colander</p>
<p>This would be equivalent to Ecto Changeset. You would define the initial data, the types, and the changeset takes care of validating the input, casting parameters, and give you the parsed and validated data afterwards.</p>
<p>&gt; When I need something like Ecto&#8217;s insert_all/3, I use SQLAlchemy core API to define a table object, build an insert query with it and then execute the query providing a list of data structures. </p>
<p>For talking to the database, you use the Ecto repository and queries. Our insert expects a key-value data-structure in contrast to building an insert query and providing a list of parameters. You are free to map, filter and modify the data in any way before giving it to &#8220;insert_all&#8221;.</p>
<p>&gt; Also, type/2 seems like duplicating type specification by spreading it all over the code instead of defining in one place, the schema. </p>
<p>You only need to use type/2 if you are building a query without a schema (i.e. without specifying the types). If you provide a schema then you don&#8217;t need to repeat this information.</p>
<p>&gt; Now I see that Ecto tries to combine input deserialization/validation with data source access layer which goes against my instincts.</p>
<p>The idea of this blog post is to show exactly this is not the case. If you define an Ecto schema, as mentioned above, then you can use the same schema (i.e. the same type information) for both input deserialization and data source layers but there is nothing in Ecto forcing you to do it. If you want to break it apart and first deserialize the data using certain schema and then convert the data into something else that you insert into the data store, using a different schema or using just pure Elixir data, you are free to do so.</p>
<p>Now is my turn: where did I miss the point? üôÇ</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1624">
				<div id="div-comment-1624" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://0.gravatar.com/avatar/c7f73bc5e5115a88737f5adb6d1ffefc?s=32&#038;d=mm&#038;r=pg" srcset="https://0.gravatar.com/avatar/c7f73bc5e5115a88737f5adb6d1ffefc?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Timur</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1624">May 24, 2016 at 5:37 am</a>		</div>

		<p>Jose, thanks for discarding my concerns! üôÇ Now I see it was just my ignorance of Ecto.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1639">
				<div id="div-comment-1639" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://2.gravatar.com/avatar/2f194946150680be90b6ad571965f68d?s=32&#038;d=mm&#038;r=pg" srcset="https://2.gravatar.com/avatar/2f194946150680be90b6ad571965f68d?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Lance Johnson</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2016/05/ectos-insert_all-and-schemaless-queries/#comment-1639">July 19, 2016 at 9:26 pm</a>		</div>

		<p>Thank you for these changes and for the example of using changeset with {data, types}. It was extremely helpful and exactly what I needed for our current project.</p>

		
				</div>
				</li>
<!-- #comment-## -->
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

        </div>

        <div class="pagination-section">
          <a href="/2016/04/running-migration-in-an-exrm-release/" rel="prev">Running migration in an Exrm release</a>          <a href="/2016/05/tracing-and-observing-your-remote-node/" rel="next">Tracing and observing your remote node</a>        </div>
        </div>
  <aside class="sidebar-container">
  <div class="sidebar-box sidebar-box-divider">
    <ul class="social-links">
      <li><a href="/feed/" class="social-link rss-link" title="Subscribe to our RSS" target="_blank">Subscribe to our RSS</a></li>
      <li><a href="http://twitter.com/plataformatec" class="social-link twitter-link" title="Follow us on Twitter" target="_blank">@plataformatec</a></li>
      <li><a href="https://github.com/plataformatec" class="social-link github-link" title="Check our code at GitHub" target="_blank">Plataformatec @ GitHub</a></li>
      <li><a href="http://facebook.com/plataformatec.com.br" class="social-link facebook-link" title="Check our Facebook page" target="_blank">Plataformatec @ Facebook</a></li>
      <li><a href="http://www.linkedin.com/company/plataformatec" class="social-link linkedin-link" title="Check our LinkedIn page" target="_blank">Plataformatec @ LinkedIn</a></li>
    </ul>
  </div>

  <div class="sidebar-box sidebar-box-divider">
    This is the company blog of <strong>Plataformatec</strong>, a software development and
    consultancy company, specialized in Elixir, Ruby and Agile.
  </div>

  <div class="sidebar-box">
    <ul class="post-list">
      <li class="post-list-item">
<a href="/category/english">Posts in english</a> (107)</li>
      <li class="post-list-item">
<a href="/category/portugues">Posts em portugu√™s</a> (33)</li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Recent Posts</h3>

    <ul class="post-list">
                    <li class="post-list-item">
          <a href="/2020/01/important-information-about-our-elixir-and-ruby-open-source-projects/">Important information about our Elixir and Ruby Open Source projects</a>
        </li>
              <li class="post-list-item">
          <a href="/2020/01/elixir-what-about-tests/">Elixir: What about tests?</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/12/okr-licoes-aprendidas-para-voce-comecar-a-aplica-lo-de-forma-efetiva/">OKR: li√ß√µes aprendidas para voc√™ come√ßar a aplic√°-lo de forma efetiva</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/divida-tecnica-por-que-fazer-quando-fazer-e-como-priorizar/">D√≠vida t√©cnica: Por que fazer, quando fazer e como priorizar</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/relation-between-story-points-and-development-time-lead-time/">Relation between Story Points and Development Time (Lead Time)</a>
        </li>
          </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Read more about</h3>

    <ul class="post-list">
      <li class="post-list-item"><a href="/tag/open-source">Open Source</a></li>
      <li class="post-list-item"><a href="/tag/front-end">Front end</a></li>
      <li class="post-list-item"><a href="/tag/conference">Conferences</a></li>
      <li class="post-list-item"><a href="/tag/security-fix">Security fixes</a></li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Check our product</h3>
    <a class="sidebar-cta-link" href="https://sourcelevel.io/">
      <img src="/wp-content/themes/ptec/assets/sourcelevel-300.png" width="300" alt="SourceLevel - Analytics for Engineering Ops">
	</a>

    <p align="center">Analytics for Engineering Ops.</p>
  </div>

</aside>
      <footer class="site-footer">
        <p>
          <span class="footer-copy">¬© 2009- 2024 Plataformatec. All rights reserved.</span>

          <a href="http://plataformatec.com.br/">Our site</a> ¬∑
          <a href="http://plataformatec.com.br/contact">Contact us</a> ¬∑
          <a href="http://twitter.com/plataformatec">@plataformatec</a>
        </p>
      </footer>
    </div>
    <script type="text/javascript" src="/wp-content/themes/ptec/application.js?ver=6.4.2" id="application-js"></script>
  </body>
</html>