{"id":2804,"date":"2012-06-12T10:25:39","date_gmt":"2012-06-12T13:25:39","guid":{"rendered":"http:\/\/blog.plataformatec.com.br\/?p=2804"},"modified":"2012-06-12T10:25:39","modified_gmt":"2012-06-12T13:25:39","slug":"improving-the-integration-between-capybara-and-rspec","status":"publish","type":"post","link":"https:\/\/blog.plataformatec.com.br\/2012\/06\/improving-the-integration-between-capybara-and-rspec\/","title":{"rendered":"Improving the integration between Capybara and RSpec"},"content":{"rendered":"<p>When David Chelimsky was visiting S\u00e3o Paulo in last April, we invited him to go out for some coffee, beers and brazilian appetizers. We had a great time and we talked about different topics like OO, programming languages, authoring books and, as expected, about testing.<\/p>\n<p>One of the topics in our testing discussion was the current confusion in rspec-rails request specs when using Capybara. There is an open issue for this in <a href=\"https:\/\/github.com\/rspec\/rspec-rails\/issues\/406\" target=\"_blank\">rspec-rails&#8217; issues tracker<\/a> and discussing it personally allowed us to talk about some possible solutions, which could take months in internet time. \ud83d\ude42<\/p>\n<p>rspec-rails is a gem that wraps Rails testing behaviors into RSpec&#8217;s example groups. For example, <a href=\"https:\/\/github.com\/rspec\/rspec-rails\/blob\/master\/lib\/rspec\/rails\/example\/controller_example_group.rb#L9\" target=\"_blank\">the controller example group is based on <code>ActionController::TestCase::Behavior<\/code><\/a>. There are also example groups for views, helpers and so forth, but for now we are interested in the request example group, which <a href=\"https:\/\/github.com\/rspec\/rspec-rails\/blob\/master\/lib\/rspec\/rails\/example\/request_example_group.rb#L5\" target=\"_blank\">is as a wrapper for <code>ActionDispatch::Integration::Runner<\/code><\/a>. The Rails&#8217; integration runner is built on top of <code>rack-test<\/code>, a great small gem that adds support to methods like <code>get<\/code>, <code>post<\/code>, <code>put<\/code> and <code>delete<\/code> and handle the rack request and response objects.<\/p>\n<p>This setup with the request example group running on top of Rails&#8217; Integration Runner works fine until you add Capybara to your application (which is always a good idea). The issue is that <a href=\"https:\/\/github.com\/jnicklas\/capybara\/blob\/master\/lib\/capybara\/rspec.rb#L8\" target=\"_blank\">Capybara by default includes its DSL in the same request example group<\/a> and that&#8217;s when the confusion starts.<\/p>\n<p>Capybara, being an acceptance test framework, does not expose low-level details like a request or response object. In order to access a web page using Capybara, the developer needs to use the method <code>visit<\/code> (instead of <code>get<\/code>). To read the accessed page body, the developer must use <code>page<\/code> instead of manipulating the <code>response<\/code>.<\/p>\n<p>However, since both Capybara DSL and Rails&#8217; Integration Runner are included in the same example group, both methods <code>visit<\/code> and <code>get<\/code> are available! Not only that, even if I visit a web page using Capybara&#8217;s <code>visit<\/code>, I can still access the request and response object that comes from Rails, except that they will be blank since Capybara uses a completely different stack to access the application.<\/p>\n<p><a href=\"http:\/\/stackoverflow.com\/questions\/7260720\/rspec2-and-capybara\" target=\"_blank\">This confusion not only happens inside each test<\/a> but it also leads to a poor testing suite. I have seen many, many files inside <code>spec\/requests<\/code> that mixes both syntaxes.<\/p>\n<p>Talking to David, I have expressed a possible solution to this problem based on how we have been building applications at Plataformatec. First of all, we start by having two directories: <code>spec\/requests<\/code> and <code>spec\/acceptance<\/code>. Since both are supported by Capybara, this (mostly) works out of the box.<\/p>\n<p>Everything you want to test from the user\/browser perspective goes under <code>spec\/acceptance<\/code>. So if you want to test that by filling the body and the title fields and pressing the button &#8220;Publish&#8221; publishes a new blog post, you will test that under acceptance (protip: we usually have subdirectories inside <code>spec\/acceptance<\/code> based on the application roles, like <code>spec\/acceptance\/guest<\/code>, <code>spec\/acceptance\/admin<\/code>, etc).<\/p>\n<p>Everything under <code>spec\/requests<\/code> applies to the inner working of your application. Is it returning the proper http headers? Is this route streaming the correct JSON response? Also, <a href=\"http:\/\/elabs.se\/blog\/34-capybara-and-testing-apis\" target=\"_blank\">since APIs are not part of the user\/browser perspective, they are also tested under <code>spec\/requests<\/code> and not under <code>spec\/acceptance<\/code><\/a>.<\/p>\n<p>This separation of concerns already helps solving the confusion above. Under <code>spec\/acceptance<\/code>, you should use only Capybara helpers. Inside <code>spec\/requests<\/code>, you are using Rails provided tools. However, this does not solve the underlying problem that both helpers are still included in <code>spec\/requests<\/code>.<\/p>\n<p>Therefore, while this blog post means to provide some guidance for those that run into such problems, we also would like to propose a solution that we discussed with David. The solution goes like this:<\/p>\n<p>1) We change RSpec to no longer generate <code>spec\/requests<\/code>, but both <code>spec\/api<\/code> and <code>spec\/features<\/code> (I have proposed <code>spec\/acceptance<\/code> but David pointed out those are not strictly speaking acceptance tests). The Capybara DSL (<code>visit<\/code>, <code>page<\/code> and friends) should not be included in <code>spec\/api<\/code> under any circumstance.<\/p>\n<p>2) We change Capybara to include by default its DSL and RSpec matchers under <code>spec\/features<\/code> and change the <a href=\"https:\/\/github.com\/jnicklas\/capybara\/blob\/master\/lib\/capybara\/rspec\/features.rb#L15\" target=\"_blank\"><code>feature<\/code> method to rely on the type <code>:features<\/code> instead of <code>:requests<\/code><\/a>.<\/p>\n<p>The proposal suggests the addition of two new directories instead of changing the behavior of existing ones in order to be backwards compatible while ensuring a safe and more semantic future for everyone else. David asked me to outline our conversation in a blog post, so we can get some awareness and feedback before undergoing such changes. So, what do <strong>you<\/strong> think?<\/p>\n","protected":false},"excerpt":{"rendered":"<p>When David Chelimsky was visiting S\u00e3o Paulo in last April, we invited him to go out for some coffee, beers and brazilian appetizers. We had a great time and we talked about different topics like OO, programming languages, authoring books and, as expected, about testing. One of the topics in our testing discussion was the &#8230; <a class=\"read-more-link\" href=\"https:\/\/blog.plataformatec.com.br\/2012\/06\/improving-the-integration-between-capybara-and-rspec\/\">\u00bb<\/a><\/p>\n","protected":false},"author":4,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"ngg_post_thumbnail":0,"footnotes":""},"categories":[1],"tags":[94,7,183],"aioseo_notices":[],"jetpack_sharing_enabled":true,"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/2804"}],"collection":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/users\/4"}],"replies":[{"embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/comments?post=2804"}],"version-history":[{"count":8,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/2804\/revisions"}],"predecessor-version":[{"id":2833,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/2804\/revisions\/2833"}],"wp:attachment":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/media?parent=2804"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/categories?post=2804"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/tags?post=2804"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}