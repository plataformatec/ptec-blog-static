{"id":9593,"date":"2020-01-02T14:22:45","date_gmt":"2020-01-02T16:22:45","guid":{"rendered":"http:\/\/blog.plataformatec.com.br\/?p=9593"},"modified":"2020-01-03T15:22:24","modified_gmt":"2020-01-03T17:22:24","slug":"elixir-what-about-tests","status":"publish","type":"post","link":"http:\/\/blog.plataformatec.com.br\/2020\/01\/elixir-what-about-tests\/","title":{"rendered":"Elixir: What about tests?"},"content":{"rendered":"\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" decoding=\"async\" width=\"1024\" height=\"1024\" src=\"http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-1024x1024.jpg\" alt=\"\" class=\"wp-image-9594\" srcset=\"http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-1024x1024.jpg 1024w, http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-300x300.jpg 300w, http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-150x150.jpg 150w, http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-768x768.jpg 768w, http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-1536x1536.jpg 1536w, http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2020\/01\/ben-kolde-H29h6a8j8QM-unsplash-2048x2048.jpg 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<p>There is no arguing about how important tests are for our application.<\/p>\n\n\n\n<p>But from time to time, when we are dealing with it, some questions came up on a daily basis.<\/p>\n\n\n\n<p>A very common day-do-day case is our application relying on APIs and external libs, but one of the things we don&#8217;t want our test suite to do is to access the external world.<\/p>\n\n\n\n<p>This can lead us to many undesired scenarios, for example: if we have a connection problem on an API test that hits the internet, the test will fail, causing our test suite to be intermittent.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">How do we mock or stub a request?<\/h3>\n\n\n\n<p>Some libs can help us, I will talk about two of them.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Bypass<\/h3>\n\n\n\n<p>The first one I wanna talk about is <a href=\"https:\/\/github.com\/PSPDFKit-labs\/bypass\">Bypass<\/a>.<br>\nIt is a lib that simulates an External Server, it works to stub the layer closer to the request. The idea is that you remove the external layer and start to call Bypass, so now, instead of talking to the internet, you are talking to a local server that you have control of. This way you can keep your tests protected.<\/p>\n\n\n\n<p>Let&#8217;s think about an example, we will build an application that needs to fetch data from an API, and we will create a <code>LastfmClient<\/code> module that will be responsible for doing that.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-1\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">defmodule MyApp.Lastfm.Client <span class=\"hljs-keyword\">do<\/span>\n  @moduledoc<span class=\"hljs-string\">\"\"<\/span><span class=\"hljs-string\">\"\n  Search tracks\n\n  https:\/\/www.last.fm\/api\/show\/track.search\n  \"<\/span><span class=\"hljs-string\">\"\"<\/span>\n\n  @api_url <span class=\"hljs-string\">\"https:\/\/ws.audioscrobbler.com\/2.0\/\"<\/span>\n\n  def search(term, url \\\\ @api_url) <span class=\"hljs-keyword\">do<\/span>\n    response = Mojito.request(method: :get, url: search_url(url, term))\n\n    <span class=\"hljs-keyword\">case<\/span> response <span class=\"hljs-keyword\">do<\/span>\n      {:ok, %{status_code: <span class=\"hljs-number\">200<\/span>, body: body}} -&gt;\n        {:ok, response(body)}\n      {:ok, %{status_code: <span class=\"hljs-number\">404<\/span>}} -&gt;\n        {:not_found, <span class=\"hljs-string\">\"Not found\"<\/span>}\n      {_, response} -&gt;\n        {:error, response}\n    end\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-1\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>What this client does is fetch the tracks from our API and according to the type of the response return something. Not that different from most of the clients we wrote on a daily basis. Let&#8217;s test it now.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-2\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">describe <span class=\"hljs-string\">\"search\/2\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n  test <span class=\"hljs-string\">\"searches tracks by the term\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n    response = Client.search(<span class=\"hljs-string\">\"The Kooks\"<\/span>)\n\n    assert {:ok, [\n      %{\n        <span class=\"hljs-string\">\"artist\"<\/span> =&gt; <span class=\"hljs-string\">\"The Kooks\"<\/span>,\n        <span class=\"hljs-string\">\"name\"<\/span> =&gt; <span class=\"hljs-string\">\"Seaside\"<\/span>,\n        <span class=\"hljs-string\">\"url\"<\/span> =&gt; <span class=\"hljs-string\">\"https:\/\/www.last.fm\/music\/The+Kooks\/_\/Seaside\"<\/span>\n      }\n    ]} = response\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-2\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<h3 class=\"wp-block-heading\">What&#8217;s the problem with this test?<\/h3>\n\n\n\n<p>It seems pretty straight forward we exercise the <a href=\"https:\/\/en.wikipedia.org\/wiki\/System_under_test\">SUT<\/a> and verify the expected outcome, but this is a fragile test because it is accessing the external world.<\/p>\n\n\n\n<p>Every time we call the <code>Client.search\/2<\/code> we are hitting the internet. A lot of problems can happen here: if the internet is down the test will fail, if the internet is slow your suit test will be slow, you won&#8217;t have the feedback as fast as you need and will be less inclined to run the test suit, or your suit test will become intermittent and you won&#8217;t trust your tests anymore, meaning that when a real failure happens you won&#8217;t care.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">How can we fix it?<\/h3>\n\n\n\n<p>And that&#8217;s when <a href=\"https:\/\/github.com\/PSPDFKit-labs\/bypass\">Bypass<\/a> comes to our aid.<\/p>\n\n\n\n<p>First, you will need to setup Bypass in your tests.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-3\" data-shcb-language-name=\"JavaScript\" data-shcb-language-slug=\"javascript\"><div><code class=\"hljs language-javascript\">setup <span class=\"hljs-keyword\">do<\/span>\n  bypass = Bypass.open()\n\n  {:ok, <span class=\"hljs-attr\">bypass<\/span>: bypass}\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-3\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">JavaScript<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">javascript<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>And in your test, you will set up which scenarios you want to test. Is it a success call? A not found? How should your code behave in each scenario? Tell Bypass that.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-4\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">describe <span class=\"hljs-string\">\"search\/2\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n  test <span class=\"hljs-string\">\"searches tracks by the term\"<\/span>, %{bypass: bypass} <span class=\"hljs-keyword\">do<\/span>\n    Bypass.expect bypass, fn conn -&gt;\n      Plug.Conn.resp(conn, <span class=\"hljs-number\">200<\/span>, payload())\n    end\n\n    response = Client.search(<span class=\"hljs-string\">\"The Kooks\"<\/span>, <span class=\"hljs-string\">\"http:\/\/localhost:#{bypass.port}\/\"<\/span>)\n\n    assert {:ok, [\n      %{\n        <span class=\"hljs-string\">\"artist\"<\/span> =&gt; <span class=\"hljs-string\">\"The Kooks\"<\/span>,\n        <span class=\"hljs-string\">\"name\"<\/span> =&gt; <span class=\"hljs-string\">\"Seaside\"<\/span>,\n        <span class=\"hljs-string\">\"url\"<\/span> =&gt; <span class=\"hljs-string\">\"https:\/\/www.last.fm\/music\/The+Kooks\/_\/Seaside\"<\/span>\n      }\n    ]} = response\n  end\nend\n\ndefp payload <span class=\"hljs-keyword\">do<\/span>\n  ~s(\n    {\n      <span class=\"hljs-string\">\"results\"<\/span>: {\n        <span class=\"hljs-string\">\"@attr\"<\/span>: {},\n        <span class=\"hljs-string\">\"opensearch:Query\"<\/span>: {\n          <span class=\"hljs-string\">\"#text\"<\/span>: <span class=\"hljs-string\">\"\"<\/span>,\n          <span class=\"hljs-string\">\"role\"<\/span>: <span class=\"hljs-string\">\"request\"<\/span>,\n          <span class=\"hljs-string\">\"startPage\"<\/span>: <span class=\"hljs-string\">\"1\"<\/span>\n        },\n        <span class=\"hljs-string\">\"opensearch:itemsPerPage\"<\/span>: <span class=\"hljs-string\">\"20\"<\/span>,\n        <span class=\"hljs-string\">\"opensearch:startIndex\"<\/span>: <span class=\"hljs-string\">\"0\"<\/span>,\n        <span class=\"hljs-string\">\"opensearch:totalResults\"<\/span>: <span class=\"hljs-string\">\"51473\"<\/span>,\n        <span class=\"hljs-string\">\"trackmatches\"<\/span>: {\n          <span class=\"hljs-string\">\"track\"<\/span>: [\n            {\n              <span class=\"hljs-string\">\"artist\"<\/span>: <span class=\"hljs-string\">\"The Kooks\"<\/span>,\n              <span class=\"hljs-string\">\"image\"<\/span>: [\n                {\n                  <span class=\"hljs-string\">\"#text\"<\/span>: <span class=\"hljs-string\">\"https:\/\/lastfm.freetls.fastly.net\/i\/u\/34s\/2a96cbd8b46e442fc41c2b86b821562f.png\"<\/span>,\n                  <span class=\"hljs-string\">\"size\"<\/span>: <span class=\"hljs-string\">\"small\"<\/span>\n                },\n                {\n                  <span class=\"hljs-string\">\"#text\"<\/span>: <span class=\"hljs-string\">\"https:\/\/lastfm.freetls.fastly.net\/i\/u\/64s\/2a96cbd8b46e442fc41c2b86b821562f.png\"<\/span>,\n                  <span class=\"hljs-string\">\"size\"<\/span>: <span class=\"hljs-string\">\"medium\"<\/span>\n                },\n                {\n                  <span class=\"hljs-string\">\"#text\"<\/span>: <span class=\"hljs-string\">\"https:\/\/lastfm.freetls.fastly.net\/i\/u\/174s\/2a96cbd8b46e442fc41c2b86b821562f.png\"<\/span>,\n                  <span class=\"hljs-string\">\"size\"<\/span>: <span class=\"hljs-string\">\"large\"<\/span>\n                },\n                {\n                  <span class=\"hljs-string\">\"#text\"<\/span>: <span class=\"hljs-string\">\"https:\/\/lastfm.freetls.fastly.net\/i\/u\/300x300\/2a96cbd8b46e442fc41c2b86b821562f.png\"<\/span>,\n                  <span class=\"hljs-string\">\"size\"<\/span>: <span class=\"hljs-string\">\"extralarge\"<\/span>\n                }\n              ],\n              <span class=\"hljs-string\">\"listeners\"<\/span>: <span class=\"hljs-string\">\"851783\"<\/span>,\n              <span class=\"hljs-string\">\"mbid\"<\/span>: <span class=\"hljs-string\">\"c9b89088-01cd-4d98-a1f4-3e4a00519320\"<\/span>,\n              <span class=\"hljs-string\">\"name\"<\/span>: <span class=\"hljs-string\">\"Seaside\"<\/span>,\n              <span class=\"hljs-string\">\"streamable\"<\/span>: <span class=\"hljs-string\">\"FIXME\"<\/span>,\n              <span class=\"hljs-string\">\"url\"<\/span>: <span class=\"hljs-string\">\"https:\/\/www.last.fm\/music\/The+Kooks\/_\/Seaside\"<\/span>\n            }\n          ]\n        }\n      }\n    }\n  )\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-4\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<h3 class=\"wp-block-heading\">When to use Bypass?<\/h3>\n\n\n\n<p>When you have code that needs to make an HTTP request. You need to know how your application will behave. For instance, if the API is down, will your application stop working?<\/p>\n\n\n\n<p>But then comes some questions, if I have a module that depends on this <code>Client<\/code> implementation, will I need to repeat this Bypass code every time in my tests?<br>\nWhy does another module need to know these implementation details if it is not dealing with the request?<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Mox<\/h3>\n\n\n\n<p><a href=\"https:\/\/github.com\/plataformatec\/mox\">Mox<\/a> can help us with that. It forces you to implement explicit contracts in your application so we know what to expect.<\/p>\n\n\n\n<p>Going back to our example, let&#8217;s implement a module called <code>Playlist<\/code> that will be responsible for fetching a list of songs by artist and give it a name.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-5\" data-shcb-language-name=\"JavaScript\" data-shcb-language-slug=\"javascript\"><div><code class=\"hljs language-javascript\">defmodule MyApp.Playlist <span class=\"hljs-keyword\">do<\/span>\n  alias MyApp.Lastfm.Client\n\n  def artist(name) <span class=\"hljs-keyword\">do<\/span>\n    {:ok, songs} = Client.search(name)\n\n    %{\n      <span class=\"hljs-attr\">name<\/span>: <span class=\"hljs-string\">\"This is #{name}\"<\/span>,\n      <span class=\"hljs-attr\">songs<\/span>: songs\n    }\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-5\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">JavaScript<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">javascript<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>The simplest test we can write to this code would be something like:<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-6\" data-shcb-language-name=\"JavaScript\" data-shcb-language-slug=\"javascript\"><div><code class=\"hljs language-javascript\">describe <span class=\"hljs-string\">\"artist\/1\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n  test <span class=\"hljs-string\">\"returns the songs by artist\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n    result = Playlist.artist(<span class=\"hljs-string\">\"The Kooks\"<\/span>)\n\n    assert result[<span class=\"hljs-string\">\"name\"<\/span>] == <span class=\"hljs-string\">\"This is The Kooks\"<\/span>\n    assert Enum.any?(result[<span class=\"hljs-string\">\"songs\"<\/span>], fn song -&gt;\n      song[<span class=\"hljs-string\">\"artist\"<\/span>] == <span class=\"hljs-string\">\"The Kooks\"<\/span>\n    end)\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-6\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">JavaScript<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">javascript<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>Since the <code>Playlist<\/code> depends on the <code>Client<\/code>, to have an accurate test we would need to stub the request with the payload response from the Lastfm API so we can make sure the <code>Playlist<\/code> behaves accordingly.<\/p>\n\n\n\n<p>You don&#8217;t need to stub all the <code>Client<\/code> requests in the <code>Playlist<\/code> tests, you need to know what it returns and handle the responses, you need to have a <a href=\"http:\/\/blog.plataformatec.com.br\/2015\/10\/mocks-and-explicit-contracts\/\">explicit contract<\/a>.<\/p>\n\n\n\n<p>Let&#8217;s see how we can implement those contracts.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Behaviours<\/h3>\n\n\n\n<p>Elixir uses <a href=\"https:\/\/elixir-lang.org\/getting-started\/typespecs-and-behaviours.html#behaviours\">behaviours<\/a> as a way to define a set of functions that have to be implemented by a module. You can compare them to <a href=\"https:\/\/en.wikipedia.org\/wiki\/Interface_(computing)\">interfaces<\/a> in OOP.<\/p>\n\n\n\n<p>Let&#8217;s create a file at <code>lib\/my_app\/music.ex<\/code> that says what our <code>Client<\/code> expects as an argument and what it returns:<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-7\" data-shcb-language-name=\"JavaScript\" data-shcb-language-slug=\"javascript\"><div><code class=\"hljs language-javascript\">defmodule MyApp.Music <span class=\"hljs-keyword\">do<\/span>\n  @callback search(<span class=\"hljs-built_in\">String<\/span>.t()) :: map()\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-7\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">JavaScript<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">javascript<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>In our <code>config\/config.exs<\/code> file, let&#8217;s include two lines. The first one says which client we are using and the second one is the Lastfm API that we will remove from the default argument, just to keep the callback simple.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-8\" data-shcb-language-name=\"JavaScript\" data-shcb-language-slug=\"javascript\"><div><code class=\"hljs language-javascript\">config :my_app, :music, MyApp.Lastfm.Client\n<span class=\"hljs-attr\">config<\/span> :my_app, :lastfm_api, <span class=\"hljs-string\">\"https:\/\/ws.audioscrobbler.com\/2.0\/\"<\/span><\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-8\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">JavaScript<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">javascript<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>In our <code>config\/test.exs<\/code> file, let&#8217;s include our mock module.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-9\" data-shcb-language-name=\"CSS\" data-shcb-language-slug=\"css\"><div><code class=\"hljs language-css\"><span class=\"hljs-selector-tag\">config<\/span> <span class=\"hljs-selector-pseudo\">:my_app<\/span>, <span class=\"hljs-selector-pseudo\">:music<\/span>, <span class=\"hljs-selector-tag\">MyApp<\/span><span class=\"hljs-selector-class\">.MusicMock<\/span><\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-9\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">CSS<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">css<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>In the <code>test\/test_helper<\/code> file, let&#8217;s tell Mox which is the mock module that is responsible for mocking the calls to our behaviour.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-10\" data-shcb-language-name=\"CSS\" data-shcb-language-slug=\"css\"><div><code class=\"hljs language-css\"><span class=\"hljs-selector-tag\">Mox<\/span><span class=\"hljs-selector-class\">.defmock<\/span>(<span class=\"hljs-selector-tag\">MyApp<\/span><span class=\"hljs-selector-class\">.MusicMock<\/span>, <span class=\"hljs-selector-tag\">for<\/span>: <span class=\"hljs-selector-tag\">MyApp<\/span><span class=\"hljs-selector-class\">.Music<\/span>)<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-10\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">CSS<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">css<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>Let&#8217;s go back to our <code>Playlist<\/code> module, and let&#8217;s change the way we call the <code>Client<\/code> module, to use the config we just created.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-11\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">defmodule MyApp.Playlist <span class=\"hljs-keyword\">do<\/span>\n  @music Application.get_env(:my_app, :music)\n\n  def artist(name) <span class=\"hljs-keyword\">do<\/span>\n    {:ok, songs} = @music.search(name)\n\n    %{\n      <span class=\"hljs-string\">\"name\"<\/span> =&gt; <span class=\"hljs-string\">\"This is #{name}\"<\/span>,\n      <span class=\"hljs-string\">\"songs\"<\/span> =&gt; songs\n    }\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-11\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>In our <code>Client<\/code> module let&#8217;s adopt the behaviour we created, and let&#8217;s change the API url to fetch from the config we created.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-12\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">defmodule MyApp.Lastfm.Client <span class=\"hljs-keyword\">do<\/span>\n  @moduledoc<span class=\"hljs-string\">\"\"<\/span><span class=\"hljs-string\">\"\n  Search tracks\n\n  https:\/\/www.last.fm\/api\/show\/track.search\n  \"<\/span><span class=\"hljs-string\">\"\"<\/span>\n\n  @behaviour MyApp.Music\n\n  def search(term) <span class=\"hljs-keyword\">do<\/span>\n    url = lastfm_api_url()\n    response = Mojito.request(method: :get, url: search_url(url, term))\n\n    <span class=\"hljs-keyword\">case<\/span> response <span class=\"hljs-keyword\">do<\/span>\n      {:ok, %{status_code: <span class=\"hljs-number\">200<\/span>, body: body}} -&gt;\n        {:ok, response(body)}\n      {:ok, %{status_code: <span class=\"hljs-number\">404<\/span>}} -&gt;\n        {:not_found, <span class=\"hljs-string\">\"Not found\"<\/span>}\n      {_, response} -&gt;\n        {:error, response}\n    end\n  end\n\n  defp lastfm_api_url <span class=\"hljs-keyword\">do<\/span>\n    Application.get_env(:my_app, :lastfm_api)\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-12\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>We will need to change the <code>test\/my_app\/lastfm\/client_test.exs<\/code> to change the env config for the API url on the setup of the test, but I&#8217;ll leave it to you to do that.<\/p>\n\n\n\n<p>Finally, in our <code>PlaylistTest<\/code> we will need to import <code>Mox<\/code>.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-13\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">import Mox\n\n<span class=\"hljs-comment\"># Make sure mocks are verified when the test exits<\/span>\nsetup :verify_on_exit!<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-13\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>And in our test, we need to tell our <code>MusicMock<\/code> what is expected to return.<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-14\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">describe <span class=\"hljs-string\">\"artist\/1\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n  test <span class=\"hljs-string\">\"returns the songs by artist\"<\/span> <span class=\"hljs-keyword\">do<\/span>\n    MusicMock\n    |&gt; expect(:search, fn _name -&gt;\n      {\n        :ok,\n        [\n          %{\n            <span class=\"hljs-string\">\"artist\"<\/span> =&gt; <span class=\"hljs-string\">\"The Kooks\"<\/span>,\n            <span class=\"hljs-string\">\"name\"<\/span> =&gt; <span class=\"hljs-string\">\"Seaside\"<\/span>,\n            <span class=\"hljs-string\">\"url\"<\/span> =&gt; <span class=\"hljs-string\">\"https:\/\/www.last.fm\/music\/The+Kooks\/_\/Seaside\"<\/span>\n          }\n        ]\n      }\n    end)\n\n    result = Playlist.artist(<span class=\"hljs-string\">\"The Kooks\"<\/span>)\n\n    assert result[<span class=\"hljs-string\">\"name\"<\/span>] == <span class=\"hljs-string\">\"This is The Kooks\"<\/span>\n    assert Enum.any?(result[<span class=\"hljs-string\">\"songs\"<\/span>], fn song -&gt;\n      song[<span class=\"hljs-string\">\"artist\"<\/span>] == <span class=\"hljs-string\">\"The Kooks\"<\/span>\n    end)\n  end\nend<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-14\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<h3 class=\"wp-block-heading\">What&#8217;s the difference?<\/h3>\n\n\n\n<p>Looking at the code it seems that we still need to pass the list of music in the tests. But there is a difference, the music&#8217;s list is a dependency of the <code>Playlist<\/code> module, but we don&#8217;t know its internals, we don&#8217;t know from where we are fetching it, how the request response works, and all these details. The only thing we need to know at the <code>Playlist<\/code> module is that it depends on a list of songs.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">One last thing before we go<\/h3>\n\n\n\n<p>We went through all that trouble to make sure the tests are protected from the outside world, but you know, Elixir has this amazing <code>Doctest<\/code> feature, and one can argue that this replaces the application tests.<\/p>\n\n\n\n<p>That&#8217;s not the case, <code>Doctests<\/code> are not <code>tests<\/code> and you shouldn&#8217;t rely on it to make sure your application behaves the way you expect it to. Make sure you don&#8217;t use any code that hits the external world when you are writing your documentation, there is no way to mock calls and this can cause all the problems we already discussed.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">That&#8217;s all folks<\/h3>\n\n\n\n<p>The code from this example can be found <a href=\"https:\/\/github.com\/amandasposito\/my_app\">here<\/a>, I hope it helps!<\/p>\n","protected":false},"excerpt":{"rendered":"<p>There is no arguing about how important tests are for our application. But from time to time, when we are dealing with it, some questions came up on a daily basis. A very common day-do-day case is our application relying on APIs and external libs, but one of the things we don&#8217;t want our test &#8230; <a class=\"read-more-link\" href=\"http:\/\/blog.plataformatec.com.br\/2020\/01\/elixir-what-about-tests\/\">\u00bb<\/a><\/p>\n","protected":false},"author":67,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"ngg_post_thumbnail":0,"footnotes":""},"categories":[1],"tags":[143,96],"aioseo_notices":[],"jetpack_sharing_enabled":true,"jetpack_featured_media_url":"","_links":{"self":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/9593"}],"collection":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/users\/67"}],"replies":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/comments?post=9593"}],"version-history":[{"count":28,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/9593\/revisions"}],"predecessor-version":[{"id":9629,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/9593\/revisions\/9629"}],"wp:attachment":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/media?parent=9593"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/categories?post=9593"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/tags?post=9593"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}