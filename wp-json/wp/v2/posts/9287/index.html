{"id":9287,"date":"2019-09-06T15:08:12","date_gmt":"2019-09-06T18:08:12","guid":{"rendered":"http:\/\/blog.plataformatec.com.br\/?p=9287"},"modified":"2019-09-09T10:09:08","modified_gmt":"2019-09-09T13:09:08","slug":"improve-confirmation-token-validation-in-devise-cve-2019-xxxx","status":"publish","type":"post","link":"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/","title":{"rendered":"Improve confirmation token validation in Devise (CVE-2019-16109)"},"content":{"rendered":"\n<p>Devise version <code>4.7.1<\/code> was released with a fix for an edge case that could confirm accounts by mistake. We&#8217;ll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\">Description<\/h2>\n\n\n\n<p>We received a security report saying that it was possible to confirm records with a blank <code>confirmation_token<\/code> parameter. In order words, hitting the following URL <code>\/users\/confirmation?confirmation_token=<\/code> would successfully confirm a user instead of showing a validation error &#8211; e.g. <code>Confirmation token can't be blank<\/code>.<\/p>\n\n\n\n<p>This only happens if there are <strong>records with a blank confirmation token in the database<\/strong>. This is because of the way the method <code><a href=\"https:\/\/github.com\/plataformatec\/devise\/blob\/0ea4bd70b2ca852d3314f53b62ffd9c7583c4f0d\/lib\/devise\/models\/authenticatable.rb#L274\" target=\"_blank\" rel=\"noreferrer noopener\" aria-label=\" (opens in a new tab)\">find_first_by_auth_conditions<\/a><\/code> works (which is similar to ActiveRecord&#8217;s <code>#find_by<\/code>). It is important to mention that we haven&#8217;t found a case where Devise sets <code>confirmation_token<\/code> to an empty string.<\/p>\n\n\n\n<p>In summary, before version <code>4.7.1<\/code>, this is what would happen after hitting the confirmation endpoint with a blank <code>confirmation_token<\/code>:<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-1\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">Started GET <span class=\"hljs-string\">\"\/users\/confirmation?confirmation_token=\"<\/span> <span class=\"hljs-keyword\">for<\/span> ::<span class=\"hljs-number\">1<\/span> at <span class=\"hljs-number\">2019<\/span><span class=\"hljs-number\">-09<\/span><span class=\"hljs-number\">-05<\/span> <span class=\"hljs-number\">10<\/span>:<span class=\"hljs-number\">24<\/span>:<span class=\"hljs-number\">29<\/span> <span class=\"hljs-number\">-0300<\/span>\nProcessing by Devise::ConfirmationsController<span class=\"hljs-comment\">#show as HTML<\/span>\n  Parameters: {<span class=\"hljs-string\">\"confirmation_token\"<\/span>=&gt;<span class=\"hljs-string\">\"\"<\/span>}\n  User Load (<span class=\"hljs-number\">1.0<\/span>ms)  SELECT  <span class=\"hljs-string\">\"users\"<\/span>.* FROM <span class=\"hljs-string\">\"users\"<\/span> WHERE <span class=\"hljs-string\">\"users\"<\/span>.<span class=\"hljs-string\">\"confirmation_token\"<\/span> = $<span class=\"hljs-number\">1<\/span> ORDER BY <span class=\"hljs-string\">\"users\"<\/span>.<span class=\"hljs-string\">\"id\"<\/span> ASC LIMIT $<span class=\"hljs-number\">2<\/span>  [[<span class=\"hljs-string\">\"confirmation_token\"<\/span>, <span class=\"hljs-string\">\"\"<\/span>], [<span class=\"hljs-string\">\"LIMIT\"<\/span>, <span class=\"hljs-number\">1<\/span>]]<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-1\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>Notice that the SQL query is trying to find users with <code>confirmation_token = \"\"<\/code>.<\/p>\n\n\n\n<p>It&#8217;s also worth mentioning that <strong>only unconfirmed records<\/strong> &#8211; i.e. with <code>confirmed_at: nil<\/code> in the database &#8211; would be confirmed in this case. For already confirmed users, a validation error (<code>Email was already confirmed, please try signing in<\/code>) would be displayed.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\">Possible implications<\/h2>\n\n\n\n<p>Considering that there are records with an empty <code>confirmation_token<\/code> in the database, a request sending a blank parameter would confirm the first record found in the database. This means that someone&#8217;s account would be confirmed by mistake.<\/p>\n\n\n\n<p>A more sensible scenario is for applications that automatically sign in accounts after confirmation. That would not only confirm someone&#8217;s account but also give an attacker access to it. Although this feature is not included in Devise, we know that some applications might have it.<\/p>\n\n\n\n<p>For already confirmed records &#8211; i.e. with a <code>confirmed_at<\/code> date in the database &#8211; the validation error would be displayed, but their email would be leaked to the end user inside the form&#8217;s input.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\">Solution<\/h2>\n\n\n\n<p>The solution was to validate whether the <code>confirmation_token<\/code> is empty before doing any query in the database. So now, when the same endpoint is hit, nothing happens:<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-2\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">Processing by Devise::ConfirmationsController<span class=\"hljs-comment\">#show as HTML<\/span>\n  Parameters: {<span class=\"hljs-string\">\"confirmation_token\"<\/span>=&gt;<span class=\"hljs-string\">\"\"<\/span>}\nCompleted <span class=\"hljs-number\">200<\/span> OK in <span class=\"hljs-number\">371<\/span>ms (Views: <span class=\"hljs-number\">339.0<\/span>ms | ActiveRecord: <span class=\"hljs-number\">5.9<\/span>ms)<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-2\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>And the end-user will see the validation error on the screen.<\/p>\n\n\n\n<p>See the <a href=\"https:\/\/github.com\/plataformatec\/devise\/pull\/5132\" target=\"_blank\" rel=\"noreferrer noopener\" aria-label=\" (opens in a new tab)\">pull request<\/a> with the solution for more information.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\">Actions you might want to take<\/h2>\n\n\n\n<p>Aside from updating Devise, you might also want to check whether you have records in that state in your application. You can do that with a query like this one:<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-3\" data-shcb-language-name=\"PHP\" data-shcb-language-slug=\"php\"><div><code class=\"hljs language-php\">irb(main):<span class=\"hljs-number\">001<\/span>:<span class=\"hljs-number\">0<\/span>&gt; User.where(confirmation_token: <span class=\"hljs-string\">\"\"<\/span>)\n  User Load (<span class=\"hljs-number\">0.6<\/span>ms)  SELECT  <span class=\"hljs-string\">\"users\"<\/span>.* FROM <span class=\"hljs-string\">\"users\"<\/span> WHERE <span class=\"hljs-string\">\"users\"<\/span>.<span class=\"hljs-string\">\"confirmation_token\"<\/span> = $<span class=\"hljs-number\">1<\/span> LIMIT $<span class=\"hljs-number\">2<\/span>  [[<span class=\"hljs-string\">\"confirmation_token\"<\/span>, <span class=\"hljs-string\">\"\"<\/span>], [<span class=\"hljs-string\">\"LIMIT\"<\/span>, <span class=\"hljs-number\">11<\/span>]]\n=&gt; <span class=\"hljs-comment\">#&lt;ActiveRecord::Relation []&gt;<\/span><\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-3\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">PHP<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">php<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<p>If you get results out of this query, you might want to nullify them to avoid the confirmation by mistake:<\/p>\n\n\n<pre class=\"wp-block-code\" aria-describedby=\"shcb-language-4\" data-shcb-language-name=\"JavaScript\" data-shcb-language-slug=\"javascript\"><div><code class=\"hljs language-javascript\">irb(main):<span class=\"hljs-number\">002<\/span>:<span class=\"hljs-number\">0<\/span>&gt; User.where(confirmation_token: <span class=\"hljs-string\">\"\"<\/span>).update(confirmation_token: nil)\n  User Load (<span class=\"hljs-number\">0.4<\/span>ms)  SELECT <span class=\"hljs-string\">\"users\"<\/span>.* FROM <span class=\"hljs-string\">\"users\"<\/span> WHERE <span class=\"hljs-string\">\"users\"<\/span>.<span class=\"hljs-string\">\"confirmation_token\"<\/span> = $<span class=\"hljs-number\">1<\/span>  [[<span class=\"hljs-string\">\"confirmation_token\"<\/span>, <span class=\"hljs-string\">\"\"<\/span>]]\n   (<span class=\"hljs-number\">0.2<\/span>ms)  BEGIN\n  User Update (<span class=\"hljs-number\">0.7<\/span>ms)  UPDATE <span class=\"hljs-string\">\"users\"<\/span> SET <span class=\"hljs-string\">\"confirmation_token\"<\/span> = $<span class=\"hljs-number\">1<\/span>, <span class=\"hljs-string\">\"updated_at\"<\/span> = $<span class=\"hljs-number\">2<\/span> WHERE <span class=\"hljs-string\">\"users\"<\/span>.<span class=\"hljs-string\">\"id\"<\/span> = $<span class=\"hljs-number\">3<\/span>  [[<span class=\"hljs-string\">\"confirmation_token\"<\/span>, nil], [<span class=\"hljs-string\">\"updated_at\"<\/span>, <span class=\"hljs-string\">\"2019-09-05 14:03:20.857488\"<\/span>], [<span class=\"hljs-string\">\"id\"<\/span>, <span class=\"hljs-number\">1<\/span>]]\n   (<span class=\"hljs-number\">1.2<\/span>ms)  COMMIT<\/code><\/div><small class=\"shcb-language\" id=\"shcb-language-4\"><span class=\"shcb-language__label\">Code language:<\/span> <span class=\"shcb-language__name\">JavaScript<\/span> <span class=\"shcb-language__paren\">(<\/span><span class=\"shcb-language__slug\">javascript<\/span><span class=\"shcb-language__paren\">)<\/span><\/small><\/pre>\n\n\n<h2 class=\"wp-block-heading\">Causes<\/h2>\n\n\n\n<p>Although we received a report where someone worked in an application that had records with a blank confirmation token in the database, no code or use case was found inside Devise that would make records end up in that state.<\/p>\n\n\n\n<p>If you find a case where this happens, please contact us at <a href=\"mailto:opensource@plataformatec.com.br\">opensource@plataformatec.com.br<\/a> and we&#8217;ll look at it.<\/p>\n\n\n\n<p>Finally, we want to thank <a href=\"https:\/\/github.com\/amangano-privy\" target=\"_blank\" rel=\"noreferrer noopener\" aria-label=\"Anthony Mangano (opens in a new tab)\">Anthony Mangano<\/a> for reporting this issue and helping with the solution.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Devise version 4.7.1 was released with a fix for an edge case that could confirm accounts by mistake. We&#8217;ll explain now in details what is the issue, how it was fixed and which actions you might want to take in your applications. Description We received a security report saying that it was possible to confirm &#8230; <a class=\"read-more-link\" href=\"http:\/\/blog.plataformatec.com.br\/2019\/09\/improve-confirmation-token-validation-in-devise-cve-2019-xxxx\/\">\u00bb<\/a><\/p>\n","protected":false},"author":54,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"ngg_post_thumbnail":0,"footnotes":""},"categories":[1],"tags":[36,7],"aioseo_notices":[],"jetpack_sharing_enabled":true,"jetpack_featured_media_url":"","_links":{"self":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/9287"}],"collection":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/users\/54"}],"replies":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/comments?post=9287"}],"version-history":[{"count":10,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/9287\/revisions"}],"predecessor-version":[{"id":9300,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/9287\/revisions\/9300"}],"wp:attachment":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/media?parent=9287"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/categories?post=9287"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/tags?post=9287"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}