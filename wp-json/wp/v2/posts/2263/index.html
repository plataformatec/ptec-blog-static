{"id":2263,"date":"2011-09-20T16:19:43","date_gmt":"2011-09-20T19:19:43","guid":{"rendered":"http:\/\/blog.plataformatec.com.br\/?p=2263"},"modified":"2011-09-20T22:17:12","modified_gmt":"2011-09-21T01:17:12","slug":"bare-bone-stripped-down-devise","status":"publish","type":"post","link":"https:\/\/blog.plataformatec.com.br\/2011\/09\/bare-bone-stripped-down-devise\/","title":{"rendered":"Bare-bone, stripped-down Devise"},"content":{"rendered":"<p>Last week I spoke at Silicon Valley Ruby Group about PlataformaTec&#8217;s open source tools, mainly <a href=\"http:\/\/github.com\/plataformatec\/devise\" target=\"_blank\">Devise<\/a>, <a href=\"http:\/\/github.com\/plataformatec\/simple_form\" target=\"_blank\">Simple Form<\/a> and <a href=\"http:\/\/github.com\/plataformatec\/responders\" target=\"_blank\">Responders<\/a>.<\/p>\n<p>When talking about Devise, I&#8217;ve mentioned that, before creating Devise, we were alternating between using <a href=\"https:\/\/github.com\/binarylogic\/authlogic\" target=\"_blank\">Authlogic<\/a> or <a href=\"https:\/\/github.com\/thoughtbot\/clearance\" target=\"_blank\">Clearance<\/a> in our projects. However, we soon realized that we needed a solution that was as customizable as Authlogic (allowing us to choose behaviors and several configuration options) and as complete as Clearance (whole MVC stack). It is fun to remember this happened more than 2 years ago.<\/p>\n<p>After the presentation, someone came to talk to me about <a href=\"https:\/\/github.com\/NoamB\/sorcery\" target=\"_blank\">Sorcery<\/a> and said it would be nice if Devise provided the same kind of tooling, allowing someone to build their own controllers and views around Devise instead of using Devise built-in controllers and views. His proposal surprised me, because this approach is totally possible with Devise and it was one of our design goals since day one.<\/p>\n<p>That said, we realized that we were probably not &#8220;advertising&#8221; the bare-bone, stripped-down aspect of Devise well enough. That&#8217;s why I am writing this blog post. Devise already makes it easy for you to customize your own views, using the generator <code>rails g devise:views<\/code> which copies the views to your application. But what if you want to roll out your own views AND controllers?<\/p>\n<p>To show you how we can achieve that, let&#8217;s write some code! The first step is to create a Rails application:<\/p>\n<pre>rails new devise-only-model<\/pre>\n<p>Next, we will add Devise to the Gemfile:<\/p>\n<pre lang=\"ruby\">gem \"devise\", \"~> 1.4.6\"<\/pre>\n<p>And run the installation generator:<\/p>\n<pre>bundle install && rails g devise:install<\/pre>\n<p>The installation generator is going to give you some extra instructions, so don&#8217;t forget to do that as well. Next, let&#8217;s generate our basic User model, but we will pass an extra parameter called <code>--skip-routes<\/code>:<\/p>\n<pre>rails g devise User --skip-routes<\/pre>\n<p>By passing this extra parameter, Devise is going to generate everything as usual, with a small difference on <code>config\/routes.rb<\/code>:<\/p>\n<pre lang=\"ruby\">devise_for :users, :skip => :all<\/pre>\n<p>This parameter tells Devise to not generate any route at all. You can check that by executing <code>bundle exec rake routes<\/code>. However, you may be wondering: why can&#8217;t we simply remove the <code>devise_for<\/code> call? If we remove the route, Devise wouldn&#8217;t actually know that you have added Devise configuration to the User model, as all models are lazy loaded. So we need the route to tell Devise it needs to setup the appropriate helpers for the user, like <code>authenticate_user!<\/code>.<\/p>\n<p>With Devise configured, we are ready to create the controllers and views on our own. In this blog post, we are going to create the <code>SessionsController<\/code> as an example allowing us to sign in and sign out. First, let&#8217;s add our routes:<\/p>\n<pre lang=\"ruby\">\r\nroot :to => \"sessions#new\"\r\npost \"\/users\/sign_in\"    => \"sessions#create\"\r\ndelete \"\/users\/sign_out\" => \"sessions#destroy\"\r\n<\/pre>\n<p>Our <code>SessionsController<\/code> at <code>app\/controllers\/sessions_controller<\/code> looks like:<\/p>\n<pre lang=\"ruby\">\r\nclass SessionsController < ApplicationController\r\n  # For security purposes, Devise just authenticates an user\r\n  # from the params hash if we explicitly allow it to. That's\r\n  # why we need to call the before filter below.\r\n  before_filter :allow_params_authentication!, :only => :create\r\n\r\n  def new\r\n    @user = User.new(params[:user])\r\n  end\r\n\r\n  def create\r\n    # Since the authentication happens in the rack layer,\r\n    # we need to tell Devise to call the action \"sessions#new\"\r\n    # in case something goes bad. Feel free to change it.\r\n    user = authenticate_user!(:recall => \"sessions#new\")\r\n    flash[:notice] = \"You are now signed in!\"\r\n    sign_in user\r\n    redirect_to root_path\r\n  end\r\n\r\n  def destroy\r\n    sign_out\r\n    flash[:notice] = \"You are now signed out!\"\r\n    redirect_to root_path\r\n  end\r\nend\r\n<\/pre>\n<p>The controller implementation is quite straightforward. With the controller in hands, we just need to generate the view for the new action at <code>app\/views\/sessions\/new.html.erb<\/code>:<\/p>\n<pre lang=\"html-rails\">\r\n<% if user_signed_in? %>\r\n  You are signed in as <%= current_user.email %>. <%= link_to \"Sign out\", users_sign_out_path, :method => :delete %>.\r\n<% else %>\r\n  <%= form_for @user, :url => users_sign_in_path do |f| %>\r\n  <div><%= f.label :email %><br \/>\r\n  <%= f.email_field :email %><\/div>\r\n  <div><%= f.label :password %><br \/>\r\n  <%= f.password_field :password %><\/div>\r\n  <div><%= f.check_box :remember_me %> <%= f.label :remember_me %><\/div>\r\n  <div><%= f.submit \"Sign in\" %><\/div>\r\n  <% end %>\r\n<% end %>\r\n<\/pre>\n<p>The view shows a message if the user is signed in, otherwise it shows a sign in form. Now we are almost ready to check if it works. First, we need to run the migrations:<\/p>\n<pre>bundle exec rake db:migrate<\/pre>\n<p>Remove the index page:<\/p>\n<pre>rm public\/index.html<\/pre>\n<p>And create a user in the database so we can sign in. We can do that in <code>rails console<\/code>:<\/p>\n<pre lang=\"ruby\">\r\nUser.create!(:email => \"jose@example.com\", :password => \"123456\")\r\n<\/pre>\n<p>Now, start the server and you are ready to sign in and sign out. You can also block user access in any controller by calling <code>authenticate_user!<\/code> in a before filter. Just remember that, if you add the filter to your application controller, remember to skip the filter on the sessions controller, otherwise you won&#8217;t be able to sign in in the first place.<\/p>\n<p>You can now freely proceed to implement the other controllers and views in your application. Keep in mind that if you have <code>devise :recoverable<\/code> in your model, all the related methods like <code>User.send_reset_password_instructions<\/code> will already be available in your model, so you can use them straight away to implement your own reset password feature. Since Devise use all those methods internally, if you have any questions about implementing your own reset password feature, you can always take a look at <a href=\"https:\/\/github.com\/plataformatec\/devise\/tree\/master\/app\/controllers\/devise\" target=\"_blank\">Devise own controllers<\/a> for some help.<\/p>\n<p>I hope this post can help you to roll out your own controllers if this is the kind of feature you expect from Devise. Also, if you are worried about the overhead of using Devise even if you are not using its controllers, there is no need to worry at all. Devise does the smart thing and only loads the controllers you are actually using. Also, it lazily loads all behaviors, so if you are not using recoverable, no code related to recoverable will be loaded at all.<\/p>\n<p>It is important to keep in mind that Devise was built by us to be flexible and capable of handling different requirements from different clients, so it is PlataformaTec&#8217;s priority to have it as flexible as possible! So, what would you like to see in &#8220;bare-bone, stripped-down Devise&#8221; in order to better use it in your applications?<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Last week I spoke at Silicon Valley Ruby Group about PlataformaTec&#8217;s open source tools, mainly Devise, Simple Form and Responders. When talking about Devise, I&#8217;ve mentioned that, before creating Devise, we were alternating between using Authlogic or Clearance in our projects. However, we soon realized that we needed a solution that was as customizable as &#8230; <a class=\"read-more-link\" href=\"https:\/\/blog.plataformatec.com.br\/2011\/09\/bare-bone-stripped-down-devise\/\">\u00bb<\/a><\/p>\n","protected":false},"author":4,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"ngg_post_thumbnail":0,"footnotes":""},"categories":[1],"tags":[37,36,7],"aioseo_notices":[],"jetpack_sharing_enabled":true,"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/2263"}],"collection":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/users\/4"}],"replies":[{"embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/comments?post=2263"}],"version-history":[{"count":26,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/2263\/revisions"}],"predecessor-version":[{"id":2298,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/2263\/revisions\/2298"}],"wp:attachment":[{"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/media?parent=2263"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/categories?post=2263"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/tags?post=2263"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}