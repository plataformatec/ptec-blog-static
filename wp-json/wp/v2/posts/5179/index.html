{"id":5179,"date":"2016-03-15T12:58:33","date_gmt":"2016-03-15T15:58:33","guid":{"rendered":"http:\/\/blog.plataformatec.com.br\/?p=5179"},"modified":"2016-03-15T12:58:59","modified_gmt":"2016-03-15T15:58:59","slug":"using-gettext-to-internationalize-a-phoenix-application","status":"publish","type":"post","link":"http:\/\/blog.plataformatec.com.br\/2016\/03\/using-gettext-to-internationalize-a-phoenix-application\/","title":{"rendered":"Using Gettext to internationalize a Phoenix application"},"content":{"rendered":"<p>To translate or not to translate? We have been asking ourselves the same question in one of our latest Phoenix projects. Even though internationalizing our application is planned a bit ahead in our roadmap, we have decided to do an initial evaluation of the translation tools in the Elixir ecosystem, and we were pleasantly surprised by what it has to offer.<\/p>\n<p>The Phoenix framework ships with internationalization (i18n) and localization (l10n) system called Gettext since version 1.1. <strong>Gettext<\/strong> is a tool for writing multilingual programs used as a standard by many communities, meaning there is a great set of tooling for developers and translators.<\/p>\n<h2>Let&#8217;s start!<\/h2>\n<p>The idea behind Gettext is that it translates messages based on the string itself and not on &#8220;keys&#8221;. For example, instead of specifying translations as keys, as in <code>translate \"view.welcome\"<\/code>, we simply use the <code>gettext \"Hello there!\"<\/code> function for every string in the app.<\/p>\n<p>We have noticed this approach comes with two large benefits:<\/p>\n<ul>\n<li>When using &#8220;view.welcome&#8221; strings, it always required two steps from developers. The first was to use &#8220;view.welcome&#8221; in our templates and then add the translated string to a configuration file. Using <code>gettext<\/code> is a single step as it will use the given string if no translation is available;<\/p>\n<\/li>\n<li>\n<p>We can translate our applications without losing context since we keep the original text. We maintained applications in the past that relied heavily on &#8220;custom.message&#8221; strings and the extra level of indirection was always hard to work with.<\/p>\n<\/li>\n<\/ul>\n<p>Given those benefits, we have decided to tag already our strings with <code>gettext<\/code> calls, saving us from future work without a loss in productivity or maintainability.<\/p>\n<p>In this post, we will show you how we did that and how to translate effectively your app when the time comes in the future by running two tasks. Before, let&#8217;s take a look at the Gettext structure when we start a new Phoenix project.<\/p>\n<h3>Structure<\/h3>\n<p>Gettext uses two kinds of files: <code>*.po<\/code> and <code>*.pot<\/code>. These files are stored in <code>priv\/gettext\/<\/code>. For now, we have only the file errors that are used by Ecto. The structure is:<\/p>\n<pre><code>priv\/gettext\n\u2514\u2500 en_US\n| \u2514\u2500 LC_MESSAGES\n| \u2514\u2500 errors.po\n\u2514\u2500 errors.pot\n<\/code><\/pre>\n<h3>POT file<\/h3>\n<p><strong>POT<\/strong> means <em>Portable Object Template<\/em> and these files are generated automatically by:<\/p>\n<pre><code class=\"shell\">mix gettext.extract\n<\/code><\/pre>\n<p>A new Phoenix project already has a <code>gettext<\/code> call in the <code>web\/template\/pages\/index.html.eex<\/code> with <code>&lt;h2&gt;&amp;lt;%= gettext \"Welcome to %{name}\", name: \"Phoenix!\" %&amp;gt;&lt;\/h2&gt;<\/code>.<\/p>\n<p>The first time you run the task above, it will create a <code>default.pot<\/code> file with the text provided:<\/p>\n<pre><code>priv\/gettext\n\u2514\u2500 en_US\n| \u2514\u2500 LC_MESSAGES\n| \u2514\u2500 errors.po\n\u2514\u2500 default.pot\n\u2514\u2500 errors.pot\n<\/code><\/pre>\n<p>The <code>default.pot<\/code> file is similar to:<\/p>\n<pre><code class=\"elixir\">## This file is a PO Template file. `msgid`s here are often extracted from\n## source code; add new translations manually only if they're dynamic\n## translations that can't be statically extracted. Run `mix\n## gettext.extract` to bring this file up to date. Leave `msgstr`s empty as\n## changing them here as no effect; edit them in PO (`.po`) files instead.\n#: web\/templates\/page\/index.html.eex:2\nmsgid \"Welcome to %{name}\"\nmsgstr \"\"\n<\/code><\/pre>\n<p>These files <strong>should not<\/strong> be modified manually because this will cause them to be used as a reference for your next files and languages. (well, kind of, as there is a special case that will be covered in another blog post).<\/p>\n<h3>PO file<\/h3>\n<p><strong>PO<\/strong> means <em>Portable Object<\/em> and the files are based on the <em>POT<\/em> files. These are the files that you will use to add your translations. First, we need to generate them with the task:<\/p>\n<pre><code class=\"shell\">mix gettext.merge priv\/gettext\n<\/code><\/pre>\n<p>Now, we have a new PO file in our structure:<\/p>\n<pre><code>priv\/gettext\n\u2514\u2500 en_US\n| \u2514\u2500 LC_MESSAGES\n| \u2514\u2500 default.po\n| \u2514\u2500 errors.po\n\u2514\u2500 default.pot\n\u2514\u2500 errors.pot\n<\/code><\/pre>\n<p>Let&#8217;s take a look at the new file:<\/p>\n<pre><code class=\"elixir\">## `msgid`s in this file come from POT (.pot) files. Do not add, change, or\n## remove `msgid`s manually here as they're tied to the ones in the\n## corresponding POT file (with the same domain). Use `mix gettext.extract\n## --merge` or `mix gettext.merge` to merge POT files into PO files.\nmsgid \"\"\nmsgstr \"\"\n\"Language: en\\n\"\n\n#: web\/templates\/page\/index.html.eex:2\nmsgid \"Welcome to %{name}\"\nmsgstr \"\"\n<\/code><\/pre>\n<p>Gettext uses English by default. The <code>msgid<\/code> is the text provided in the <code>gettext<\/code> function and <code>msgstr<\/code> is the translated value for it.<\/p>\n<p>Why does my app work when I use <code>Gettext<\/code> without the translation files? By default, the <code>gettext<\/code> function will return the string passed in. With this approach, you can add <code>gettext<\/code> calls whenever you start thinking about localizing.<\/p>\n<h3>Adding new translations in our template<\/h3>\n<p>Every time that we add a new call to <code>gettext<\/code> in the templates, we need to update our POT and PO files.<\/p>\n<pre><code class=\"shell\">mix gettext.extract\nmix gettext.merge priv\/gettext\n<\/code><\/pre>\n<p>After this, the new <code>msgid<\/code> will be available in your PO files. You could also run both tasks with a single one:<\/p>\n<pre><code class=\"shell\">mix gettext.extract --merge\n<\/code><\/pre>\n<h3>Adding new languages for our app<\/h3>\n<p>Now I want to translate the app to <code>pt_BR<\/code>. The next step is running:<\/p>\n<pre><code class=\"shell\">mix gettext.merge priv\/gettext --locale pt_BR\n<\/code><\/pre>\n<p>This task will use the template files to generate the <code>.PO<\/code> files. Let&#8217;s see our structure after we ran the task:<\/p>\n<pre><code>priv\/gettext\n\u2514\u2500 en_US\n| \u2514\u2500 LC_MESSAGES\n| \u2514\u2500 errors.po\n| \u2514\u2500 default.po\n\u2514\u2500 pt_BR\n| \u2514\u2500 LC_MESSAGES\n| \u2514\u2500 errors.po\n| \u2514\u2500 default.po\n\u2514\u2500 default.pot\n\u2514\u2500 errors.pot\n<\/code><\/pre>\n<p>What happens if I change my locale to <code>pt_BR<\/code> and I didn&#8217;t translate the <code>msgid<\/code>? The Gettext will fall back to the default language and your app will not crash.<\/p>\n<h2>You can do more with <code>Gettext<\/code>.<\/h2>\n<h3>Pluralize<\/h3>\n<p>In addition to the simple translation, if you use <code>gettext \"Here is one string to translate\"<\/code>, you can pluralize. Example:<\/p>\n<pre><code class=\"elixir\"># Plural translation\nnumber_of_apples = 4\nngettext \"The apple is ripe\",\n\"The apples are ripe\",\nnumber_of_apples\n<\/code><\/pre>\n<p>Your PO file will be generated like:<\/p>\n<pre><code class=\"elixir\">msgid \"The apple is ripe\"\nmsgid_plural \"The apples are ripe\"\nmsgstr[0] \"\"\nmsgstr[1] \"\"\n<\/code><\/pre>\n<h3>Interpolation<\/h3>\n<p>Interpolation keys can be placed in <code>msgid<\/code>s or <code>msgid_plural<\/code>s by enclosing them in <code>%{<\/code> and <code>}<\/code>, like this: Example: <code>gettext(\"My name is %{name}\", name: @user.name)<\/code>. The PO file will be like:<\/p>\n<pre><code class=\"elixir\">msgid \"My name is %{name}\"\nmsgstr \"\"\n<\/code><\/pre>\n<h3>Domains<\/h3>\n<p>You can create domains to scope assess your translations. All your translations will be stored in the default domain. Ecto uses a custom domain called <code>errors<\/code> for validations. To use a custom domain, use: <code>dgettext \"errors\", \"Here is an error message to translate\"<\/code>. The tasks will be responsible for creating the files for this domain.<\/p>\n<h3>Locale per-process<\/h3>\n<p>One more thing, Gettext stores the locale per-process (in the process dictionary) and per Gettext module. This means that you can use <code>Gettext.put_locale\/2<\/code> in a new process in order to change the locale for that process. You can change the default value in your <code>config\/config.exs<\/code> with <code>config :playfair, Playfair.Gettext, default_locale: \"pt_BR\"<\/code>.<\/p>\n<p>Even after adding <code>gettext<\/code> functions, you probably need to work in some assets, currency, dates, and so on. But, the hard work, scanning all your files to add the translation, has already been done.<\/p>\n<p>You can find more information in the <a href=\"http:\/\/hexdocs.pm\/gettext\/Gettext.html\">Gettext documentation<\/a>. Do you believe that the <code>Gettext<\/code> approach could have helped you?<\/p>\n<p><a href=\"http:\/\/plataformatec.com.br\/elixir-radar?utm_source=our-blog&amp;utm_medium=referral&amp;utm_campaign=elixir-radar&amp;utm_content=elixir-radar-cta-blog-post-bottom\"><br \/>\n<img decoding=\"async\" style=\"border: 0;\" src=\"http:\/\/blog.plataformatec.com.br\/wp-content\/uploads\/2015\/05\/elixir-radar-subscribe.png\" alt=\"Subscribe to Elixir Radar\" \/><br \/>\n<\/a><\/p>\n","protected":false},"excerpt":{"rendered":"<p>To translate or not to translate? We have been asking ourselves the same question in one of our latest Phoenix projects. Even though internationalizing our application is planned a bit ahead in our roadmap, we have decided to do an initial evaluation of the translation tools in the Elixir ecosystem, and we were pleasantly surprised &#8230; <a class=\"read-more-link\" href=\"http:\/\/blog.plataformatec.com.br\/2016\/03\/using-gettext-to-internationalize-a-phoenix-application\/\">\u00bb<\/a><\/p>\n","protected":false},"author":18,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"ngg_post_thumbnail":0,"footnotes":""},"categories":[1],"tags":[143,245],"aioseo_notices":[],"jetpack_sharing_enabled":true,"jetpack_featured_media_url":"","_links":{"self":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/5179"}],"collection":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/users\/18"}],"replies":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/comments?post=5179"}],"version-history":[{"count":17,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/5179\/revisions"}],"predecessor-version":[{"id":5197,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/5179\/revisions\/5197"}],"wp:attachment":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/media?parent=5179"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/categories?post=5179"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/tags?post=5179"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}