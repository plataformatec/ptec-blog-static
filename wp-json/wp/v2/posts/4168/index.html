{"id":4168,"date":"2014-09-10T09:00:05","date_gmt":"2014-09-10T12:00:05","guid":{"rendered":"http:\/\/blog.plataformatec.com.br\/?p=4168"},"modified":"2014-09-10T10:38:42","modified_gmt":"2014-09-10T13:38:42","slug":"floating-point-and-currency","status":"publish","type":"post","link":"http:\/\/blog.plataformatec.com.br\/2014\/09\/floating-point-and-currency\/","title":{"rendered":"Floating Point and currency"},"content":{"rendered":"<blockquote><p>\n  &#8220;Do not use floating point for currency&#8221;\n<\/p><\/blockquote>\n<p>This simple statement is useful for both novice and experienced developers alike. It avoids problems that might otherwise compromise the correctness of the software you&#8217;re building.<\/p>\n<p>But behind every piece of wisdom, every history of success, there is hard work from lots of people. Exploring this background is an enriching experience, the kind of thing that elevates the level of knowledge and makes you more confident about what you are doing.<\/p>\n<p>Do not expect to find here a complete guide to floating point or currency handling. There are enough references on each matter separately out there already. The idea is to provide a brief exploration in a top-down fashion, gradually digging each layer of the stack, from the perspective of someone that do not master floating point.<\/p>\n<p>Let\u2019s start with a simple example in irb (Ruby&#8217;s Interactive Shell), which happens to be a common source of questions:<\/p>\n<pre lang=\"ruby\">\n0.1 + 0.02 == 0.12\n\u2028# => false\n\n(0.1 + 0.02) + 0.3 == 0.1 + (0.02 + 0.3)\n# => false\n<\/pre>\n<p>Wasn&#8217;t it supposed to return <code>true<\/code>? What&#8217;s going on behind the scenes?<\/p>\n<p>Debugging the results from each side of the first expression.<\/p>\n<pre lang=\"ruby\">\n0.1 + 0.02\n\u2028# => 0.12000000000000001\n\n\u2028\u20280.12\n\u2028# => 0.12\n<\/pre>\n<p>It looks like there is something wrong with the operation <code>0.1 + 0.02<\/code>. Lets take a closer look, using a more accurate format.<\/p>\n<pre lang=\"ruby\">\nsprintf(\"%0.50f\", 0.12)\u2028\n# => \"0.11999999999999999555910790149937383830547332763672\"\n\n\u2028\u2028sprintf(\"%0.50f\", 0.10 + 0.02)\u2028\n# => \"0.12000000000000000943689570931383059360086917877197\"\u2028\u2028\n\nsprintf(\"%0.50f\", 0.02)\u2028\n# => \"0.02000000000000000041633363423443370265886187553406\"\u2028\u2028\n\nsprintf(\"%0.50f\", 0.10)\n\u2028# => \"0.10000000000000000555111512312578270211815834045410\"\n<\/pre>\n<p>So the error happens even before the arithmetic operations. It&#8217;s time to dive  deeper into the stack.<\/p>\n<h3>Conversions<\/h3>\n<p>Once the interpreter parses the decimal string <code>0.1<\/code>, for example, it converts that to an internal  representation, which we&#8217;ll review briefly. This is achieved with the help of C <code>strtod<\/code> function, in <a href=\"https:\/\/github.com\/ruby\/ruby\/blob\/trunk\/object.c#L2830\">MRI<\/a>.<\/p>\n<p>Curiously, this conversion step had already lead to <a href=\"https:\/\/www.ruby-lang.org\/en\/news\/2013\/11\/22\/heap-overflow-in-floating-point-parsing-cve-2013-4164\/\">security issues<\/a> before.<\/p>\n<p>Another conversion takes place when printing a float back to the decimal string. These transformations are not as trivial as one might think. There had been many studies in the development of the algorithms used in order to make it accurately and efficiently.<\/p>\n<p>Since all of this happens transparently, some might expect that all languages work this way by default. It does, but not always for free. For example, in the infant days of the Elixir language, a developer had the <a href=\"https:\/\/groups.google.com\/d\/topic\/elixir-lang-core\/RB3Qi6qEERw\/discussion\">following question<\/a> after typing a decimal string into IEx (Elixir&#8217;s Interactive Shell). This had been solved by borrowing functionality already present in Erlang.<\/p>\n<p>A counter intuitive fact is that even if a decimal number is not exactly representable as float, say <code>0.12<\/code>, we are able to convert it back and forth without ever seeing the rounding error due to such carefully designed algorithms.<\/p>\n<p>This automatic rounding behavior hides complexity but may encourage some to operate on floats expecting that the final conversion is going to provide a desired decimal result. But that is not always true due to rounding errors accumulation.<\/p>\n<p>But what&#8217;s this internal representation and why does it impose such limitations?<\/p>\n<h3>Thinking in terms of binaries<\/h3>\n<p>We are not going to dive into the details of the IEEE754 nor explain how to do such conversions. That\u2019s an interesting topic but it has been <a href=\"#floating-references\">covered before<\/a> and would end up being too extensive to fit in this post.<\/p>\n<p>Instead we are going to show some examples that provides a glimpse of the real problem.<\/p>\n<p>For instance, take the decimal number <code>0.625<\/code>. This number represents the sum of fractions <code>6\/10^1 + 2\/10^2 + 5\/10^3<\/code>. The same reasoning can be used to find the binary representation replacing the denominator by powers of two <code>1\/2^1 + 0\/2^2 + 1\/2^3 = 0.5 + 0.125 = 0.625<\/code>, which leads to the binary <code>0.101<\/code> when we place the numerators in a row.<\/p>\n<p>But if we had chosen another number, let&#8217;s say the decimal <code>0.1<\/code>, we would find that it&#8217;s not possible to write it as a finite sum of fractions whose denominator is a power of 2. E.g. it does not have a finite binary representation.<\/p>\n<p>Since the space to store a double precision float is limited to 64 bits, some sort of rounding would be required. And here we have one of the causes of precision loss.<\/p>\n<h3>What type should I use for representing currency?<\/h3>\n<p>The two most frequent answers include Integers or BigDecimals as the way to go. I&#8217;ve personally used both and it worked fine, but it would be too pretentious to say that one or another is the best for your problem.<\/p>\n<p>Most Rails applications use databases. If that&#8217;s your case, it&#8217;s important to understand the limitations offered by the types available and the conversions done by the adapter during information storage and retrieval.<\/p>\n<p>For example, Postgres recommends using its <a href=\"http:\/\/www.postgresql.org\/docs\/current\/interactive\/datatype-numeric.html#DATATYPE-NUMERIC-DECIMAL\">numeric type<\/a> for currency, which Rails maps to BigDecimals. This type also supports the aggregation functions we are used to.<\/p>\n<p>Other databases may require other approaches, like <a href=\"http:\/\/alexanderwong.me\/post\/15705498896\/currency-and-custom-data-types-in-mongoid\">mongodb<\/a> that does not have a type compatible with BigDecimal. But it doesn&#8217;t mean that it&#8217;s impossible to use BigDecimals with mongodb either.<\/p>\n<p>Currency in cents, like $19.90 could be represented as the integer <code>1990<\/code>. It avoids precision problems and works well with most databases too. One inconvenience is formatting numbers as currency, but there are gems to make this task easier and coding your own helper methods is also an alternative.<\/p>\n<p>Some may experience performance issues when using BigDecimals, but I&#8217;ve never faced such issues  personally. One thing to be aware of is that BigDecimals are not as simple as Integers and I like to keep things as simple as possible.<\/p>\n<p>Even floating point may be required under some contexts if numerical methods get involved. The most important thing is to be aware of the limitations and make informed decisions.<\/p>\n<p><em>So have you ever had problems with currency handling? I&#8217;m really willing to hear about how you solve this problem. If you have an experience to share, please, leave a comment below or find me on twitter <a href=\"https:\/\/twitter.com\/rcillo\">@rcillo<\/a>.<\/em><\/p>\n<h3 id=\"floating-references\">References<\/h3>\n<ul>\n<li>\n<p>Ruby Float documentation &#8211; <a href=\"http:\/\/www.ruby-doc.org\/core-2.1.2\/Float.html\">http:\/\/www.ruby-doc.org\/core-2.1.2\/Float.html<\/a><\/p>\n<\/li>\n<li>\n<p>Ruby BigDecimal documentation &#8211; <a href=\"http:\/\/www.ruby-doc.org\/stdlib-2.1.2\/libdoc\/bigdecimal\/rdoc\/BigDecimal.html\">http:\/\/www.ruby-doc.org\/stdlib-2.1.2\/libdoc\/bigdecimal\/rdoc\/BigDecimal.html<\/a><\/p>\n<\/li>\n<li>\n<p>How to perform binary division &#8211; <a href=\"http:\/\/www.exploringbinary.com\/binary-division\/\">http:\/\/www.exploringbinary.com\/binary-division<\/a><\/p>\n<\/li>\n<li>\n<p>Binary do decimal converter &#8211; <a href=\"http:\/\/www.binaryconvert.com\">http:\/\/www.binaryconvert.com<\/a><\/p>\n<\/li>\n<li>\n<p>Good floating point tutorial &#8211; <a href=\"http:\/\/kipirvine.com\/asm\/workbook\/floating_tut.htm\">http:\/\/kipirvine.com\/asm\/workbook\/floating_tut.htm<\/a><\/p>\n<\/li>\n<li>\n<p>Money in Rails &#8211; <a href=\"http:\/\/stackoverflow.com\/questions\/1019939\/ruby-on-rails-best-method-of-handling-currency-money\">http:\/\/stackoverflow.com\/questions\/1019939\/ruby-on-rails-best-method-of-handling-currency-money<\/a><\/p>\n<\/li>\n<li>\n<p>Canonical reference &#8211; <a href=\"http:\/\/docs.oracle.com\/cd\/E19957-01\/806-3568\/ncg_goldberg.html\">http:\/\/docs.oracle.com\/cd\/E19957-01\/806-3568\/ncg_goldberg.html<\/a><\/p>\n<\/li>\n<li>\n<p>Another good reference on floats &#8211; <a href=\"http:\/\/www.toves.org\/books\/float\">http:\/\/www.toves.org\/books\/float<\/a><\/p>\n<\/li>\n<\/ul>\n<p style=\"text-align: center;\">\n<p><span id=\"hs-cta-wrapper-2aeae558-5b72-4df3-bf32-e1119f34d85e\" class=\"hs-cta-wrapper\"><span id=\"hs-cta-2aeae558-5b72-4df3-bf32-e1119f34d85e\" class=\"hs-cta-node hs-cta-2aeae558-5b72-4df3-bf32-e1119f34d85e\"> <a href=\"http:\/\/cta-redirect.hubspot.com\/cta\/redirect\/378213\/2aeae558-5b72-4df3-bf32-e1119f34d85e\"><img decoding=\"async\" id=\"hs-cta-img-2aeae558-5b72-4df3-bf32-e1119f34d85e\" class=\"hs-cta-img aligncenter\" style=\"border-width: 0px;\" src=\"https:\/\/no-cache.hubspot.com\/cta\/default\/378213\/2aeae558-5b72-4df3-bf32-e1119f34d85e.png\" alt=\"\" \/><\/a><\/span><\/span><br \/>\n<!-- end HubSpot Call-to-Action Code --><\/p>\n","protected":false},"excerpt":{"rendered":"<p>&#8220;Do not use floating point for currency&#8221; This simple statement is useful for both novice and experienced developers alike. It avoids problems that might otherwise compromise the correctness of the software you&#8217;re building. But behind every piece of wisdom, every history of success, there is hard work from lots of people. Exploring this background is &#8230; <a class=\"read-more-link\" href=\"http:\/\/blog.plataformatec.com.br\/2014\/09\/floating-point-and-currency\/\">\u00bb<\/a><\/p>\n","protected":false},"author":27,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"ngg_post_thumbnail":0,"footnotes":""},"categories":[1],"tags":[223,222],"aioseo_notices":[],"jetpack_sharing_enabled":true,"jetpack_featured_media_url":"","_links":{"self":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/4168"}],"collection":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/users\/27"}],"replies":[{"embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/comments?post=4168"}],"version-history":[{"count":13,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/4168\/revisions"}],"predecessor-version":[{"id":4193,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/posts\/4168\/revisions\/4193"}],"wp:attachment":[{"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/media?parent=4168"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/categories?post=4168"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/blog.plataformatec.com.br\/wp-json\/wp\/v2\/tags?post=4168"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}