<!DOCTYPE html>
<html dir="ltr" lang="en-US" prefix="og: https://ogp.me/ns#">
<head>
  <meta charset="utf-8">
  <meta name="bitly-verification" content="b3acd9a47f4e">

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="emoji:root" content="/wp-content/themes/ptec">
  <meta name="theme-color" content="#cacaca">
  
    <meta name="bitly-verification" content="b3acd9a47f4e">
  <meta property="og:image" content="/wp-content/themes/ptec/assets/opengraph.png">
  <link rel="icon" sizes="192x192" href="/wp-content/themes/ptec/assets/icons/chrome-192x.png">
  <link rel="pingback" href="/xmlrpc.php">
  
		<!-- All in One SEO 4.5.4 - aioseo.com -->
		<title>How to avoid the dog-pile effect on your Rails app Â« Plataformatec Blog</title>
		<meta name="description" content="Everyone already heard about scalability at least once. Everyone already heard about memcached as well. What not everyone might heard is the dog-pile effect and how to avoid it. But before we start, let&#039;s take a look on how to use Rails with memcached. Rails + Memcached = expires_at &amp;&amp; !exist?(&quot;lock_#{key}&quot;) orig_write(&quot;lock_#{key}&quot;, true, :expires_in =&gt;">
		<meta name="robots" content="noindex, nofollow, max-image-preview:large">
		<link rel="canonical" href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comments">
		<meta name="generator" content="All in One SEO (AIOSEO) 4.5.4">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="Plataformatec Blog | Plataformatec&#039;s place to talk about Ruby, Ruby on Rails, Elixir, and software engineering">
		<meta property="og:type" content="article">
		<meta property="og:title" content="How to avoid the dog-pile effect on your Rails app Â« Plataformatec Blog">
		<meta property="og:description" content="Everyone already heard about scalability at least once. Everyone already heard about memcached as well. What not everyone might heard is the dog-pile effect and how to avoid it. But before we start, let&#039;s take a look on how to use Rails with memcached. Rails + Memcached = expires_at &amp;&amp; !exist?(&quot;lock_#{key}&quot;) orig_write(&quot;lock_#{key}&quot;, true, :expires_in =&gt;">
		<meta property="og:url" content="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comments">
		<meta property="article:published_time" content="2009-09-08T19:22:13+00:00">
		<meta property="article:modified_time" content="2009-09-18T16:26:20+00:00">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="How to avoid the dog-pile effect on your Rails app Â« Plataformatec Blog">
		<meta name="twitter:description" content="Everyone already heard about scalability at least once. Everyone already heard about memcached as well. What not everyone might heard is the dog-pile effect and how to avoid it. But before we start, let&#039;s take a look on how to use Rails with memcached. Rails + Memcached = expires_at &amp;&amp; !exist?(&quot;lock_#{key}&quot;) orig_write(&quot;lock_#{key}&quot;, true, :expires_in =&gt;">
		<meta name="google" content="nositelinkssearchbox">
		<script type="application/ld+json" class="aioseo-schema">{"@context":"https:\/\/schema.org","@graph":[{"@type":"Article","@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#article","name":"How to avoid the dog-pile effect on your Rails app Â« Plataformatec Blog","headline":"How to avoid the dog-pile effect on your Rails app","author":{"@id":"\/author\/hugobarauna\/#author"},"publisher":{"@id":"\/#organization"},"image":{"@type":"ImageObject","url":"\/wp-content\/uploads\/2009\/09\/predio-desmoranando.jpg","@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#articleImage","width":600,"height":400,"caption":"O dog-pile effect pode fazer isso com seu aplicativo!"},"datePublished":"2009-09-08T16:22:13-03:00","dateModified":"2009-09-18T13:26:20-03:00","inLanguage":"en-US","commentCount":23,"mainEntityOfPage":{"@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#webpage"},"isPartOf":{"@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#webpage"},"articleSection":"English, cache, memcached, rails, scalability"},{"@type":"BreadcrumbList","@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#breadcrumblist","itemListElement":[{"@type":"ListItem","@id":"\/#listItem","position":1,"name":"Home","item":"\/","nextItem":"\/2009\/#listItem"},{"@type":"ListItem","@id":"\/2009\/#listItem","position":2,"name":"2009","item":"\/2009\/","nextItem":"\/2009\/09\/#listItem","previousItem":"\/#listItem"},{"@type":"ListItem","@id":"\/2009\/09\/#listItem","position":3,"name":"September","item":"\/2009\/09\/","nextItem":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#listItem","previousItem":"\/2009\/#listItem"},{"@type":"ListItem","@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#listItem","position":4,"name":"How to avoid the dog-pile effect on your Rails app","previousItem":"\/2009\/09\/#listItem"}]},{"@type":"Organization","@id":"\/#organization","name":"Plataformatec Blog","url":"\/"},{"@type":"Person","@id":"\/author\/hugobarauna\/#author","url":"\/author\/hugobarauna\/","name":"Hugo BaraÃºna","image":{"@type":"ImageObject","@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#authorImage","url":"https:\/\/secure.gravatar.com\/avatar\/dcde2c5777be84f81545480b353f1a71?s=96&d=mm&r=pg","width":96,"height":96,"caption":"Hugo BaraÃºna"}},{"@type":"WebPage","@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#webpage","url":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/","name":"How to avoid the dog-pile effect on your Rails app Â« Plataformatec Blog","description":"Everyone already heard about scalability at least once. Everyone already heard about memcached as well. What not everyone might heard is the dog-pile effect and how to avoid it. But before we start, let's take a look on how to use Rails with memcached. Rails + Memcached = expires_at && !exist?(\"lock_#{key}\") orig_write(\"lock_#{key}\", true, :expires_in =>","inLanguage":"en-US","isPartOf":{"@id":"\/#website"},"breadcrumb":{"@id":"\/2009\/09\/how-to-avoid-dog-pile-effect-rails-app\/#breadcrumblist"},"author":{"@id":"\/author\/hugobarauna\/#author"},"creator":{"@id":"\/author\/hugobarauna\/#author"},"datePublished":"2009-09-08T16:22:13-03:00","dateModified":"2009-09-18T13:26:20-03:00"},{"@type":"WebSite","@id":"\/#website","url":"\/","name":"Plataformatec Blog","description":"Plataformatec's place to talk about Ruby, Ruby on Rails, Elixir, and software engineering","inLanguage":"en-US","publisher":{"@id":"\/#organization"}}]}</script>
		<!-- All in One SEO -->


		<!-- Meta Tag Manager -->
		<meta name="twitter:label1" content="Plataformatec">
		<meta name="twitter:data1" content="Professional Consulting and Development for companies using Elixir or Ruby">
		<!-- / Meta Tag Manager -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; Comments Feed" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Plataformatec Blog &raquo; How to avoid the dog-pile effect on your Rails app Comments Feed" href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/feed/">
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.4.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"ðŸ³ï¸â€âš§ï¸","ðŸ³ï¸â€‹âš§ï¸")?!1:!n(e,"ðŸ‡ºðŸ‡³","ðŸ‡ºâ€‹ðŸ‡³")&&!n(e,"ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿","ðŸ´â€‹ó §â€‹ó ¢â€‹ó ¥â€‹ó ®â€‹ó §â€‹ó ¿");case"emoji":return!n(e,"ðŸ«±ðŸ»â€ðŸ«²ðŸ¿","ðŸ«±ðŸ»â€‹ðŸ«²ðŸ¿")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.4.2" type="text/css" media="all">
<style id="wp-block-library-inline-css" type="text/css">.has-text-align-justify{text-align:justify;}</style>
<link rel="stylesheet" id="mediaelement-css" href="/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.17" type="text/css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=6.4.2" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="webfont-css" href="//fonts.googleapis.com/css?family=Bree+Serif&#038;ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="main-css" href="/wp-content/themes/ptec/style.css?ver=6.4.2" type="text/css" media="all">
<link rel="stylesheet" id="tablepress-default-css" href="/wp-content/plugins/tablepress/css/build/default.css?ver=2.2.4" type="text/css" media="all">
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/246">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.4.2">
<link rel="shortlink" href="/?p=246">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2009%2F09%2Fhow-to-avoid-dog-pile-effect-rails-app%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2009%2F09%2Fhow-to-avoid-dog-pile-effect-rails-app%2F#038;format=xml">
</head>
  <body class="post-template-default single single-post postid-246 single-format-standard">
    <div class="site-header">
      <div class="site-header-background">
        <header class="site-header-container">
          <h1 class="site-header-logo">
            <a href="/">
              <img src="/wp-content/themes/ptec/assets/plataformatec.svg" height="70" alt="The plataformatec logo">
            </a>
          </h1>

          <form class="header-search-form" method="GET" action="/">
            <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
          </form>

          <ul class="site-nav">
            <li class="site-nav-item"><a href="http://plataformatec.com.br/services">Services</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/playbook">Playbook</a></li>
            <li class="site-nav-item handheld-hidden"><a href="http://plataformatec.com.br/forge">Forge</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/careers">Careers</a></li>
            <li class="site-nav-item"><a href="http://plataformatec.com.br/contact">Contact</a></li>
          </ul>
        </header>
      </div>
      <nav class="header-nav">
        <input type="checkbox" id="nav-toggle-checkbox" class="header-nav-checkbox">
        <label for="nav-toggle-checkbox" class="header-nav-toggle">Topics we write about</label>

        <ul class="header-nav-list" itemscope itemtype="http://schema.org/SiteNavigationElement">
          <li class="header-nav-item header-search-nav-item">
            <form class="header-nav-search-form" method="GET" action="/">
              <input type="search" name="s" placeholder="Search our blog..." class="header-search-input">
            </form>
          </li>
                    <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/elixir" itemprop="url">Elixir</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/rails" itemprop="url">Ruby on Rails</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/devise" itemprop="url">Devise</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/simple_form" itemprop="url">Simple Form</a>
          </li>
          <li class="header-nav-item" itemprop="name">
            <a class="header-nav-link" href="/tag/agile" itemprop="url">Agile</a>
          </li>
        </ul>
      </nav>
    </div>
<div class="site-container">
  <div class="page-container">
                  <section class="post-section">
  <header class="post-header">
    <h1 class="post-title">
      <a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/" rel="bookmark">How to avoid the dog-pile effect on your Rails app</a>
    </h1>
          <time class="post-date-ribbon" datetime="2009-09-08T16:22:13-03:00">Sep 8, 2009</time>
      <p class="post-author">
        <img alt="" src="https://secure.gravatar.com/avatar/dcde2c5777be84f81545480b353f1a71?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/dcde2c5777be84f81545480b353f1a71?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" decoding="async">        Written by <a href="/?author=5" title="Posts by Hugo BaraÃºna">Hugo BaraÃºna</a>.
      </p>
        </header>

      <article class="post-body">
      <p>Everyone already heard about scalability at least once. Everyone already heard about <a href="http://www.danga.com/memcached/" target="_blank">memcached</a> as well. What not everyone might heard is the dog-pile effect and how to avoid it. But before we start, let&#8217;s take a look on how to use Rails with memcached.</p>
<h3>Rails + Memcached = 
</h3>
<p>First, if you never used memcached with rails or never read/heard a lot about scalability, I recommend checking out <a href="http://railslab.newrelic.com/scaling-rails" target="_blank">Scaling Rails</a> episodes done by <a href="http://blog.envylabs.com/" target="_blank">Gregg Pollack</a>, in special the <a href="http://railslab.newrelic.com/2009/02/19/episode-8-memcached" target="_blank">episode</a> about memcached.</p>
<p>Assuming that you have your memcached installed and want to use it on your application, you just need to add the following to your configuration files (for example production.rb):</p>
<pre lang="ruby" line="1">
config.cache_store = :mem_cache_store
</pre>
<p>By default, Rails will search for a memcached process running on localhost:11211.</p>
<p>But wait, why would I want to use memcached? Well, imagine that your application has a page where a slow query is executed against the database to generate a ranking of blog posts based on the author&#8217;s influence and this query takes on average 5 seconds. In this case, everytime an user access this page, the query will be executed and your application will end up having a very high response time.</p>
<p>Since you don&#8217;t want the user to wait 5 seconds everytime he wants to see the ranking, what do you do? You store the query results inside memcached. Once your query result is cached, your app users do not have to wait for those damn 5 seconds anymore!</p>
<h3>What is the dog-pile effect?</h3>
<p>Nice, we start to cache our query results, our application is responsive and we can finally sleep at night, right?</p>
<p>That depends. Let&#8217;s suppose we are expiring the cache based on a time interval, for example 5 minutes. Let&#8217;s see how it will work in two scenarios:</p>
<p><b>1 user accessing the page after the cache was expired:</b></p>
<p>In this first case, when the user access the page after the cache was expired, the query will be executed again. After 5 seconds the user will be able to see the ranking, your server worked a little and your application is still working.</p>
<p><b>N users accessing the page after the cache was expired:</b></p>
<p>Imagine that in a certain hour, this page on your application receives 4 requests per second on average. In this case, between the first request and the query results being returned, 5 seconds will pass and something around 20 requests will hit your server. The problem is, all those 20 requests will miss the cache and your application will try to execute the query in all of them, consuming a lot of CPU and memory resources. This is the dog-pile effect.</p>
<p>Depending on how many requests hit your server and the amount of resources needed to process the query, the dog-pile effect can bring your application down. Holy cow!</p>
<p>Luckily, there are a few solutions to handle this effect. Let&#8217;s take a look at one of them.</p>
<div id="attachment_193" style="width: 310px" class="wp-caption aligncenter">
<img fetchpriority="high" decoding="async" aria-describedby="caption-attachment-193" src="/wp-content/uploads/2009/09/predio-desmoranando.jpg" alt="Dog pile effect working on your application!" title="Dog pile effect working on your application!" width="300" height="200" class="size-full wp-image-193"><p id="caption-attachment-193" class="wp-caption-text">Dog pile effect working on your application!</p>
</div>
<h3>How to avoid the dog-pile effect?</h3>
<p>The dog-pile effect is triggered because we allowed more than one request to execute the expensive query. So, what if we isolate this operation to just the first request and let the next requests use the old cache until the new one is available? Looks like a good idea, so let&#8217;s code it!</p>
<p>Since Rails 2.1, we have an API to access the cache, which is defined by an abstract class called <a href="http://api.rubyonrails.org/classes/ActiveSupport/Cache/Store.html" target="_blank">ActiveSupport::Cache::Store</a>. You can read more about it in <a href="http://thewebfellas.com/blog/2008/6/9/rails-2-1-now-with-better-integrated-caching" target="_blank">this post</a> or in this excellent <a href="http://railscasts.com/episodes/115-caching-in-rails-2-1" target="_blank">railscast episode</a>.</p>
<p>The code below simply implements a new and smarter memcached store on top of the already existing <a href="http://api.rubyonrails.org/classes/ActiveSupport/Cache/MemCacheStore.html" target="_blank">MemCacheStore</a>:</p>
<pre lang="ruby" line="1">
module ActiveSupport
  module Cache
    class SmartMemCacheStore  expires_at && !exist?("lock_#{key}")
          orig_write("lock_#{key}", true, :expires_in => lock_expires_in)
          return nil
        else
          data
        end
      end

      def write(key, value, options = nil)
        expires_delta = options.delete[:expires_delta] if !options.nil?
        expires_delta ||= 300

        expires_at = Time.now + expires_delta
        package = [value, expires_at]
        orig_write(key, package, options)
        delete("lock_#{key}")
      end
    end
  end
end
</pre>
<p>The code above is mainly doing:</p>
<ol style="line-height:20px">
<li>Suppose that your query is already cached;</li>
<li>In the first five minutes, all requests will hit the cache;</li>
<li>In the next minutes, the first request will notice that the cache is stale (line 17) and will create a lock so only it will calculate the new cache;</li>
<li>In the next 5 seconds, the new query is calculated and all requests, instead of missing the cache, will access the old cache and return it to the client (lines 17 and 21)k;</li>
<li>When the query result is returned, it will overwrite the old cache with the new value and remove the lock (lines 31 and 32);</li>
<li>From now on, all new requests in the next five minutes will access the fresh cache and return it (lines 17 and 21).</li>
</ol>
<h3>Fallbacks and a few things to keep in mind</h3>
<p>First, is not recommend to set the :expires_in value in your cache:</p>
<pre lang="ruby" line="1">
Rails.cache.write('my_key', 'my_value', :expires_in => 300)
</pre>
<p>With the solution proposed above, you just need to set :expires_delta. This is due to the fact that our application will now be responsible to expire the cache and not memcached.</p>
<pre lang="ruby" line="1">
Rails.cache.write('my_key', 'my_value', :expires_delta => 300)
</pre>
<p>However, there are a few cases where memcached can eventually expire the cache. When you initialize memcached, it allocates by default 64MB in memory. If eventually those 64MB are filled, what will memcached do when you try to save a new object? It uses the <a href="http://en.wikipedia.org/wiki/Cache_algorithms#Least_Recently_Used" target="_blank">LRU algorithm</a> and deletes the less accessed object in memory.</p>
<p>In such cases, where memcached removes a cache on its own, the dog pile effect can appear again. Suppose that the ranking is not accessed for quite some time and the cached ranking is discarded due to LRU. If suddenly a lot of people access the page in the five initial seconds where the query is being calculated, requests will accumulate and once again the dog-pile effect can bring your application down.</p>
<p>It&#8217;s important to have this scenario in mind when you are sizing your memcached, mainly on how many memory will be allocated.</p>
<h3>Now I can handle the dog-pile effect and sleep again!</h3>
<p>Summarizing, when your are using a cache strategy, you will probably need to expire your cache. In this process, the dog-pile effect can appear and haunt you down. Now you have one (more) tool to solve it.</p>
<p>You just need to add the SmartMemCacheStore code above to your application (for example in lib/), set your production.rb (or any appropriated environment) to use the :smart_mem_cache_store. If you use Rails default API to access the cache (Rails.cache.read, Rails.cache.write) and designed well your memcached structure, you will be protected from the dog-pile effect.</p>
<div id="attachment_184" style="width: 410px" class="wp-caption aligncenter">
<img decoding="async" aria-describedby="caption-attachment-184" src="/wp-content/uploads/2009/09/dogpileweek2.jpg" alt="A real dog-pile! =p" title="A real dog-pile! =p" width="400" height="300" class="size-full wp-image-184"><p id="caption-attachment-184" class="wp-caption-text">A real dog-pile! =p</p>
</div>
    </article>
  
      <p class="post-metadata">
      Tags: <a href="/tag/cache/" rel="tag">cache</a>, <a href="/tag/memcached/" rel="tag">memcached</a>, <a href="/tag/rails/" rel="tag">rails</a>, <a href="/tag/scalability/" rel="tag">scalability</a>, Posted in <a href="/category/english/" rel="category tag">English</a>,   <a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/#comments"><span class="dsq-postid" data-dsqidentifier="246 http://blog.plataformatec.com.br/?p=246">23 Comments &#187;</span></a>    </p>
  </section>

        <div class="comments-thread">
          
<!-- You can start editing here. -->

	<h3 id="comments">
		23 responses to &#8220;How to avoid the dog-pile effect on your Rails app&#8221;	</h3>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

	<ol class="commentlist">
			<li class="comment even thread-even depth-1" id="comment-816">
				<div id="div-comment-816" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7c92608db4acf7a44337670eff6ce5bc?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/7c92608db4acf7a44337670eff6ce5bc?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Dan Kubb</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-816">September 8, 2009 at 8:46 pm</a>		</div>

		<p>Hugo, great article.  One question though.  How would you deal with the situation where there was no previously cached response, which can happen if it is the very first request, or the cache was swept clear?  Would it make sense to block the other requests until the cache is ready, or do you have another approach?</p>
<p>The dogpile effect is pretty common in high traffic sites, should the cache built into Rails handle it automatically?</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-817">
				<div id="div-comment-817" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/bc73c5c10b8095b83b312e9b77b2fa92?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/bc73c5c10b8095b83b312e9b77b2fa92?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://www.edicy.com/" class="url" rel="ugc external nofollow">Priit</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-817">September 8, 2009 at 8:46 pm</a>		</div>

		<p>It is interesting how playing with memcached keys can put simple key-value based data store on steroids. For example, we managed to simulate &#8220;namespaced&#8221; cache with memcached: <a href="http://www.edicy.com/developer/blog/namespaced-cache-expiring-with-memcached" rel="nofollow ugc">http://www.edicy.com/developer/blog/namespaced-cache-expiring-with-memcached</a></p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-194">
				<div id="div-comment-194" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7c92608db4acf7a44337670eff6ce5bc?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/7c92608db4acf7a44337670eff6ce5bc?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Dan Kubb</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-194">September 8, 2009 at 5:46 pm</a>		</div>

		<p>Hugo, great article.  One question though.  How would you deal with the situation where there was no previously cached response, which can happen if it is the very first request, or the cache was swept clear?  Would it make sense to block the other requests until the cache is ready, or do you have another approach?</p>
<p>The dogpile effect is pretty common in high traffic sites, should the cache built into Rails handle it automatically?</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-195">
				<div id="div-comment-195" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/bc73c5c10b8095b83b312e9b77b2fa92?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/bc73c5c10b8095b83b312e9b77b2fa92?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://www.edicy.com/" class="url" rel="ugc external nofollow">Priit</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-195">September 8, 2009 at 5:46 pm</a>		</div>

		<p>It is interesting how playing with memcached keys can put simple key-value based data store on steroids. For example, we managed to simulate &#8220;namespaced&#8221; cache with memcached: <a href="http://www.edicy.com/developer/blog/namespaced-cache-expiring-with-memcached" rel="nofollow ugc">http://www.edicy.com/developer/blog/namespaced-cache-expiring-with-memcached</a></p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="pingback even thread-even depth-1" id="comment-196">
				<div id="div-comment-196" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href="http://bstonwebdev.wordpress.com/2009/09/08/httpblog-plataformatec-com-br200909/" class="url" rel="ugc external nofollow">http://blog.plataformatec.com.br/2009/09&#8230; &laquo; bst On Web Dev</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-196">September 8, 2009 at 8:39 pm</a>		</div>

		<p>[&#8230;]  11:39 pm on September 8, 2009  Reply   Tags: performance (3), rails (23)    <a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/" rel="ugc">http://blog.plataformatec.com.br/2009/09/how-to-avoid-dog-pile-effect-rails-app/</a> &#8211; How to avoid the dog-pile effect on your Rails app   [&#8230;]</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-818">
				<div id="div-comment-818" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/4f431d4bd75f5120d8362c3f2bccca67?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/4f431d4bd75f5120d8362c3f2bccca67?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://www.forumwarz.com/" class="url" rel="ugc external nofollow">Robin Ward</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-818">September 9, 2009 at 2:26 am</a>		</div>

		<p>While your solution will improve things, it is flawed.</p>
<p>It is possible that more than one request will get a positive on line 16. They will go through to the next line and will both set the lock.</p>
<p>One way around this is to use the ADD command of memcached, as is detailed here: </p>
<p><a href="http://code.google.com/p/memcached/wiki/FAQ#Emulating_locking_with_the_add_command" rel="nofollow ugc">http://code.google.com/p/memcached/wiki/FAQ#Emulating_locking_with_the_add_command</a></p>
<p>Only one process can successfully add the lock, so with another check that will make your code much more successful under a heavy load.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-197">
				<div id="div-comment-197" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/4f431d4bd75f5120d8362c3f2bccca67?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/4f431d4bd75f5120d8362c3f2bccca67?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://www.forumwarz.com/" class="url" rel="ugc external nofollow">Robin Ward</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-197">September 8, 2009 at 11:26 pm</a>		</div>

		<p>While your solution will improve things, it is flawed.</p>
<p>It is possible that more than one request will get a positive on line 16. They will go through to the next line and will both set the lock.</p>
<p>One way around this is to use the ADD command of memcached, as is detailed here: </p>
<p><a href="http://code.google.com/p/memcached/wiki/FAQ#Emulating_locking_with_the_add_command" rel="nofollow ugc">http://code.google.com/p/memcached/wiki/FAQ#Emulating_locking_with_the_add_command</a></p>
<p>Only one process can successfully add the lock, so with another check that will make your code much more successful under a heavy load.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="pingback odd alt thread-odd thread-alt depth-1" id="comment-202">
				<div id="div-comment-202" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href="http://afreshcup.com/2009/09/09/double-shot-536/" class="url" rel="ugc external nofollow">Double Shot #536 &laquo; A Fresh Cup</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-202">September 9, 2009 at 7:59 am</a>		</div>

		<p>[&#8230;] How to avoid the dog-pile effect on your Rails app &#8211; How to make your cache use a bit smarter on heavily-trafficked apps. [&#8230;]</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="pingback even thread-even depth-1" id="comment-204">
				<div id="div-comment-204" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href="http://blog.toppingdesign.com/2009/09/09/avoding-the-dog-pile-effect/" class="url" rel="ugc external nofollow">Avoding the &#8220;Dog pile&#8221; effect at Topper&#8217;s Blog</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-204">September 9, 2009 at 10:24 am</a>		</div>

		<p>[&#8230;] How to avoid the dog-pile effect on your Rails app | Plataforma Blog Imagine that in a certain hour, this page on your application receives 4 requests per second on average. In this case, between the first request and the query results being returned, 5 seconds will pass and something around 20 requests will hit your server. The problem is, all those 20 requests will miss the cache and your application will try to execute the query in all of them, consuming a lot of CPU and memory resources. This is the dog-pile effect. [&#8230;]</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-819">
				<div id="div-comment-819" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/18deb990b168e39dd36674ced7d44250?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/18deb990b168e39dd36674ced7d44250?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Hugo BaraÃºna</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-819">September 9, 2009 at 1:50 pm</a>		</div>

		<p>@Dan We could have some solutions. One of them is the one you said. You could make the other requests sleep for some time and after that, let them try to access the cache again.</p>
<p>Another one, you can pre-warm the cache yourself instead of wait for a user request for it. </p>
<p>It depends on your app requirments.</p>
<p>I&#8217;m not sure about putting that solution inside the cache built into Rails, mainly because there are different solutions, that depends on the situation. For example, is common to have another process generating the cache or use a namespaced memcached. All of them have positive and negative aspects. =)</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment byuser comment-author-hugobarauna bypostauthor even thread-even depth-1" id="comment-205">
				<div id="div-comment-205" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/dcde2c5777be84f81545480b353f1a71?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/dcde2c5777be84f81545480b353f1a71?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Hugo BaraÃºna</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-205">September 9, 2009 at 10:50 am</a>		</div>

		<p>@Dan We could have some solutions. One of them is the one you said. You could make the other requests sleep for some time and after that, let them try to access the cache again.</p>
<p>Another one, you can pre-warm the cache yourself instead of wait for a user request for it. </p>
<p>It depends on your app requirments.</p>
<p>I&#8217;m not sure about putting that solution inside the cache built into Rails, mainly because there are different solutions, that depends on the situation. For example, is common to have another process generating the cache or use a namespaced memcached. All of them have positive and negative aspects. =)</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-820">
				<div id="div-comment-820" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/18deb990b168e39dd36674ced7d44250?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/18deb990b168e39dd36674ced7d44250?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Hugo BaraÃºna</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-820">September 9, 2009 at 1:51 pm</a>		</div>

		<p>@Priit, I also find very interesting what we can do with just a simple key-value based data store. Actually, we are using that namespace solution too.</p>
<p>Maybe you already know, but you can find more about that inside the memcached&#8217;s FAQ, here: <a href="http://code.google.com/p/memcached/wiki/FAQ#How_to_prevent_clobbering_updates,_stampeding_requests" rel="nofollow ugc">http://code.google.com/p/memcached/wiki/FAQ#How_to_prevent_clobbering_updates,_stampeding_requests</a></p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment byuser comment-author-hugobarauna bypostauthor even thread-even depth-1" id="comment-206">
				<div id="div-comment-206" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/dcde2c5777be84f81545480b353f1a71?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/dcde2c5777be84f81545480b353f1a71?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Hugo BaraÃºna</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-206">September 9, 2009 at 10:51 am</a>		</div>

		<p>@Priit, I also find very interesting what we can do with just a simple key-value based data store. Actually, we are using that namespace solution too.</p>
<p>Maybe you already know, but you can find more about that inside the memcached&#8217;s FAQ, here: <a href="http://code.google.com/p/memcached/wiki/FAQ#How_to_prevent_clobbering_updates,_stampeding_requests" rel="nofollow ugc">http://code.google.com/p/memcached/wiki/FAQ#How_to_prevent_clobbering_updates,_stampeding_requests</a></p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-821">
				<div id="div-comment-821" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/09c5a2bb583beda8e347ee7a07cdf568?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/09c5a2bb583beda8e347ee7a07cdf568?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">pete</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-821">September 9, 2009 at 8:33 pm</a>		</div>

		<p>&#8220;You just need to add the SmartMemCacheStore code above to your application (for example in lib/)&#8221;</p>
<p>i use to place this kind of code in config/initializers.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-211">
				<div id="div-comment-211" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/09c5a2bb583beda8e347ee7a07cdf568?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/09c5a2bb583beda8e347ee7a07cdf568?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">pete</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-211">September 9, 2009 at 5:33 pm</a>		</div>

		<p>&#8220;You just need to add the SmartMemCacheStore code above to your application (for example in lib/)&#8221;</p>
<p>i use to place this kind of code in config/initializers.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-822">
				<div id="div-comment-822" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/bd9feb094ef75a4f8fa6e741e51956d5?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/bd9feb094ef75a4f8fa6e741e51956d5?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Walter</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-822">September 11, 2009 at 12:37 am</a>		</div>

		<p>Is there some reason you don&#8217;t just use super.read and super.write instead of aliasing them?</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-218">
				<div id="div-comment-218" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/bd9feb094ef75a4f8fa6e741e51956d5?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/bd9feb094ef75a4f8fa6e741e51956d5?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">Walter</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-218">September 10, 2009 at 9:37 pm</a>		</div>

		<p>Is there some reason you don&#8217;t just use super.read and super.write instead of aliasing them?</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-823">
				<div id="div-comment-823" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">JosÃ© Valim</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-823">September 11, 2009 at 9:39 am</a>		</div>

		<p>@pete we usually lay code on lib/. initializers we use for configuration and for code that should be loaded while rails is loaded (aka monkey patches).</p>
<p>@walter we cannot use super because we need to access the orig_write inside read.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment byuser comment-author-josevalim even thread-even depth-1" id="comment-224">
				<div id="div-comment-224" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">JosÃ© Valim</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-224">September 11, 2009 at 6:39 am</a>		</div>

		<p>@pete we usually lay code on lib/. initializers we use for configuration and for code that should be loaded while rails is loaded (aka monkey patches).</p>
<p>@walter we cannot use super because we need to access the orig_write inside read.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-824">
				<div id="div-comment-824" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/5d058d82cf6798fda3906d9b018c821c?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/5d058d82cf6798fda3906d9b018c821c?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://tjhanley.com/" class="url" rel="ugc external nofollow">Thomas Hanley</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-824">October 13, 2009 at 5:53 pm</a>		</div>

		<p>I get issues trying to start up the application with this in my lib.</p>
<p>/Workspace/lc_dev/lib/smart_mem_cache_store.rb to define SmartMemCacheStore</p>
<p>In my development.rb:<br>
config.cache_store = :smart_mem_cache_store</p>
<p>In environments.rb:<br>
cache = ActiveSupport::Cache::MemCacheStore.new(fragment_memcache_servers,shared_memcache_options.merge(:namespace =&gt; &#8220;fragment&#8221;))<br>
 self.action_controller.cache_store = cache, {}</p>
<p>I tried putting ActiveSupport::Cache::SmartMemCacheStore and I get the same error.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-286">
				<div id="div-comment-286" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/5d058d82cf6798fda3906d9b018c821c?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/5d058d82cf6798fda3906d9b018c821c?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn"><a href="http://tjhanley.com/" class="url" rel="ugc external nofollow">Thomas Hanley</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-286">October 13, 2009 at 2:53 pm</a>		</div>

		<p>I get issues trying to start up the application with this in my lib.</p>
<p>/Workspace/lc_dev/lib/smart_mem_cache_store.rb to define SmartMemCacheStore</p>
<p>In my development.rb:<br>
config.cache_store = :smart_mem_cache_store</p>
<p>In environments.rb:<br>
cache = ActiveSupport::Cache::MemCacheStore.new(fragment_memcache_servers,shared_memcache_options.merge(:namespace =&gt; &#8220;fragment&#8221;))<br>
 self.action_controller.cache_store = cache, {}</p>
<p>I tried putting ActiveSupport::Cache::SmartMemCacheStore and I get the same error.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-825">
				<div id="div-comment-825" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">JosÃ© Valim</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-825">October 14, 2009 at 12:49 pm</a>		</div>

		<p>@Thomas, for Rails&#8217; auto load to work, you have to use all the namespaces in your class, so you have to put it under: app/lib/active_support/cache/smart_mem_cache_store.rb.</p>
<p>If you want to have it hanging at app/lib/smart_mem_cache_store.rb, you can require the file manually, instead of relying on Rails autoload.</p>

		
				</div>
				</li>
<!-- #comment-## -->
		<li class="comment byuser comment-author-josevalim even thread-even depth-1" id="comment-287">
				<div id="div-comment-287" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=32&#038;d=mm&#038;r=pg" srcset="https://secure.gravatar.com/avatar/e837f6b7fd146ab16ed3d663476c063e?s=64&#038;d=mm&#038;r=pg 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" decoding="async">			<cite class="fn">JosÃ© Valim</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata">
			<a href="/2009/09/how-to-avoid-dog-pile-effect-rails-app/comment-page-1/#comment-287">October 14, 2009 at 9:49 am</a>		</div>

		<p>@Thomas, for Rails&#8217; auto load to work, you have to use all the namespaces in your class, so you have to put it under: app/lib/active_support/cache/smart_mem_cache_store.rb.</p>
<p>If you want to have it hanging at app/lib/smart_mem_cache_store.rb, you can require the file manually, instead of relying on Rails autoload.</p>

		
				</div>
				</li>
<!-- #comment-## -->
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

        </div>

        <div class="pagination-section">
          <a href="/2009/09/rails-for-kids-2009/" rel="prev">Rails for Kids 2009</a>          <a href="/2009/09/exportando-dados-para-excel-usando-csv-em-um-aplicativo-rails/" rel="next">Exportando dados para Excel usando CSV em um aplicativo Rails</a>        </div>
        </div>
  <aside class="sidebar-container">
  <div class="sidebar-box sidebar-box-divider">
    <ul class="social-links">
      <li><a href="/feed/" class="social-link rss-link" title="Subscribe to our RSS" target="_blank">Subscribe to our RSS</a></li>
      <li><a href="http://twitter.com/plataformatec" class="social-link twitter-link" title="Follow us on Twitter" target="_blank">@plataformatec</a></li>
      <li><a href="https://github.com/plataformatec" class="social-link github-link" title="Check our code at GitHub" target="_blank">Plataformatec @ GitHub</a></li>
      <li><a href="http://facebook.com/plataformatec.com.br" class="social-link facebook-link" title="Check our Facebook page" target="_blank">Plataformatec @ Facebook</a></li>
      <li><a href="http://www.linkedin.com/company/plataformatec" class="social-link linkedin-link" title="Check our LinkedIn page" target="_blank">Plataformatec @ LinkedIn</a></li>
    </ul>
  </div>

  <div class="sidebar-box sidebar-box-divider">
    This is the company blog of <strong>Plataformatec</strong>, a software development and
    consultancy company, specialized in Elixir, Ruby and Agile.
  </div>

  <div class="sidebar-box">
    <ul class="post-list">
      <li class="post-list-item">
<a href="/category/english">Posts in english</a> (107)</li>
      <li class="post-list-item">
<a href="/category/portugues">Posts em portuguÃªs</a> (33)</li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Recent Posts</h3>

    <ul class="post-list">
                    <li class="post-list-item">
          <a href="/2020/01/important-information-about-our-elixir-and-ruby-open-source-projects/">Important information about our Elixir and Ruby Open Source projects</a>
        </li>
              <li class="post-list-item">
          <a href="/2020/01/elixir-what-about-tests/">Elixir: What about tests?</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/12/okr-licoes-aprendidas-para-voce-comecar-a-aplica-lo-de-forma-efetiva/">OKR: liÃ§Ãµes aprendidas para vocÃª comeÃ§ar a aplicÃ¡-lo de forma efetiva</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/divida-tecnica-por-que-fazer-quando-fazer-e-como-priorizar/">DÃ­vida tÃ©cnica: Por que fazer, quando fazer e como priorizar</a>
        </li>
              <li class="post-list-item">
          <a href="/2019/11/relation-between-story-points-and-development-time-lead-time/">Relation between Story Points and Development Time (Lead Time)</a>
        </li>
          </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Read more about</h3>

    <ul class="post-list">
      <li class="post-list-item"><a href="/tag/open-source">Open Source</a></li>
      <li class="post-list-item"><a href="/tag/front-end">Front end</a></li>
      <li class="post-list-item"><a href="/tag/conference">Conferences</a></li>
      <li class="post-list-item"><a href="/tag/security-fix">Security fixes</a></li>
    </ul>
  </div>

  <div class="sidebar-box">
    <h3 class="sidebar-title">Check our product</h3>
    <a class="sidebar-cta-link" href="https://sourcelevel.io/">
      <img src="/wp-content/themes/ptec/assets/sourcelevel-300.png" width="300" alt="SourceLevel - Analytics for Engineering Ops">
	</a>

    <p align="center">Analytics for Engineering Ops.</p>
  </div>

</aside>
      <footer class="site-footer">
        <p>
          <span class="footer-copy">Â© 2009- 2024 Plataformatec. All rights reserved.</span>

          <a href="http://plataformatec.com.br/">Our site</a> Â·
          <a href="http://plataformatec.com.br/contact">Contact us</a> Â·
          <a href="http://twitter.com/plataformatec">@plataformatec</a>
        </p>
      </footer>
    </div>
    <script type="text/javascript" src="/wp-content/themes/ptec/application.js?ver=6.4.2" id="application-js"></script>
  </body>
</html>